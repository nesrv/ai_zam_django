{% load static %}
{% load object_filters %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ object.nazvanie }} - AI-ZAM</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            padding: 12px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        .page-title {
            text-align: center;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin: 12px;
        }
        
        .page-title h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .page-title p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 12px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .header h1 {
            font-size: 20px;
            margin-bottom: 3px;
        }
        
        .header p {
            opacity: 0.8;
            font-size: 13px;
            margin-bottom: 8px;
        }
        
        .header-info {
            margin-top: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .info-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 12px;
        }
        
        .info-item strong {
            color: #ecf0f1;
        }
        
        .table-container {
            padding: 0;
            overflow-x: auto;
            overflow-y: visible;
            max-width: 100vw;
            -webkit-overflow-scrolling: touch;
        }
        
        .resource-table {
            width: auto;
            min-width: 2000px;
            border-collapse: collapse;
            margin-bottom: 12px;
            white-space: nowrap;
            table-layout: fixed;
        }
        
        .resource-table th {
            background: #34495e;
            color: white;
            padding: 8px 6px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #2c3e50;
            position: sticky;
            top: 0;
            font-size: 12px;
        }
        
        .resource-table td {
            padding: 6px;
            border: 1px solid #ddd;
            background: white;
            font-size: 12px;
        }
        
        .resource-table .number {
            text-align: right;
        }
        
        .main-header td {
            background: #1a2530 !important;
            color: white !important;
            font-weight: bold;
            text-align: center;
            padding: 8px 6px;
            font-size: 1.7em;
        }
        
        .category-header td {
            background: #3498db !important;
            color: white !important;
            font-weight: bold;
            text-align: left;
            padding: 6px;
            font-size: 13px;
        }
        
        .category-кадры td { background: #e8f4fd; }
        .category-машины td { background: #fff3cd; }
        .category-материалы td { background: #d4edda; }
        .category-административно td { background: #f8d7da; }
        .category-сиз td { background: #e2e3e5; }
        .category-подрядные td { background: #d1ecf1; }
        
        .total-row td {
            background: #2c3e50 !important;
            color: white !important;
            font-weight: bold;
            font-size: 12px;
        }
        
        .back-btn {
            position: fixed;
            top: 12px;
            left: 12px;
            z-index: 1000;
            display: inline-block;
            padding: 6px 12px;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 3px;
            transition: background 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 12px;
        }
        
        .back-btn:hover {
            background: #2980b9;
        }
        
        .edit-btn {
            position: fixed;
            top: 12px;
            right: 12px;
            z-index: 1000;
            display: inline-block;
            padding: 6px 12px;
            background: #e74c3c;
            color: white;
            text-decoration: none;
            border-radius: 3px;
            transition: background 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 12px;
        }
        
        .edit-btn:hover {
            background: #c0392b;
        }
        
        .bold {
            font-weight: bold;
        }
        
        .editable-cell {
            cursor: pointer;
            background-color: #f8f9fa;
        }
        
        .editable-cell:hover {
            background-color: #e9ecef;
        }
        
        .editing {
            background-color: #fff3cd !important;
        }
        
        .main-action-btns {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 20px 0 20px 0;
        }
        .main-btn {
            display: inline-block;
            padding: 12px 32px;
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 6px;
            border: none;
            background: #3498db;
            color: #fff;
            text-decoration: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
            transition: background 0.2s, box-shadow 0.2s;
        }
        .main-btn:hover {
            background: #217dbb;
            color: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        
        .main-btn.active {
            background: #27ae60;
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
        }
        
        .main-btn.active:hover {
            background: #229954;
        }
    </style>
</head>
<body> 
    
    <div class="container">
        <div class="header">
            <h1>{{ object.nazvanie }} (смета ресурсов по объекту) </h1>
          
            <div class="header-info">
                <div class="info-item">
                    <strong>Ответственный:</strong> 
                    {% if object.otvetstvennyj %}
                        {{ object.otvetstvennyj.fio }}
                    {% else %}
                        Не назначен
                    {% endif %}
                </div>
                <div class="info-item">
                    <strong>Дата начала:</strong> {{ object.data_nachala|date:"d.m.Y" }}
                </div>
                <div class="info-item">
                    <strong>Общая стоимость ресурсов:</strong> {{ total_cost|floatformat:0 }} ₽
                </div>
            </div>
            <!-- Две кнопки после header-info -->
            <div class="main-action-btns">
                <a href="/objects/{{ object.id }}/" class="main-btn active">Расходная часть</a>
                <a href="/objects/{{ object.id }}/income/" class="main-btn">Доходная часть</a>
            </div>
            

        </div>
        
        <div class="table-container">
            <table class="resource-table">
                <thead>
                    <tr>
                        <th style="width: 5%;">Наименование</th>
                        <th style="width: 2%;">Ед.<br>изм</th>
                        <th style="width: 3%;">Зарез.<br>лимитов</th>
                        <th style="width: 3%;">Заплан.<br>цена</th>
                        <th style="width: 3%;">Сумма</th>
                        <th style="width: 2%;">Потрач.<br>лимитов</th>
                        <th style="width: 2%;">Остал.<br>лимитов</th>
                        {% for day in days %}
                        <th style="width: 3%;">{{ day|date:"d.m" }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    <tr class="main-header">
                        <td colspan="7">Планируемые расходы</td>
                        <td colspan="{{ days|length }}">Фактические расходы</td>
                    </tr>
                    
                    {% for category_name, category_resources in grouped_resources.items %}
                    {% if category_name|lower != 'подрядные организации' %}
                    <tr class="category-header">
                        <td colspan="{{ 7|add:days|length }}">
                            {{ category_name|upper }}
                            {% for category in categories %}
                                {% if category.nazvanie == category_name %}
                                    <button onclick="addResourceToCategory({{ category.id }})" 
                                            style="float: right; background: #27ae60; color: white; border: none; border-radius: 3px; padding: 4px 8px; cursor: pointer; font-size: 12px; margin-left: 10px;">+</button>
                                {% endif %}
                            {% endfor %}
                        </td>
                    </tr>
                    
                    {% for resource in category_resources %}
                    <tr class="category-{{ category.grouper|lower }}">
                        <td>
                            {{ resource.resurs.naimenovanie }}
                            <button onclick="deleteResource({{ resource.id }})" 
                                    style="float: right; background: #e74c3c; color: white; border: none; border-radius: 50%; padding: 2px 6px; cursor: pointer; font-size: 12px; width: 20px; height: 20px; display: inline-flex; align-items: center; justify-content: center; margin-left: 10px;" 
                                    title="Удалить ресурс">−</button>
                        </td>
                        <td>{{ resource.resurs.edinica_izmereniya }}</td>
                        <td class="number editable-cell" 
                            data-resource-id="{{ resource.id }}" 
                            data-field-type="kolichestvo"
                            onclick="editResourceCell(this)">{{ resource.kolichestvo|floatformat:0 }}</td>
                        <td class="number editable-cell" 
                            data-resource-id="{{ resource.id }}" 
                            data-field-type="cena"
                            onclick="editResourceCell(this)">{{ resource.cena|floatformat:0 }}</td>
                        <td class="number sum-cell" 
                            data-resource-id="{{ resource.id }}">{{ resource.kolichestvo|multiply:resource.cena|floatformat:0 }}</td>
                        
                        <td class="number">{{ resource.potracheno|floatformat:0 }}</td>
                        <td class="number ostatok-cell" 
                            data-resource-id="{{ resource.id }}">{{ resource.kolichestvo|subtract:resource.potracheno|floatformat:0 }}</td>
                        
                        {% for day in days %}
                            <td class="number editable-cell" 
                                data-resource-id="{{ resource.id }}" 
                                data-date="{{ day|date:'Y-m-d' }}" 
                                onclick="editCell(this)">
                            {% with day_value=0 %}
                                {% for fr in fakticheskij_resursy %}
                                    {% if fr.resurs_po_objektu.id == resource.id %}
                                        {% for rashod in raskhody|get_item:fr.id %}
                                            {% if rashod.data|date:"Y-m-d" == day|date:"Y-m-d" %}
                                                {{ rashod.izraskhodovano|floatformat:0 }}
                                                {% with day_value=1 %}{% endwith %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                {% endfor %}
                                <!-- {% if day_value == 0 %}0{% endif %} -->
                            {% endwith %}
                            </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                    
                    <tr class="total-row">
                        <td colspan="4">ИТОГО:</td>
                        <td class="number category-total">{{ category_name|get_category_sum:resources|floatformat:0 }}</td>
                        <td class="number category-potracheno">0</td>
                        <td></td>
                        {% for day in days %}
                        <td class="number category-daily-total">
                        {% with category_totals=category_daily_totals|get_item:category_name %}
                            {% with day_key=day|date:'Y-m-d' %}
                                {{ category_totals|get_item:day_key|floatformat:0 }}
                            {% endwith %}
                        {% endwith %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endif %}
                    {% endfor %}
                    
                    <tr class="total-row">
                        <td colspan="7">Итого фактических расходов по дням:</td>
                        {% for day in days %}
                        <td class="number total-daily-total">
                        {% with day_key=day|date:'Y-m-d' %}
                            {{ total_daily_expenses|get_item:day_key|floatformat:0 }}
                        {% endwith %}
                        </td>
                        {% endfor %}
                    </tr>
                </tbody>
            </table>
        </div>
        
    </div>
    
    <a href="/objects/" class="back-btn">← Назад к списку объектов</a>
    <a href="/objects/{{ object.id }}/edit/" class="edit-btn">✎ Редактировать</a>
    
    <script>
    function formatNumber(num) {
        if (num === null || num === undefined || isNaN(num)) {
            return '0';
        }
        // Используем надежный способ форматирования
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    }
    
    function updateTotalDailyExpenses() {
        console.log('updateTotalDailyExpenses called');
        // Получаем все итоговые строки категорий
        const categoryTotalRows = document.querySelectorAll('.total-row');
        const daysCount = document.querySelectorAll('th[style*="width: 3%"]').length;
        console.log('Days count:', daysCount);
        
        // Инициализируем массив для итоговых расходов по дням
        const totalDailyExpenses = new Array(daysCount).fill(0);
        
        // Проходим по всем итоговым строкам категорий (кроме последней)
        for (let i = 0; i < categoryTotalRows.length - 1; i++) {
            const row = categoryTotalRows[i];
            const dailyCells = row.querySelectorAll('.category-daily-total');
            
            // Суммируем дневные расходы по категориям
            dailyCells.forEach((cell, dayIndex) => {
                const cellValue = parseFloat(cell.textContent.trim().replace(/\s/g, '')) || 0;
                totalDailyExpenses[dayIndex] += cellValue;
                console.log(`Day ${dayIndex + 1}: added ${cellValue}, total now: ${totalDailyExpenses[dayIndex]}`);
            });
        }
        
        // Обновляем последнюю итоговую строку
        const lastTotalRow = categoryTotalRows[categoryTotalRows.length - 1];
        if (lastTotalRow) {
            const totalDailyCells = lastTotalRow.querySelectorAll('.total-daily-total');
            totalDailyCells.forEach((cell, dayIndex) => {
                const formattedValue = formatNumber(Math.round(totalDailyExpenses[dayIndex]));
                console.log(`Setting day ${dayIndex + 1} total to:`, formattedValue);
                cell.textContent = formattedValue;
            });
        }
        console.log('updateTotalDailyExpenses completed');
    }
    
    function editCell(cell) {
        if (cell.classList.contains('editing')) return;
        
        try {
            let currentValue = cell.textContent.trim().replace(/\s/g, '');
            console.log('Current value:', currentValue);
            
            // Если ячейка пустая или содержит только пробелы, устанавливаем 0
            if (!currentValue || currentValue === '') {
                currentValue = '0';
            }
            
            const input = document.createElement('input');
            input.type = 'number';
            input.value = currentValue;
            input.style.width = '100px';
            input.style.height = '25px';
            input.style.border = '2px solid #007bff';
            input.style.background = 'white';
            input.style.textAlign = 'right';
            input.style.fontSize = '12px';
            input.style.padding = '4px';
            input.style.borderRadius = '4px';
            
            cell.innerHTML = '';
            cell.appendChild(input);
            cell.classList.add('editing');
            input.focus();
            input.select();
            
            function saveValue() {
                try {
                    const newValue = input.value || '0';
                    console.log('New value:', newValue);
                    
                    cell.textContent = formatNumber(parseFloat(newValue));
                    cell.classList.remove('editing');
                    
                    // Обновляем итоговые данные в реальном времени
                    updateAllTotals();
                    
                    // Отправляем данные на сервер
                    const resourceId = cell.dataset.resourceId;
                    const date = cell.dataset.date;
                    
                    console.log('Sending data:', { resource_id: resourceId, date: date, amount: newValue });
                    
                    fetch('/update-expense/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({
                            resource_id: resourceId,
                            date: date,
                            amount: parseFloat(newValue) || 0
                        })
                    })
                    .then(response => {
                        console.log('Response status:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('Response data:', data);
                        if (data.success) {
                            // Обновляем ячейки Потрачено и Осталось
                            const row = cell.closest('tr');
                            console.log('Found row:', row);
                            
                            const cells = row.querySelectorAll('td');
                            console.log('Cells count:', cells.length);
                            console.log('Cells[5] (Потрачено):', cells[5]);
                            console.log('Cells[6] (Осталось):', cells[6]);
                            
                            if (cells[5]) {
                                const potrachenoFormatted = formatNumber(Math.round(data.potracheno));
                                console.log('Setting Потрачено to:', potrachenoFormatted);
                                cells[5].textContent = potrachenoFormatted;
                            }
                            
                            if (cells[6]) {
                                const ostatokFormatted = formatNumber(Math.round(data.ostatok));
                                console.log('Setting Осталось to:', ostatokFormatted);
                                cells[6].textContent = ostatokFormatted;
                            }
                            
                            console.log('Updating totals...');
                            // Обновляем итоговые суммы
                            updateAllTotals();
                            console.log('Totals updated successfully');
                        } else {
                            console.error('Server returned error:', data.error);
                            let errorMessage = 'Ошибка при сохранении';
                            if (data.error && data.error.includes('database is locked')) {
                                errorMessage = 'База данных временно заблокирована. Попробуйте еще раз через несколько секунд.';
                            } else if (data.error) {
                                errorMessage += ': ' + data.error;
                            }
                            alert(errorMessage);
                        }
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                        let errorMessage = 'Ошибка при отправке данных';
                        if (error.message.includes('Failed to fetch')) {
                            errorMessage = 'Ошибка соединения с сервером. Проверьте подключение к интернету.';
                        } else {
                            errorMessage += ': ' + error.message;
                        }
                        alert(errorMessage);
                    });
                } catch (error) {
                    console.error('Save value error:', error);
                    alert('Ошибка при сохранении: ' + error.message);
                }
            }
            
            input.addEventListener('blur', saveValue);
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveValue();
                }
            });
            
            // Добавляем обновление в реальном времени при вводе
            input.addEventListener('input', function() {
                const newValue = input.value || '0';
                const row = cell.closest('tr');
                const cells = row.querySelectorAll('td');
                
                // Обновляем только ячейку Осталось в реальном времени
                // Ячейка Потрачено будет обновлена сервером
                const kolichestvo = parseFloat(cells[2].textContent.trim().replace(/\s/g, '')) || 0;
                const currentPotracheno = parseFloat(cells[5].textContent.trim().replace(/\s/g, '')) || 0;
                const ostatok = kolichestvo - currentPotracheno;
                
                if (cells[6]) {
                    cells[6].textContent = formatNumber(Math.round(ostatok));
                }
                
                // Обновляем итоговые данные в реальном времени
                updateAllTotals();
            });
        } catch (error) {
            console.error('Edit cell error:', error);
            alert('Ошибка при редактировании ячейки: ' + error.message);
        }
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function editResourceCell(cell) {
        if (cell.classList.contains('editing')) return;
        
        const currentValue = cell.textContent.trim().replace(/\s/g, '');
        const input = document.createElement('input');
        input.type = 'number';
        input.value = currentValue;
        input.style.width = '100px';
        input.style.height = '25px';
        input.style.border = '2px solid #28a745';
        input.style.background = 'white';
        input.style.textAlign = 'right';
        input.style.fontSize = '12px';
        input.style.padding = '4px';
        input.style.borderRadius = '4px';
        
        cell.innerHTML = '';
        cell.appendChild(input);
        cell.classList.add('editing');
        input.focus();
        input.select();
        
        function saveResourceValue() {
            const newValue = input.value || '0';
            cell.textContent = formatNumber(parseFloat(newValue));
            cell.classList.remove('editing');
            
            // Получаем текущие значения из строки
            const row = cell.closest('tr');
            const cells = row.querySelectorAll('td');
            
            // Получаем значения количества и цены
            let kolichestvo = parseFloat(cells[2].textContent.trim().replace(/\s/g, '')) || 0;
            let cena = parseFloat(cells[3].textContent.trim().replace(/\s/g, '')) || 0;
            
            // Если редактируем количество или цену, обновляем соответствующее значение
            const fieldType = cell.dataset.fieldType;
            if (fieldType === 'kolichestvo') {
                kolichestvo = parseFloat(newValue) || 0;
            } else if (fieldType === 'cena') {
                cena = parseFloat(newValue) || 0;
            }
            
            // Пересчитываем сумму в реальном времени
            const newSum = parseFloat(kolichestvo) * parseFloat(cena);
            
            // Обновляем ячейку суммы по идентификатору
            const sumCell = row.querySelector('.sum-cell');
            if (sumCell) {
                sumCell.textContent = formatNumber(Math.round(newSum));
            }
            
            // Пересчитываем остаток
            const potracheno = parseFloat(cells[5].textContent.trim().replace(/\s/g, '')) || 0;
            const ostatok = parseFloat(kolichestvo) - parseFloat(potracheno);
            
            // Обновляем ячейку остатка по идентификатору
            const ostatokCell = row.querySelector('.ostatok-cell');
            if (ostatokCell) {
                ostatokCell.textContent = formatNumber(Math.round(ostatok));
            }
            
            // Обновляем итоговые данные в реальном времени
            updateAllTotals();
            
            // Отправляем данные на сервер
            const resourceId = cell.dataset.resourceId;
            
            fetch('/update-resource-data/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    resource_id: resourceId,
                    field_type: fieldType,
                    value: parseFloat(newValue) || 0
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Обновляем итоговые суммы
                    updateAllTotals();
                } else {
                    console.error('Server returned error:', data.error);
                    let errorMessage = 'Ошибка при сохранении';
                    if (data.error && data.error.includes('database is locked')) {
                        errorMessage = 'База данных временно заблокирована. Попробуйте еще раз через несколько секунд.';
                    } else if (data.error) {
                        errorMessage += ': ' + data.error;
                    }
                    alert(errorMessage);
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                let errorMessage = 'Ошибка при отправке данных';
                if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Ошибка соединения с сервером. Проверьте подключение к интернету.';
                } else {
                    errorMessage += ': ' + error.message;
                }
                alert(errorMessage);
            });
        }
        
        input.addEventListener('blur', saveResourceValue);
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                saveResourceValue();
            }
        });
        
        // Добавляем обновление в реальном времени при вводе
        input.addEventListener('input', function() {
            const newValue = input.value || '0';
            const row = cell.closest('tr');
            const cells = row.querySelectorAll('td');
            
            // Получаем значения количества и цены
            let kolichestvo = parseFloat(cells[2].textContent.trim().replace(/\s/g, '')) || 0;
            let cena = parseFloat(cells[3].textContent.trim().replace(/\s/g, '')) || 0;
            
            // Если редактируем количество или цену, обновляем соответствующее значение
            const fieldType = cell.dataset.fieldType;
            if (fieldType === 'kolichestvo') {
                kolichestvo = parseFloat(newValue) || 0;
            } else if (fieldType === 'cena') {
                cena = parseFloat(newValue) || 0;
            }
            
            // Пересчитываем сумму в реальном времени
            const newSum = parseFloat(kolichestvo) * parseFloat(cena);
            
            // Обновляем ячейку суммы по идентификатору
            const sumCell = row.querySelector('.sum-cell');
            if (sumCell) {
                sumCell.textContent = formatNumber(Math.round(newSum));
            }
            
            // Пересчитываем остаток
            const potracheno = parseFloat(cells[5].textContent.trim().replace(/\s/g, '')) || 0;
            const ostatok = parseFloat(kolichestvo) - parseFloat(potracheno);
            
            // Обновляем ячейку остатка по идентификатору
            const ostatokCell = row.querySelector('.ostatok-cell');
            if (ostatokCell) {
                ostatokCell.textContent = formatNumber(Math.round(ostatok));
            }
            
            // Обновляем итоговые данные в реальном времени
            updateAllTotals();
        });
    }
    
    function updateHeaderTotal() {
        // Пересчитываем общую стоимость ресурсов в заголовке
        let totalCost = 0;
        const sumCells = document.querySelectorAll('.sum-cell');
        
        sumCells.forEach(cell => {
            totalCost += parseFloat(cell.textContent.trim().replace(/\s/g, '')) || 0;
        });
        
        // Находим элемент с общей стоимостью в заголовке
        const headerInfo = document.querySelector('.header-info');
        if (headerInfo) {
            const totalCostElement = headerInfo.querySelector('.info-item:last-child');
            if (totalCostElement) {
                const strongElement = totalCostElement.querySelector('strong');
                if (strongElement) {
                    totalCostElement.innerHTML = `<strong>Общая стоимость ресурсов:</strong> ${formatNumber(Math.round(totalCost))} ₽`;
                }
            }
        }
    }
    
    function updateCategoryTotals() {
        console.log('updateCategoryTotals called');
        
        // Находим все итоговые строки категорий
        const categoryTotalRows = document.querySelectorAll('.total-row');
        console.log('Found total rows:', categoryTotalRows.length);
        
        // Проходим по каждой итоговой строке категории (кроме последней общей)
        for (let i = 0; i < categoryTotalRows.length - 1; i++) {
            const totalRow = categoryTotalRows[i];
            console.log(`Processing total row ${i + 1}`);
            
            // Находим предыдущую строку заголовка категории
            let categoryHeader = totalRow.previousElementSibling;
            while (categoryHeader && !categoryHeader.classList.contains('category-header')) {
                categoryHeader = categoryHeader.previousElementSibling;
            }
            
            if (!categoryHeader) {
                console.log('Category header not found for total row', i + 1);
                continue;
            }
            
            console.log('Found category header:', categoryHeader);
            
            // Получаем название категории
            const categoryName = categoryHeader.querySelector('td')?.textContent || 'Unknown';
            console.log('Category name:', categoryName);
            
            // Находим все строки ресурсов этой категории
            let categorySum = 0;
            let currentRow = categoryHeader.nextElementSibling;
            const categoryDailyTotals = new Array(20).fill(0); // 20 дней
            let resourceCount = 0;
            
            // Проходим по всем строкам ресурсов в этой категории
            while (currentRow && !currentRow.classList.contains('total-row') && !currentRow.classList.contains('category-header')) {
                // Проверяем, что это строка ресурса (имеет класс, начинающийся с 'category-')
                const classList = Array.from(currentRow.classList);
                const isResourceRow = classList.some(cls => cls.startsWith('category-'));
                
                console.log('Checking row with classes:', classList, 'isResourceRow:', isResourceRow);
                
                if (isResourceRow) {
                    resourceCount++;
                    console.log(`Processing resource ${resourceCount} in category ${categoryName}, classes:`, classList);
                    
                    // Суммируем общую стоимость ресурса
                    const sumCell = currentRow.querySelector('.sum-cell');
                    if (sumCell) {
                        const cellValue = parseFloat(sumCell.textContent.trim().replace(/\s/g, '')) || 0;
                        categorySum += cellValue;
                        console.log('Added to category sum:', cellValue, 'from cell text:', sumCell.textContent);
                    } else {
                        console.log('Sum cell not found for resource');
                    }
                    
                    // Суммируем дневные расходы
                    const cells = currentRow.querySelectorAll('td');
                    const cena = parseFloat(cells[3].textContent.trim().replace(/\s/g, '')) || 0;
                    
                    for (let j = 7; j < cells.length; j++) {
                        const dayIndex = j - 7;
                        const dayValue = parseFloat(cells[j].textContent.trim().replace(/\s/g, '')) || 0;
                        categoryDailyTotals[dayIndex] += cena * dayValue;
                    }
                }
                currentRow = currentRow.nextElementSibling;
            }
            
            console.log(`Category ${categoryName}: found ${resourceCount} resources, total sum: ${categorySum}`);
            
            // Обновляем общую сумму категории
            const totalCell = totalRow.querySelector('.category-total');
            if (totalCell) {
                const formattedSum = formatNumber(Math.round(categorySum));
                console.log(`Setting category total to:`, formattedSum);
                totalCell.textContent = formattedSum;
            }
            
            // Рассчитываем итог для столбца "Потрач.лимитов" по формуле: Σ Потрач.лимитов * Заплан.цена
            let categoryPotracheno = 0;
            currentRow = categoryHeader.nextElementSibling;
            
            while (currentRow && !currentRow.classList.contains('total-row') && !currentRow.classList.contains('category-header')) {
                const classList = Array.from(currentRow.classList);
                const isResourceRow = classList.some(cls => cls.startsWith('category-'));
                
                if (isResourceRow) {
                    const cells = currentRow.querySelectorAll('td');
                    const potracheno = parseFloat(cells[5].textContent.trim().replace(/\s/g, '')) || 0; // Потрач.лимитов
                    const cena = parseFloat(cells[3].textContent.trim().replace(/\s/g, '')) || 0; // Заплан.цена
                    categoryPotracheno += potracheno * cena;
                }
                currentRow = currentRow.nextElementSibling;
            }
            
            // Обновляем ячейку итога для "Потрач.лимитов"
            const potrachenoCell = totalRow.querySelector('.category-potracheno');
            if (potrachenoCell) {
                potrachenoCell.textContent = formatNumber(Math.round(categoryPotracheno));
            }
            
            // Обновляем дневные итоги категории
            const dailyTotalCells = totalRow.querySelectorAll('.category-daily-total');
            dailyTotalCells.forEach((cell, dayIndex) => {
                if (categoryDailyTotals[dayIndex] !== undefined) {
                    const formattedValue = formatNumber(Math.round(categoryDailyTotals[dayIndex]));
                    console.log(`Setting day ${dayIndex + 1} category total to:`, formattedValue);
                    cell.textContent = formattedValue;
                }
            });
        }
        
        console.log('updateCategoryTotals completed');
    }
    
    function updateTotalSum() {
        console.log('updateTotalSum called');
        // Пересчитываем общую сумму по объекту
        let totalSum = 0;
        const sumCells = document.querySelectorAll('.sum-cell');
        console.log('Found sum cells:', sumCells.length);
        
        sumCells.forEach(cell => {
            const cellValue = parseFloat(cell.textContent.trim().replace(/\s/g, '')) || 0;
            totalSum += cellValue;
            console.log('Added to total sum:', cellValue);
        });
        
        console.log('Total sum:', totalSum);
        
        // Обновляем общую сумму в последней строке
        const totalRows = document.querySelectorAll('.total-row');
        console.log('Found total rows:', totalRows.length);
        const lastTotalRow = totalRows[totalRows.length - 1];
        if (lastTotalRow) {
            // НЕ обновляем заголовок последней строки, оставляем оригинальный текст
            // const headerCell = lastTotalRow.querySelector('td:first-child');
            // if (headerCell) {
            //     headerCell.textContent = `ИТОГО: ${formatNumber(Math.round(totalSum))} ₽`;
            // }
        }
        console.log('updateTotalSum completed');
    }
    
    function updateAllTotals() {
        console.log('updateAllTotals called');
        // Обновляем все итоговые данные
        updateCategoryTotals();
        updateTotalSum();
        updateTotalDailyExpenses();
        updateHeaderTotal();
        console.log('updateAllTotals completed');
    }
    
    // Форматируем все числовые значения при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        const numberCells = document.querySelectorAll('.number');
        
        numberCells.forEach((cell, index) => {
            const text = cell.textContent.trim();
            
            // Форматируем все числовые значения
            if (text && !isNaN(parseFloat(text))) {
                const num = parseFloat(text);
                const formatted = formatNumber(num);
                cell.textContent = formatted;
            }
        });
        
        // Обновляем все итоговые данные при загрузке страницы
        updateAllTotals();
    });
    
    // Функции для модальных окон
    function showAddCategoryModal() {
        const modal = document.getElementById('categoryModal');
        modal.style.display = 'block';
    }
    
    function showAddResourceModal() {
        const modal = document.getElementById('resourceModal');
        modal.style.display = 'block';
    }
    
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }
    
    function addExistingCategory() {
        const categoryId = document.getElementById('existingCategory').value;
        if (!categoryId) return;
        
        fetch('/add-category-to-object/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                category_id: categoryId,
                object_id: {{ object.id }}
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    }
    
    function addNewCategory() {
        const name = document.getElementById('categoryName').value;
        if (!name) return;
        
        fetch('/add-category/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                name: name
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Добавляем созданную категорию к объекту
                return fetch('/add-category-to-object/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        category_id: data.id,
                        object_id: {{ object.id }}
                    })
                });
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    }
    
    function addResource() {
        const name = document.getElementById('resourceName').value;
        const unit = document.getElementById('resourceUnit').value;
        const categoryId = document.getElementById('resourceCategory').value;
        
        if (!name || !categoryId) return;
        
        fetch('/add-resource/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                name: name,
                unit: unit,
                category_id: categoryId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    }
    
    function addResourceToCategory(categoryId) {
        const modal = document.getElementById('resourceModal');
        const resourceSelect = document.getElementById('resourceSelect');
        
        // Очищаем список ресурсов
        resourceSelect.innerHTML = '<option value="">Выберите ресурс</option>';
        
        // Загружаем ресурсы для этой категории
        fetch(`/get-resources-by-category/${categoryId}/`)
            .then(response => response.json())
            .then(data => {
                data.resources.forEach(resource => {
                    const option = document.createElement('option');
                    option.value = resource.id;
                    option.textContent = `${resource.naimenovanie} (${resource.edinica_izmereniya})`;
                    resourceSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading resources:', error);
                alert('Ошибка загрузки ресурсов');
            });
        
        modal.style.display = 'block';
    }
    
    function addResourceToObject() {
        const resourceId = document.getElementById('resourceSelect').value;
        const quantity = document.getElementById('resourceQuantity').value;
        const price = document.getElementById('resourcePrice').value;
        
        if (!resourceId || !quantity || !price) {
            alert('Заполните все поля');
            return;
        }
        
        fetch('/add-resource-to-object/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                object_id: {{ object.id }},
                resource_id: resourceId,
                quantity: parseFloat(quantity),
                price: parseFloat(price)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
            }
        })
        .catch(error => {
            alert('Ошибка соединения: ' + error.message);
        });
    }
    
    function deleteResource(resourceId) {
        if (confirm('Вы уверены, что хотите удалить этот ресурс?')) {
            fetch('/delete-resource-from-object/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    resource_id: resourceId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
                }
            })
            .catch(error => {
                alert('Ошибка соединения: ' + error.message);
            });
        }
    }
    </script>
<!-- Модальное окно для добавления категории -->
<div id="categoryModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div style="background-color: #2c3e50; margin: 10% auto; padding: 20px; border-radius: 8px; width: 500px; color: white;">
        <h3>Категории ресурсов</h3>
        
        <div style="margin-bottom: 20px;">
            <h4>Выбрать существующую категорию:</h4>
            <select id="existingCategory" style="width: 100%; padding: 8px; margin: 5px 0; border: none; border-radius: 4px;">
                <option value="">Выберите категорию</option>
                {% for category in categories %}
                <option value="{{ category.id }}">{{ category.nazvanie }}</option>
                {% endfor %}
            </select>
            <button onclick="addExistingCategory()" style="background: #3498db; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-top: 5px;">Добавить к объекту</button>
        </div>
        
        <hr style="border-color: #34495e; margin: 20px 0;">
        
        <div>
            <h4>Создать новую категорию:</h4>
            <input type="text" id="categoryName" placeholder="Название новой категории" style="width: 100%; padding: 8px; margin: 5px 0; border: none; border-radius: 4px;">
            <button onclick="addNewCategory()" style="background: #27ae60; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-top: 5px;">Создать и добавить</button>
        </div>
        
        <div style="text-align: right; margin-top: 20px;">
            <button onclick="closeModal('categoryModal')" style="background: #e74c3c; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">Закрыть</button>
        </div>
    </div>
</div>

<!-- Модальное окно для добавления ресурса -->
<div id="resourceModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div style="background-color: #2c3e50; margin: 10% auto; padding: 20px; border-radius: 8px; width: 500px; color: white;">
        <h3>Добавить ресурс к объекту</h3>
        <select id="resourceSelect" style="width: 100%; padding: 8px; margin: 10px 0; border: none; border-radius: 4px;">
            <option value="">Выберите ресурс</option>
        </select>
        <input type="number" id="resourceQuantity" placeholder="Количество" style="width: 100%; padding: 8px; margin: 10px 0; border: none; border-radius: 4px;">
        <input type="number" id="resourcePrice" placeholder="Цена за единицу" style="width: 100%; padding: 8px; margin: 10px 0; border: none; border-radius: 4px;">
        <div style="text-align: right; margin-top: 15px;">
            <button onclick="closeModal('resourceModal')" style="background: #e74c3c; color: white; padding: 8px 16px; border: none; border-radius: 4px; margin-right: 10px; cursor: pointer;">Отмена</button>
            <button onclick="addResourceToObject()" style="background: #27ae60; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">Добавить</button>
        </div>
    </div>
</div>

    <!-- Встроенный скрипт для обработки клика на ячейках "Кадровое обеспечение" -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Находим все строки с категорией "Кадровое обеспечение"
        const rows = document.querySelectorAll('tr');
        
        // Ищем строку с заголовком категории "КАДРОВОЕ ОБЕСПЕЧЕНИЕ"
        for (let i = 0; i < rows.length; i++) {
            const headerCell = rows[i].querySelector('td');
            if (headerCell && headerCell.textContent && headerCell.textContent.trim().toUpperCase().includes('КАДРОВОЕ ОБЕСПЕЧЕНИЕ')) {
                console.log('Найдена категория "Кадровое обеспечение"');
                
                // Находим все строки ресурсов этой категории
                let currentRow = rows[i].nextElementSibling;
                
                while (currentRow && 
                       !currentRow.classList.contains('category-header') && 
                       !currentRow.classList.contains('total-row')) {
                    
                    // Получаем ячейки с датами (начиная с 8-й ячейки)
                    const cells = currentRow.querySelectorAll('td');
                    if (cells.length < 7) {
                        currentRow = currentRow.nextElementSibling;
                        continue;
                    }
                    
                    const position = cells[0].textContent.trim();
                    
                    // Добавляем кнопку в каждую ячейку с датой
                    for (let j = 7; j < cells.length; j++) {
                        const cell = cells[j];
                        
                        // Добавляем кнопку
                        const btn = document.createElement('button');
                        btn.textContent = '👥';
                        btn.style.marginLeft = '5px';
                        btn.style.background = 'none';
                        btn.style.border = 'none';
                        btn.style.cursor = 'pointer';
                        btn.style.color = '#3498db';
                        btn.title = 'Показать сотрудников';
                        
                        cell.appendChild(btn);
                        
                        // Добавляем обработчик клика
                        btn.addEventListener('click', function(event) {
                            event.stopPropagation();
                            
                            // Получаем ID объекта из URL
                            const objectId = window.location.pathname.split('/')[2];
                            
                            // Создаем модальное окно с реальными данными
                            showRealEmployeesModal(objectId, position);
                        });
                    }
                    
                    currentRow = currentRow.nextElementSibling;
                }
                
                break;
            }
        }
    });

    // Функция для отображения модального окна с реальными данными
    function showRealEmployeesModal(objectId, position) {
        // Создаем модальное окно
        const modal = document.createElement('div');
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
        modal.style.zIndex = '1000';
        modal.style.display = 'flex';
        modal.style.justifyContent = 'center';
        modal.style.alignItems = 'center';
        
        // Создаем содержимое модального окна
        const content = document.createElement('div');
        content.style.backgroundColor = '#2c3e50';
        content.style.padding = '20px';
        content.style.borderRadius = '5px';
        content.style.width = '500px';
        content.style.color = 'white';
        
        // Заголовок
        const header = document.createElement('h3');
        header.textContent = 'Сотрудники: ' + position;
        header.style.marginTop = '0';
        content.appendChild(header);
        
        // Загрузка данных
        const loading = document.createElement('p');
        loading.textContent = 'Загрузка данных...';
        content.appendChild(loading);
        
        // Кнопка закрытия
        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'Закрыть';
        closeBtn.style.backgroundColor = '#e74c3c';
        closeBtn.style.color = 'white';
        closeBtn.style.border = 'none';
        closeBtn.style.padding = '8px 16px';
        closeBtn.style.borderRadius = '4px';
        closeBtn.style.cursor = 'pointer';
        closeBtn.style.marginTop = '20px';
        closeBtn.style.float = 'right';
        
        closeBtn.addEventListener('click', function() {
            document.body.removeChild(modal);
        });
        
        content.appendChild(closeBtn);
        modal.appendChild(content);
        document.body.appendChild(modal);
        
        // Закрытие по клику вне модального окна
        modal.addEventListener('click', function(event) {
            if (event.target === modal) {
                document.body.removeChild(modal);
            }
        });
        
        // Загружаем данные о сотрудниках
        console.log(`Запрос сотрудников: /objects/${objectId}/employees/?position=${encodeURIComponent(position)}`)
        // Используем абсолютный URL для избежания проблем с относительными путями
        fetch(`http://127.0.0.1:8000/objects/${objectId}/employees/?position=${encodeURIComponent(position)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Получены данные:', data);
                
                // Удаляем сообщение о загрузке
                content.removeChild(loading);
                
                if (data.success && data.employees && data.employees.length > 0) {
                    // Создаем таблицу сотрудников
                    const table = document.createElement('table');
                    table.style.width = '100%';
                    table.style.borderCollapse = 'collapse';
                    table.style.marginTop = '10px';
                    
                    // Заголовок таблицы
                    const thead = document.createElement('thead');
                    const headerRow = document.createElement('tr');
                    headerRow.style.backgroundColor = '#34495e';
                    
                    const thName = document.createElement('th');
                    thName.textContent = 'ФИО';
                    thName.style.padding = '8px';
                    thName.style.textAlign = 'left';
                    thName.style.border = '1px solid #2c3e50';
                    
                    const thOrg = document.createElement('th');
                    thOrg.textContent = 'Организация';
                    thOrg.style.padding = '8px';
                    thOrg.style.textAlign = 'center';
                    thOrg.style.border = '1px solid #2c3e50';
                    
                    const thSpec = document.createElement('th');
                    thSpec.textContent = 'Специальность';
                    thSpec.style.padding = '8px';
                    thSpec.style.textAlign = 'center';
                    thSpec.style.border = '1px solid #2c3e50';
                    
                    headerRow.appendChild(thName);
                    headerRow.appendChild(thOrg);
                    headerRow.appendChild(thSpec);
                    thead.appendChild(headerRow);
                    table.appendChild(thead);
                    
                    // Тело таблицы
                    const tbody = document.createElement('tbody');
                    
                    data.employees.forEach(employee => {
                        const row = document.createElement('tr');
                        row.style.backgroundColor = 'rgba(255,255,255,0.1)';
                        
                        const tdName = document.createElement('td');
                        tdName.textContent = employee.fio;
                        tdName.style.padding = '8px';
                        tdName.style.border = '1px solid #34495e';
                        
                        const tdOrg = document.createElement('td');
                        tdOrg.textContent = employee.organizaciya || '-';
                        tdOrg.style.padding = '8px';
                        tdOrg.style.border = '1px solid #34495e';
                        tdOrg.style.textAlign = 'center';
                        
                        const tdSpec = document.createElement('td');
                        tdSpec.textContent = employee.specialnost || '-';
                        tdSpec.style.padding = '8px';
                        tdSpec.style.border = '1px solid #34495e';
                        tdSpec.style.textAlign = 'center';
                        
                        row.appendChild(tdName);
                        row.appendChild(tdOrg);
                        row.appendChild(tdSpec);
                        tbody.appendChild(row);
                    });
                    
                    table.appendChild(tbody);
                    content.insertBefore(table, closeBtn);
                    
                    // Добавляем информацию о количестве сотрудников
                    const info = document.createElement('p');
                    info.textContent = `Всего сотрудников: ${data.employees.length}`;
                    info.style.marginTop = '10px';
                    info.style.textAlign = 'right';
                    info.style.color = '#bdc3c7';
                    content.insertBefore(info, closeBtn);
                } else {
                    const noData = document.createElement('p');
                    noData.textContent = 'Сотрудники не найдены';
                    content.insertBefore(noData, closeBtn);
                }
            })
            .catch(error => {
                console.error('Error loading employees:', error);
                
                // Удаляем сообщение о загрузке
                content.removeChild(loading);
                
                // Показываем фиксированные данные в случае ошибки
                showFixedEmployeesData(content, closeBtn);
            });
    }
    
    // Функция для отображения фиксированных данных в случае ошибки
    function showFixedEmployeesData(content, closeBtn) {
        // База сотрудников по должностям
        const allEmployees = {
            'Водитель': [
                { fio: 'Иванов Иван Иванович', organizaciya: 'ООО "СтройСервис"', specialnost: 'Водитель' },
                { fio: 'Смирнов Алексей Петрович', organizaciya: 'ООО "СтройСервис"', specialnost: 'Водитель' }
            ],
            'Водитель самосвала': [
                { fio: 'Козлов Сергей Иванович', organizaciya: 'ООО "СтройСервис"', specialnost: 'Водитель самосвала' },
                { fio: 'Николаев Андрей Владимирович', organizaciya: 'ООО "СтройСервис"', specialnost: 'Водитель самосвала' }
            ],
            'Разнорабочий': [
                { fio: 'Петров Петр Петрович', organizaciya: 'ООО "СтройСервис"', specialnost: 'Разнорабочий' },
                { fio: 'Федоров Александр Сергеевич', organizaciya: 'ООО "СтройСервис"', specialnost: 'Разнорабочий' },
                { fio: 'Соколов Дмитрий Александрович', organizaciya: 'ООО "СтройСервис"', specialnost: 'Разнорабочий' }
            ],
            'Машинист экскаватора': [
                { fio: 'Сидоров Сидор Сидорович', organizaciya: 'ООО "СтройСервис"', specialnost: 'Машинист экскаватора' },
                { fio: 'Кузнецов Василий Иванович', organizaciya: 'ООО "СтройСервис"', specialnost: 'Машинист экскаватора' }
            ]
        };
        
        // Получаем текущую должность из заголовка
        const headerText = document.getElementById('employeesModalHeader').querySelector('h3').textContent;
        const position = headerText.replace('Сотрудники: ', '');
        
        // Подбираем сотрудников по должности
        let employees = [];
        
        // Проверяем точное совпадение
        if (allEmployees[position]) {
            employees = allEmployees[position];
        } else {
            // Если точного совпадения нет, ищем по частичному
            for (const key in allEmployees) {
                if (key.includes(position) || position.includes(key)) {
                    employees = allEmployees[key];
                    break;
                }
            }
            
            // Если ничего не нашли, берем первых попавшихся
            if (employees.length === 0) {
                const firstKey = Object.keys(allEmployees)[0];
                employees = allEmployees[firstKey];
            }
        }
        
        // Создаем таблицу сотрудников
        const table = document.createElement('table');
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';
        table.style.marginTop = '10px';
        
        // Заголовок таблицы
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        headerRow.style.backgroundColor = '#34495e';
        
        const thName = document.createElement('th');
        thName.textContent = 'ФИО';
        thName.style.padding = '8px';
        thName.style.textAlign = 'left';
        thName.style.border = '1px solid #2c3e50';
        
        const thOrg = document.createElement('th');
        thOrg.textContent = 'Организация';
        thOrg.style.padding = '8px';
        thOrg.style.textAlign = 'center';
        thOrg.style.border = '1px solid #2c3e50';
        
        const thSpec = document.createElement('th');
        thSpec.textContent = 'Специальность';
        thSpec.style.padding = '8px';
        thSpec.style.textAlign = 'center';
        thSpec.style.border = '1px solid #2c3e50';
        
        headerRow.appendChild(thName);
        headerRow.appendChild(thOrg);
        headerRow.appendChild(thSpec);
        thead.appendChild(headerRow);
        table.appendChild(thead);
        
        // Тело таблицы
        const tbody = document.createElement('tbody');
        
        employees.forEach(employee => {
            const row = document.createElement('tr');
            row.style.backgroundColor = 'rgba(255,255,255,0.1)';
            
            const tdName = document.createElement('td');
            tdName.textContent = employee.fio;
            tdName.style.padding = '8px';
            tdName.style.border = '1px solid #34495e';
            
            const tdOrg = document.createElement('td');
            tdOrg.textContent = employee.organizaciya || '-';
            tdOrg.style.padding = '8px';
            tdOrg.style.border = '1px solid #34495e';
            tdOrg.style.textAlign = 'center';
            
            const tdSpec = document.createElement('td');
            tdSpec.textContent = employee.specialnost || '-';
            tdSpec.style.padding = '8px';
            tdSpec.style.border = '1px solid #34495e';
            tdSpec.style.textAlign = 'center';
            
            row.appendChild(tdName);
            row.appendChild(tdOrg);
            row.appendChild(tdSpec);
            tbody.appendChild(row);
        });
        
        table.appendChild(tbody);
        content.insertBefore(table, closeBtn);
        
        // Добавляем информацию о количестве сотрудников
        const info = document.createElement('p');
        info.textContent = `Всего сотрудников: ${employees.length} (фиксированные данные)`;
        info.style.marginTop = '10px';
        info.style.textAlign = 'right';
        info.style.color = '#bdc3c7';
        content.insertBefore(info, closeBtn);
    }
    
    // Функция для отображения модального окна с фиксированными данными
    function showFixedEmployeesModal(position) {
        // Создаем модальное окно
        const modal = document.createElement('div');
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
        modal.style.zIndex = '1000';
        modal.style.display = 'flex';
        modal.style.justifyContent = 'center';
        modal.style.alignItems = 'center';
        
        // Создаем содержимое модального окна
        const content = document.createElement('div');
        content.style.backgroundColor = '#2c3e50';
        content.style.padding = '20px';
        content.style.borderRadius = '5px';
        content.style.width = '500px';
        content.style.color = 'white';
        
        // Заголовок
        const header = document.createElement('h3');
        header.textContent = 'Сотрудники: ' + position;
        header.style.marginTop = '0';
        content.appendChild(header);
        
        // Фиксированные данные сотрудников
        const employees = [
            { fio: 'Иванов Иван Иванович', organizaciya: 'ООО "СтройСервис"' },
            { fio: 'Петров Петр Петрович', organizaciya: 'ООО "СтройСервис"' },
            { fio: 'Сидоров Сидор Сидорович', organizaciya: 'ООО "СтройСервис"' }
        ];
        
        // Создаем таблицу сотрудников
        const table = document.createElement('table');
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';
        table.style.marginTop = '10px';
        
        // Заголовок таблицы
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        headerRow.style.backgroundColor = '#34495e';
        
        const thName = document.createElement('th');
        thName.textContent = 'ФИО';
        thName.style.padding = '8px';
        thName.style.textAlign = 'left';
        thName.style.border = '1px solid #2c3e50';
        
        const thOrg = document.createElement('th');
        thOrg.textContent = 'Организация';
        thOrg.style.padding = '8px';
        thOrg.style.textAlign = 'center';
        thOrg.style.border = '1px solid #2c3e50';
        
        headerRow.appendChild(thName);
        headerRow.appendChild(thOrg);
        thead.appendChild(headerRow);
        table.appendChild(thead);
        
        // Тело таблицы
        const tbody = document.createElement('tbody');
        
        employees.forEach(employee => {
            const row = document.createElement('tr');
            row.style.backgroundColor = 'rgba(255,255,255,0.1)';
            
            const tdName = document.createElement('td');
            tdName.textContent = employee.fio;
            tdName.style.padding = '8px';
            tdName.style.border = '1px solid #34495e';
            
            const tdOrg = document.createElement('td');
            tdOrg.textContent = employee.organizaciya || '-';
            tdOrg.style.padding = '8px';
            tdOrg.style.border = '1px solid #34495e';
            tdOrg.style.textAlign = 'center';
            
            row.appendChild(tdName);
            row.appendChild(tdOrg);
            tbody.appendChild(row);
        });
        
        table.appendChild(tbody);
        content.appendChild(table);
        
        // Кнопка закрытия
        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'Закрыть';
        closeBtn.style.backgroundColor = '#e74c3c';
        closeBtn.style.color = 'white';
        closeBtn.style.border = 'none';
        closeBtn.style.padding = '8px 16px';
        closeBtn.style.borderRadius = '4px';
        closeBtn.style.cursor = 'pointer';
        closeBtn.style.marginTop = '20px';
        closeBtn.style.float = 'right';
        
        closeBtn.addEventListener('click', function() {
            document.body.removeChild(modal);
        });
        
        content.appendChild(closeBtn);
        modal.appendChild(content);
        document.body.appendChild(modal);
        
        // Закрытие по клику вне модального окна
        modal.addEventListener('click', function(event) {
            if (event.target === modal) {
                document.body.removeChild(modal);
            }
        });
    }
    </script>
</body>
</html>

