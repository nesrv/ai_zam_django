{% load static %}
{% load object_filters %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ object.nazvanie }} - AI-ZAM</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            padding: 20px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.8;
        }
        
        .table-container {
            padding: 0;
            overflow-x: auto;
            overflow-y: visible;
            max-width: 100vw;
            -webkit-overflow-scrolling: touch;
        }
        
        .resource-table {
            width: auto;
            min-width: 2000px;
            border-collapse: collapse;
            margin-bottom: 20px;
            white-space: nowrap;
            table-layout: fixed;
        }
        
        .resource-table th {
            background: #34495e;
            color: white;
            padding: 10px 8px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #2c3e50;
            position: sticky;
            top: 0;
        }
        
        .resource-table td {
            padding: 8px;
            border: 1px solid #ddd;
            background: white;
        }
        
        .resource-table .number {
            text-align: right;
        }
        
        .main-header td {
            background: #1a2530 !important;
            color: white !important;
            font-weight: bold;
            text-align: center;
            padding: 10px 8px;
            font-size: 2em;
        }
        
        .category-header td {
            background: #3498db !important;
            color: white !important;
            font-weight: bold;
            text-align: left;
            padding: 8px;
        }
        
        .category-кадры td { background: #e8f4fd; }
        .category-машины td { background: #fff3cd; }
        .category-материалы td { background: #d4edda; }
        .category-административно td { background: #f8d7da; }
        .category-сиз td { background: #e2e3e5; }
        .category-подрядные td { background: #d1ecf1; }
        
        .total-row td {
            background: #2c3e50 !important;
            color: white !important;
            font-weight: bold;
        }
        
        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: inline-block;
            padding: 10px 20px;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .back-btn:hover {
            background: #2980b9;
        }
        
        .edit-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: inline-block;
            padding: 10px 20px;
            background: #e74c3c;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .edit-btn:hover {
            background: #c0392b;
        }
        
        .bold {
            font-weight: bold;
        }
        
        .editable-cell {
            cursor: pointer;
            background-color: #f8f9fa;
        }
        
        .editable-cell:hover {
            background-color: #e9ecef;
        }
        
        .editing {
            background-color: #fff3cd !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>{{ object.nazvanie }}</h1>
            <p>Смета ресурсов по объекту</p>
        </div>
        
        <div class="table-container">
            <table class="resource-table">
                <thead>
                    <tr>
                        <th style="width: 5%;">Наименование</th>
                        <th style="width: 2%;">Ед.<br>изм</th>
                        <th style="width: 3%;">Зарез.<br>лимитов</th>
                        <th style="width: 3%;">Заплан.<br>цена</th>
                        <th style="width: 3%;">Сумма</th>
                        <th style="width: 2%;">Потрач.<br>лимитов</th>
                        <th style="width: 2%;">Остал.<br>лимитов</th>
                        {% for day in days %}
                        <th style="width: 3%;">{{ day|date:"d.m" }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    <tr class="main-header">
                        <td colspan="7">Планируемые расходы</td>
                        <td colspan="{{ days|length }}">Фактические расходы</td>
                    </tr>
                    
                    {% regroup resources by resurs.kategoriya_resursa.nazvanie as category_list %}
                    
                    {% for category in category_list %}
                    <tr class="category-header">
                        <td colspan="{{ 7|add:days|length }}">{{ category.grouper|title }}</td>
                    </tr>
                    
                    {% for resource in category.list %}
                    <tr class="category-{{ category.grouper|lower }}">
                        <td>{{ resource.resurs.naimenovanie }}</td>
                        <td>{{ resource.resurs.edinica_izmereniya }}</td>
                        <td class="number">{{ resource.kolichestvo|floatformat:0 }}</td>
                        <td class="number">{{ resource.cena|floatformat:0 }}</td>
                        <td class="number">{{ resource.kolichestvo|multiply:resource.cena|floatformat:0 }}</td>
                        
                        <td class="number">{{ resource.potracheno|floatformat:0 }}</td>
                        <td class="number">{{ resource.kolichestvo|subtract:resource.potracheno|floatformat:0 }}</td>
                        
                        {% for day in days %}
                            <td class="number editable-cell" 
                                data-resource-id="{{ resource.id }}" 
                                data-date="{{ day|date:'Y-m-d' }}" 
                                onclick="editCell(this)">
                            {% with day_value=0 %}
                                {% for fr in fakticheskij_resursy %}
                                    {% if fr.resurs_po_objektu.id == resource.id %}
                                        {% for rashod in raskhody|get_item:fr.id %}
                                            {% if rashod.data|date:"Y-m-d" == day|date:"Y-m-d" %}
                                                {{ rashod.izraskhodovano|floatformat:0 }}
                                                {% with day_value=1 %}{% endwith %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                {% endfor %}
                                <!-- {% if day_value == 0 %}0{% endif %} -->
                            {% endwith %}
                            </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                    
                    <tr class="total-row">
                        <td colspan="4">ИТОГО:</td>
                        <td class="number">{{ category.grouper|get_category_sum:resources|floatformat:0 }}</td>
                        <td colspan="{{ 2|add:days|length }}"></td>
                    </tr>
                    {% endfor %}
                    
                    {% with total_sum=0 %}
                        {% for resource in resources %}
                            {% with total_sum=total_sum|add:resource.kolichestvo|multiply:resource.cena %}{% endwith %}
                        {% endfor %}
                        <tr class="total-row">
                            <td colspan="4">Планируемая сумма затрат по объекту</td>
                            <td class="number">{{ total_sum|floatformat:0 }}</td>
                            <td colspan="2"></td>
                            <td colspan="{{ days|length }}" class="bold">Фактические расходы</td>
                        </tr>
                    {% endwith %}
                </tbody>
            </table>
        </div>
        
    </div>
    
    <a href="/objects/" class="back-btn">← Назад к списку объектов</a>
    <a href="/admin/object/objekt/{{ object.id }}/change/" class="edit-btn">✎ Редактировать объект</a>
    
    <script>
    function editCell(cell) {
        if (cell.classList.contains('editing')) return;
        
        const currentValue = cell.textContent.trim();
        const input = document.createElement('input');
        input.type = 'number';
        input.value = currentValue;
        input.style.width = '120px';
        input.style.height = '30px';
        input.style.border = '2px solid #007bff';
        input.style.background = 'white';
        input.style.textAlign = 'right';
        input.style.fontSize = '14px';
        input.style.padding = '5px';
        input.style.borderRadius = '4px';
        
        cell.innerHTML = '';
        cell.appendChild(input);
        cell.classList.add('editing');
        input.focus();
        input.select();
        
        function saveValue() {
            const newValue = input.value || '0';
            cell.textContent = newValue;
            cell.classList.remove('editing');
            
            // Отправляем данные на сервер
            const resourceId = cell.dataset.resourceId;
            const date = cell.dataset.date;
            
            fetch('/update-expense/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    resource_id: resourceId,
                    date: date,
                    amount: newValue
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Обновляем ячейки Потрачено и Осталось
                    const row = cell.closest('tr');
                    const cells = row.querySelectorAll('td');
                    cells[5].textContent = Math.round(data.potracheno); // Потрачено
                    cells[6].textContent = Math.round(data.ostatok); // Осталось
                }
            });
        }
        
        input.addEventListener('blur', saveValue);
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                saveValue();
            }
        });
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    </script>
</body>
</html>