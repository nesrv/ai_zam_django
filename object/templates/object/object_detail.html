{% load static %}
{% load object_filters %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ object.nazvanie }} - AI-ZAM</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            padding: 12px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 12px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .header h1 {
            font-size: 20px;
            margin-bottom: 3px;
        }
        
        .header p {
            opacity: 0.8;
            font-size: 13px;
            margin-bottom: 8px;
        }
        
        .header-info {
            margin-top: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .info-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 12px;
        }
        
        .info-item strong {
            color: #ecf0f1;
        }
        
        .table-container {
            padding: 0;
            overflow-x: auto;
            overflow-y: visible;
            max-width: 100vw;
            -webkit-overflow-scrolling: touch;
        }
        
        .resource-table {
            width: auto;
            min-width: 2000px;
            border-collapse: collapse;
            margin-bottom: 12px;
            white-space: nowrap;
            table-layout: fixed;
        }
        
        .resource-table th {
            background: #34495e;
            color: white;
            padding: 8px 6px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #2c3e50;
            position: sticky;
            top: 0;
            font-size: 12px;
        }
        
        .resource-table td {
            padding: 6px;
            border: 1px solid #ddd;
            background: white;
            font-size: 12px;
        }
        
        .resource-table .number {
            text-align: right;
        }
        
        .main-header td {
            background: #1a2530 !important;
            color: white !important;
            font-weight: bold;
            text-align: center;
            padding: 8px 6px;
            font-size: 1.7em;
        }
        
        .category-header td {
            background: #3498db !important;
            color: white !important;
            font-weight: bold;
            text-align: left;
            padding: 6px;
            font-size: 13px;
        }
        
        .category-кадры td { background: #e8f4fd; }
        .category-машины td { background: #fff3cd; }
        .category-материалы td { background: #d4edda; }
        .category-административно td { background: #f8d7da; }
        .category-сиз td { background: #e2e3e5; }
        .category-подрядные td { background: #d1ecf1; }
        
        .total-row td {
            background: #2c3e50 !important;
            color: white !important;
            font-weight: bold;
            font-size: 12px;
        }
        
        .back-btn {
            position: fixed;
            top: 12px;
            left: 12px;
            z-index: 1000;
            display: inline-block;
            padding: 6px 12px;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 3px;
            transition: background 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 12px;
        }
        
        .back-btn:hover {
            background: #2980b9;
        }
        
        .edit-btn {
            position: fixed;
            top: 12px;
            right: 12px;
            z-index: 1000;
            display: inline-block;
            padding: 6px 12px;
            background: #e74c3c;
            color: white;
            text-decoration: none;
            border-radius: 3px;
            transition: background 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 12px;
        }
        
        .edit-btn:hover {
            background: #c0392b;
        }
        
        .bold {
            font-weight: bold;
        }
        
        .editable-cell {
            cursor: pointer;
            background-color: #f8f9fa;
        }
        
        .editable-cell:hover {
            background-color: #e9ecef;
        }
        
        .editing {
            background-color: #fff3cd !important;
        }
        
        .main-action-btns {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 20px 0 20px 0;
        }
        .main-btn {
            display: inline-block;
            padding: 12px 32px;
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 6px;
            border: none;
            background: #3498db;
            color: #fff;
            text-decoration: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
            transition: background 0.2s, box-shadow 0.2s;
        }
        .main-btn:hover {
            background: #217dbb;
            color: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        
        .main-btn.active {
            background: #27ae60;
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
        }
        
        .main-btn.active:hover {
            background: #229954;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>{{ object.nazvanie }} (смета ресурсов по объекту) </h1>
          
            <div class="header-info">
                <div class="info-item">
                    <strong>Ответственный:</strong> 
                    {% if object.otvetstvennyj %}
                        {{ object.otvetstvennyj.fio }}
                    {% else %}
                        Не назначен
                    {% endif %}
                </div>
                <div class="info-item">
                    <strong>Дата начала:</strong> {{ object.data_nachala|date:"d.m.Y" }}
                </div>
                <div class="info-item">
                    <strong>Общая стоимость ресурсов:</strong> {{ total_cost|floatformat:0 }} ₽
                </div>
            </div>
            <!-- Две кнопки после header-info -->
            <div class="main-action-btns">
                <a href="/objects/{{ object.id }}/" class="main-btn active">Расходная часть</a>
                <a href="/objects/{{ object.id }}/income/" class="main-btn">Доходная часть</a>
            </div>
            
            <!-- Кнопки для добавления ресурсов -->
            <div style="display: flex; justify-content: center; gap: 10px; margin-top: 10px;">
                <button onclick="showAddCategoryModal()" style="background: #f39c12; color: white; padding: 8px 16px; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">+ Категория</button>
                <button onclick="showAddResourceModal()" style="background: #9b59b6; color: white; padding: 8px 16px; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">+ Ресурс</button>
            </div>
        </div>
        
        <div class="table-container">
            <table class="resource-table">
                <thead>
                    <tr>
                        <th style="width: 5%;">Наименование</th>
                        <th style="width: 2%;">Ед.<br>изм</th>
                        <th style="width: 3%;">Зарез.<br>лимитов</th>
                        <th style="width: 3%;">Заплан.<br>цена</th>
                        <th style="width: 3%;">Сумма</th>
                        <th style="width: 2%;">Потрач.<br>лимитов</th>
                        <th style="width: 2%;">Остал.<br>лимитов</th>
                        {% for day in days %}
                        <th style="width: 3%;">{{ day|date:"d.m" }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    <tr class="main-header">
                        <td colspan="7">Планируемые расходы</td>
                        <td colspan="{{ days|length }}">Фактические расходы</td>
                    </tr>
                    
                    {% regroup resources by resurs.kategoriya_resursa.nazvanie as category_list %}
                    
                    {% for category in category_list %}
                    {% if category.grouper|lower != 'подрядные организации' %}
                    <tr class="category-header">
                        <td colspan="{{ 7|add:days|length }}">{{ category.grouper|title }}</td>
                    </tr>
                    
                    {% for resource in category.list %}
                    <tr class="category-{{ category.grouper|lower }}">
                        <td>{{ resource.resurs.naimenovanie }}</td>
                        <td>{{ resource.resurs.edinica_izmereniya }}</td>
                        <td class="number editable-cell" 
                            data-resource-id="{{ resource.id }}" 
                            data-field-type="kolichestvo"
                            onclick="editResourceCell(this)">{{ resource.kolichestvo|floatformat:0 }}</td>
                        <td class="number editable-cell" 
                            data-resource-id="{{ resource.id }}" 
                            data-field-type="cena"
                            onclick="editResourceCell(this)">{{ resource.cena|floatformat:0 }}</td>
                        <td class="number sum-cell" 
                            data-resource-id="{{ resource.id }}">{{ resource.kolichestvo|multiply:resource.cena|floatformat:0 }}</td>
                        
                        <td class="number">{{ resource.potracheno|floatformat:0 }}</td>
                        <td class="number ostatok-cell" 
                            data-resource-id="{{ resource.id }}">{{ resource.kolichestvo|subtract:resource.potracheno|floatformat:0 }}</td>
                        
                        {% for day in days %}
                            <td class="number editable-cell" 
                                data-resource-id="{{ resource.id }}" 
                                data-date="{{ day|date:'Y-m-d' }}" 
                                onclick="editCell(this)">
                            {% with day_value=0 %}
                                {% for fr in fakticheskij_resursy %}
                                    {% if fr.resurs_po_objektu.id == resource.id %}
                                        {% for rashod in raskhody|get_item:fr.id %}
                                            {% if rashod.data|date:"Y-m-d" == day|date:"Y-m-d" %}
                                                {{ rashod.izraskhodovano|floatformat:0 }}
                                                {% with day_value=1 %}{% endwith %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                {% endfor %}
                                <!-- {% if day_value == 0 %}0{% endif %} -->
                            {% endwith %}
                            </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                    
                    <tr class="total-row">
                        <td colspan="4">ИТОГО:</td>
                        <td class="number category-total">{{ category.grouper|get_category_sum:resources|floatformat:0 }}</td>
                        <td class="number category-potracheno">0</td>
                        <td></td>
                        {% for day in days %}
                        <td class="number category-daily-total">
                        {% with category_totals=category_daily_totals|get_item:category.grouper %}
                            {% with day_key=day|date:'Y-m-d' %}
                                {{ category_totals|get_item:day_key|floatformat:0 }}
                            {% endwith %}
                        {% endwith %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endif %}
                    {% endfor %}
                    
                    <tr class="total-row">
                        <td colspan="7">Итого фактических расходов по дням:</td>
                        {% for day in days %}
                        <td class="number total-daily-total">
                        {% with day_key=day|date:'Y-m-d' %}
                            {{ total_daily_expenses|get_item:day_key|floatformat:0 }}
                        {% endwith %}
                        </td>
                        {% endfor %}
                    </tr>
                </tbody>
            </table>
        </div>
        
    </div>
    
    <a href="/objects/" class="back-btn">← Назад к списку объектов</a>
    <a href="/admin/object/objekt/{{ object.id }}/change/" class="edit-btn">✎ Редактировать объект</a>
    
    <script>
    function formatNumber(num) {
        if (num === null || num === undefined || isNaN(num)) {
            return '0';
        }
        // Используем надежный способ форматирования
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    }
    
    function updateTotalDailyExpenses() {
        console.log('updateTotalDailyExpenses called');
        // Получаем все итоговые строки категорий
        const categoryTotalRows = document.querySelectorAll('.total-row');
        const daysCount = document.querySelectorAll('th[style*="width: 3%"]').length;
        console.log('Days count:', daysCount);
        
        // Инициализируем массив для итоговых расходов по дням
        const totalDailyExpenses = new Array(daysCount).fill(0);
        
        // Проходим по всем итоговым строкам категорий (кроме последней)
        for (let i = 0; i < categoryTotalRows.length - 1; i++) {
            const row = categoryTotalRows[i];
            const dailyCells = row.querySelectorAll('.category-daily-total');
            
            // Суммируем дневные расходы по категориям
            dailyCells.forEach((cell, dayIndex) => {
                const cellValue = parseFloat(cell.textContent.trim().replace(/\s/g, '')) || 0;
                totalDailyExpenses[dayIndex] += cellValue;
                console.log(`Day ${dayIndex + 1}: added ${cellValue}, total now: ${totalDailyExpenses[dayIndex]}`);
            });
        }
        
        // Обновляем последнюю итоговую строку
        const lastTotalRow = categoryTotalRows[categoryTotalRows.length - 1];
        if (lastTotalRow) {
            const totalDailyCells = lastTotalRow.querySelectorAll('.total-daily-total');
            totalDailyCells.forEach((cell, dayIndex) => {
                const formattedValue = formatNumber(Math.round(totalDailyExpenses[dayIndex]));
                console.log(`Setting day ${dayIndex + 1} total to:`, formattedValue);
                cell.textContent = formattedValue;
            });
        }
        console.log('updateTotalDailyExpenses completed');
    }
    
    function editCell(cell) {
        if (cell.classList.contains('editing')) return;
        
        try {
            let currentValue = cell.textContent.trim().replace(/\s/g, '');
            console.log('Current value:', currentValue);
            
            // Если ячейка пустая или содержит только пробелы, устанавливаем 0
            if (!currentValue || currentValue === '') {
                currentValue = '0';
            }
            
            const input = document.createElement('input');
            input.type = 'number';
            input.value = currentValue;
            input.style.width = '100px';
            input.style.height = '25px';
            input.style.border = '2px solid #007bff';
            input.style.background = 'white';
            input.style.textAlign = 'right';
            input.style.fontSize = '12px';
            input.style.padding = '4px';
            input.style.borderRadius = '4px';
            
            cell.innerHTML = '';
            cell.appendChild(input);
            cell.classList.add('editing');
            input.focus();
            input.select();
            
            function saveValue() {
                try {
                    const newValue = input.value || '0';
                    console.log('New value:', newValue);
                    
                    cell.textContent = formatNumber(parseFloat(newValue));
                    cell.classList.remove('editing');
                    
                    // Обновляем итоговые данные в реальном времени
                    updateAllTotals();
                    
                    // Отправляем данные на сервер
                    const resourceId = cell.dataset.resourceId;
                    const date = cell.dataset.date;
                    
                    console.log('Sending data:', { resource_id: resourceId, date: date, amount: newValue });
                    
                    fetch('/update-expense/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({
                            resource_id: resourceId,
                            date: date,
                            amount: newValue
                        })
                    })
                    .then(response => {
                        console.log('Response status:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('Response data:', data);
                        if (data.success) {
                            // Обновляем ячейки Потрачено и Осталось
                            const row = cell.closest('tr');
                            console.log('Found row:', row);
                            
                            const cells = row.querySelectorAll('td');
                            console.log('Cells count:', cells.length);
                            console.log('Cells[5] (Потрачено):', cells[5]);
                            console.log('Cells[6] (Осталось):', cells[6]);
                            
                            if (cells[5]) {
                                const potrachenoFormatted = formatNumber(Math.round(data.potracheno));
                                console.log('Setting Потрачено to:', potrachenoFormatted);
                                cells[5].textContent = potrachenoFormatted;
                            }
                            
                            if (cells[6]) {
                                const ostatokFormatted = formatNumber(Math.round(data.ostatok));
                                console.log('Setting Осталось to:', ostatokFormatted);
                                cells[6].textContent = ostatokFormatted;
                            }
                            
                            console.log('Updating totals...');
                            // Обновляем итоговые суммы
                            updateAllTotals();
                            console.log('Totals updated successfully');
                        } else {
                            console.error('Server returned error:', data.error);
                            let errorMessage = 'Ошибка при сохранении';
                            if (data.error && data.error.includes('database is locked')) {
                                errorMessage = 'База данных временно заблокирована. Попробуйте еще раз через несколько секунд.';
                            } else if (data.error) {
                                errorMessage += ': ' + data.error;
                            }
                            alert(errorMessage);
                        }
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                        let errorMessage = 'Ошибка при отправке данных';
                        if (error.message.includes('Failed to fetch')) {
                            errorMessage = 'Ошибка соединения с сервером. Проверьте подключение к интернету.';
                        } else {
                            errorMessage += ': ' + error.message;
                        }
                        alert(errorMessage);
                    });
                } catch (error) {
                    console.error('Save value error:', error);
                    alert('Ошибка при сохранении: ' + error.message);
                }
            }
            
            input.addEventListener('blur', saveValue);
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveValue();
                }
            });
            
            // Добавляем обновление в реальном времени при вводе
            input.addEventListener('input', function() {
                const newValue = input.value || '0';
                const row = cell.closest('tr');
                const cells = row.querySelectorAll('td');
                
                // Обновляем только ячейку Осталось в реальном времени
                // Ячейка Потрачено будет обновлена сервером
                const kolichestvo = parseFloat(cells[2].textContent.trim().replace(/\s/g, '')) || 0;
                const currentPotracheno = parseFloat(cells[5].textContent.trim().replace(/\s/g, '')) || 0;
                const ostatok = kolichestvo - currentPotracheno;
                
                if (cells[6]) {
                    cells[6].textContent = formatNumber(Math.round(ostatok));
                }
                
                // Обновляем итоговые данные в реальном времени
                updateAllTotals();
            });
        } catch (error) {
            console.error('Edit cell error:', error);
            alert('Ошибка при редактировании ячейки: ' + error.message);
        }
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function editResourceCell(cell) {
        if (cell.classList.contains('editing')) return;
        
        const currentValue = cell.textContent.trim().replace(/\s/g, '');
        const input = document.createElement('input');
        input.type = 'number';
        input.value = currentValue;
        input.style.width = '100px';
        input.style.height = '25px';
        input.style.border = '2px solid #28a745';
        input.style.background = 'white';
        input.style.textAlign = 'right';
        input.style.fontSize = '12px';
        input.style.padding = '4px';
        input.style.borderRadius = '4px';
        
        cell.innerHTML = '';
        cell.appendChild(input);
        cell.classList.add('editing');
        input.focus();
        input.select();
        
        function saveResourceValue() {
            const newValue = input.value || '0';
            cell.textContent = formatNumber(parseFloat(newValue));
            cell.classList.remove('editing');
            
            // Получаем текущие значения из строки
            const row = cell.closest('tr');
            const cells = row.querySelectorAll('td');
            
            // Получаем значения количества и цены
            let kolichestvo = parseFloat(cells[2].textContent.trim().replace(/\s/g, '')) || 0;
            let cena = parseFloat(cells[3].textContent.trim().replace(/\s/g, '')) || 0;
            
            // Если редактируем количество или цену, обновляем соответствующее значение
            const fieldType = cell.dataset.fieldType;
            if (fieldType === 'kolichestvo') {
                kolichestvo = parseFloat(newValue) || 0;
            } else if (fieldType === 'cena') {
                cena = parseFloat(newValue) || 0;
            }
            
            // Пересчитываем сумму в реальном времени
            const newSum = kolichestvo * cena;
            
            // Обновляем ячейку суммы по идентификатору
            const sumCell = row.querySelector('.sum-cell');
            if (sumCell) {
                sumCell.textContent = formatNumber(Math.round(newSum));
            }
            
            // Пересчитываем остаток
            const potracheno = parseFloat(cells[5].textContent.trim().replace(/\s/g, '')) || 0;
            const ostatok = kolichestvo - potracheno;
            
            // Обновляем ячейку остатка по идентификатору
            const ostatokCell = row.querySelector('.ostatok-cell');
            if (ostatokCell) {
                ostatokCell.textContent = formatNumber(Math.round(ostatok));
            }
            
            // Обновляем итоговые данные в реальном времени
            updateAllTotals();
            
            // Отправляем данные на сервер
            const resourceId = cell.dataset.resourceId;
            
            fetch('/update-resource-data/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    resource_id: resourceId,
                    field_type: fieldType,
                    value: newValue
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Обновляем итоговые суммы
                    updateAllTotals();
                } else {
                    console.error('Server returned error:', data.error);
                    let errorMessage = 'Ошибка при сохранении';
                    if (data.error && data.error.includes('database is locked')) {
                        errorMessage = 'База данных временно заблокирована. Попробуйте еще раз через несколько секунд.';
                    } else if (data.error) {
                        errorMessage += ': ' + data.error;
                    }
                    alert(errorMessage);
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                let errorMessage = 'Ошибка при отправке данных';
                if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Ошибка соединения с сервером. Проверьте подключение к интернету.';
                } else {
                    errorMessage += ': ' + error.message;
                }
                alert(errorMessage);
            });
        }
        
        input.addEventListener('blur', saveResourceValue);
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                saveResourceValue();
            }
        });
        
        // Добавляем обновление в реальном времени при вводе
        input.addEventListener('input', function() {
            const newValue = input.value || '0';
            const row = cell.closest('tr');
            const cells = row.querySelectorAll('td');
            
            // Получаем значения количества и цены
            let kolichestvo = parseFloat(cells[2].textContent.trim().replace(/\s/g, '')) || 0;
            let cena = parseFloat(cells[3].textContent.trim().replace(/\s/g, '')) || 0;
            
            // Если редактируем количество или цену, обновляем соответствующее значение
            const fieldType = cell.dataset.fieldType;
            if (fieldType === 'kolichestvo') {
                kolichestvo = parseFloat(newValue) || 0;
            } else if (fieldType === 'cena') {
                cena = parseFloat(newValue) || 0;
            }
            
            // Пересчитываем сумму в реальном времени
            const newSum = kolichestvo * cena;
            
            // Обновляем ячейку суммы по идентификатору
            const sumCell = row.querySelector('.sum-cell');
            if (sumCell) {
                sumCell.textContent = formatNumber(Math.round(newSum));
            }
            
            // Пересчитываем остаток
            const potracheno = parseFloat(cells[5].textContent.trim().replace(/\s/g, '')) || 0;
            const ostatok = kolichestvo - potracheno;
            
            // Обновляем ячейку остатка по идентификатору
            const ostatokCell = row.querySelector('.ostatok-cell');
            if (ostatokCell) {
                ostatokCell.textContent = formatNumber(Math.round(ostatok));
            }
            
            // Обновляем итоговые данные в реальном времени
            updateAllTotals();
        });
    }
    
    function updateHeaderTotal() {
        // Пересчитываем общую стоимость ресурсов в заголовке
        let totalCost = 0;
        const sumCells = document.querySelectorAll('.sum-cell');
        
        sumCells.forEach(cell => {
            totalCost += parseFloat(cell.textContent.trim().replace(/\s/g, '')) || 0;
        });
        
        // Находим элемент с общей стоимостью в заголовке
        const headerInfo = document.querySelector('.header-info');
        if (headerInfo) {
            const totalCostElement = headerInfo.querySelector('.info-item:last-child');
            if (totalCostElement) {
                const strongElement = totalCostElement.querySelector('strong');
                if (strongElement) {
                    totalCostElement.innerHTML = `<strong>Общая стоимость ресурсов:</strong> ${formatNumber(Math.round(totalCost))} ₽`;
                }
            }
        }
    }
    
    function updateCategoryTotals() {
        console.log('updateCategoryTotals called');
        
        // Находим все итоговые строки категорий
        const categoryTotalRows = document.querySelectorAll('.total-row');
        console.log('Found total rows:', categoryTotalRows.length);
        
        // Проходим по каждой итоговой строке категории (кроме последней общей)
        for (let i = 0; i < categoryTotalRows.length - 1; i++) {
            const totalRow = categoryTotalRows[i];
            console.log(`Processing total row ${i + 1}`);
            
            // Находим предыдущую строку заголовка категории
            let categoryHeader = totalRow.previousElementSibling;
            while (categoryHeader && !categoryHeader.classList.contains('category-header')) {
                categoryHeader = categoryHeader.previousElementSibling;
            }
            
            if (!categoryHeader) {
                console.log('Category header not found for total row', i + 1);
                continue;
            }
            
            console.log('Found category header:', categoryHeader);
            
            // Получаем название категории
            const categoryName = categoryHeader.querySelector('td')?.textContent || 'Unknown';
            console.log('Category name:', categoryName);
            
            // Находим все строки ресурсов этой категории
            let categorySum = 0;
            let currentRow = categoryHeader.nextElementSibling;
            const categoryDailyTotals = new Array(20).fill(0); // 20 дней
            let resourceCount = 0;
            
            // Проходим по всем строкам ресурсов в этой категории
            while (currentRow && !currentRow.classList.contains('total-row') && !currentRow.classList.contains('category-header')) {
                // Проверяем, что это строка ресурса (имеет класс, начинающийся с 'category-')
                const classList = Array.from(currentRow.classList);
                const isResourceRow = classList.some(cls => cls.startsWith('category-'));
                
                console.log('Checking row with classes:', classList, 'isResourceRow:', isResourceRow);
                
                if (isResourceRow) {
                    resourceCount++;
                    console.log(`Processing resource ${resourceCount} in category ${categoryName}, classes:`, classList);
                    
                    // Суммируем общую стоимость ресурса
                    const sumCell = currentRow.querySelector('.sum-cell');
                    if (sumCell) {
                        const cellValue = parseFloat(sumCell.textContent.trim().replace(/\s/g, '')) || 0;
                        categorySum += cellValue;
                        console.log('Added to category sum:', cellValue, 'from cell text:', sumCell.textContent);
                    } else {
                        console.log('Sum cell not found for resource');
                    }
                    
                    // Суммируем дневные расходы
                    const cells = currentRow.querySelectorAll('td');
                    const cena = parseFloat(cells[3].textContent.trim().replace(/\s/g, '')) || 0;
                    
                    for (let j = 7; j < cells.length; j++) {
                        const dayIndex = j - 7;
                        const dayValue = parseFloat(cells[j].textContent.trim().replace(/\s/g, '')) || 0;
                        categoryDailyTotals[dayIndex] += cena * dayValue;
                    }
                }
                currentRow = currentRow.nextElementSibling;
            }
            
            console.log(`Category ${categoryName}: found ${resourceCount} resources, total sum: ${categorySum}`);
            
            // Обновляем общую сумму категории
            const totalCell = totalRow.querySelector('.category-total');
            if (totalCell) {
                const formattedSum = formatNumber(Math.round(categorySum));
                console.log(`Setting category total to:`, formattedSum);
                totalCell.textContent = formattedSum;
            }
            
            // Рассчитываем итог для столбца "Потрач.лимитов" по формуле: Σ Потрач.лимитов * Заплан.цена
            let categoryPotracheno = 0;
            currentRow = categoryHeader.nextElementSibling;
            
            while (currentRow && !currentRow.classList.contains('total-row') && !currentRow.classList.contains('category-header')) {
                const classList = Array.from(currentRow.classList);
                const isResourceRow = classList.some(cls => cls.startsWith('category-'));
                
                if (isResourceRow) {
                    const cells = currentRow.querySelectorAll('td');
                    const potracheno = parseFloat(cells[5].textContent.trim().replace(/\s/g, '')) || 0; // Потрач.лимитов
                    const cena = parseFloat(cells[3].textContent.trim().replace(/\s/g, '')) || 0; // Заплан.цена
                    categoryPotracheno += potracheno * cena;
                }
                currentRow = currentRow.nextElementSibling;
            }
            
            // Обновляем ячейку итога для "Потрач.лимитов"
            const potrachenoCell = totalRow.querySelector('.category-potracheno');
            if (potrachenoCell) {
                potrachenoCell.textContent = formatNumber(Math.round(categoryPotracheno));
            }
            
            // Обновляем дневные итоги категории
            const dailyTotalCells = totalRow.querySelectorAll('.category-daily-total');
            dailyTotalCells.forEach((cell, dayIndex) => {
                if (categoryDailyTotals[dayIndex] !== undefined) {
                    const formattedValue = formatNumber(Math.round(categoryDailyTotals[dayIndex]));
                    console.log(`Setting day ${dayIndex + 1} category total to:`, formattedValue);
                    cell.textContent = formattedValue;
                }
            });
        }
        
        console.log('updateCategoryTotals completed');
    }
    
    function updateTotalSum() {
        console.log('updateTotalSum called');
        // Пересчитываем общую сумму по объекту
        let totalSum = 0;
        const sumCells = document.querySelectorAll('.sum-cell');
        console.log('Found sum cells:', sumCells.length);
        
        sumCells.forEach(cell => {
            const cellValue = parseFloat(cell.textContent.trim().replace(/\s/g, '')) || 0;
            totalSum += cellValue;
            console.log('Added to total sum:', cellValue);
        });
        
        console.log('Total sum:', totalSum);
        
        // Обновляем общую сумму в последней строке
        const totalRows = document.querySelectorAll('.total-row');
        console.log('Found total rows:', totalRows.length);
        const lastTotalRow = totalRows[totalRows.length - 1];
        if (lastTotalRow) {
            // НЕ обновляем заголовок последней строки, оставляем оригинальный текст
            // const headerCell = lastTotalRow.querySelector('td:first-child');
            // if (headerCell) {
            //     headerCell.textContent = `ИТОГО: ${formatNumber(Math.round(totalSum))} ₽`;
            // }
        }
        console.log('updateTotalSum completed');
    }
    
    function updateAllTotals() {
        console.log('updateAllTotals called');
        // Обновляем все итоговые данные
        updateCategoryTotals();
        updateTotalSum();
        updateTotalDailyExpenses();
        updateHeaderTotal();
        console.log('updateAllTotals completed');
    }
    
    // Форматируем все числовые значения при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        const numberCells = document.querySelectorAll('.number');
        
        numberCells.forEach((cell, index) => {
            const text = cell.textContent.trim();
            
            // Форматируем все числовые значения
            if (text && !isNaN(parseFloat(text))) {
                const num = parseFloat(text);
                const formatted = formatNumber(num);
                cell.textContent = formatted;
            }
        });
        
        // Обновляем все итоговые данные при загрузке страницы
        updateAllTotals();
    });
    
    // Функции для модальных окон
    function showAddCategoryModal() {
        const modal = document.getElementById('categoryModal');
        modal.style.display = 'block';
    }
    
    function showAddResourceModal() {
        const modal = document.getElementById('resourceModal');
        modal.style.display = 'block';
    }
    
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }
    
    function addExistingCategory() {
        const categoryId = document.getElementById('existingCategory').value;
        if (!categoryId) return;
        
        fetch('/add-category-to-object/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                category_id: categoryId,
                object_id: {{ object.id }}
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    }
    
    function addNewCategory() {
        const name = document.getElementById('categoryName').value;
        if (!name) return;
        
        fetch('/add-category/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                name: name
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Добавляем созданную категорию к объекту
                return fetch('/add-category-to-object/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        category_id: data.id,
                        object_id: {{ object.id }}
                    })
                });
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    }
    
    function addResource() {
        const name = document.getElementById('resourceName').value;
        const unit = document.getElementById('resourceUnit').value;
        const categoryId = document.getElementById('resourceCategory').value;
        
        if (!name || !categoryId) return;
        
        fetch('/add-resource/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                name: name,
                unit: unit,
                category_id: categoryId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    }
    </script>
<!-- Модальное окно для добавления категории -->
<div id="categoryModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div style="background-color: #2c3e50; margin: 10% auto; padding: 20px; border-radius: 8px; width: 500px; color: white;">
        <h3>Категории ресурсов</h3>
        
        <div style="margin-bottom: 20px;">
            <h4>Выбрать существующую категорию:</h4>
            <select id="existingCategory" style="width: 100%; padding: 8px; margin: 5px 0; border: none; border-radius: 4px;">
                <option value="">Выберите категорию</option>
                {% for category in categories %}
                <option value="{{ category.id }}">{{ category.nazvanie }}</option>
                {% endfor %}
            </select>
            <button onclick="addExistingCategory()" style="background: #3498db; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-top: 5px;">Добавить к объекту</button>
        </div>
        
        <hr style="border-color: #34495e; margin: 20px 0;">
        
        <div>
            <h4>Создать новую категорию:</h4>
            <input type="text" id="categoryName" placeholder="Название новой категории" style="width: 100%; padding: 8px; margin: 5px 0; border: none; border-radius: 4px;">
            <button onclick="addNewCategory()" style="background: #27ae60; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-top: 5px;">Создать и добавить</button>
        </div>
        
        <div style="text-align: right; margin-top: 20px;">
            <button onclick="closeModal('categoryModal')" style="background: #e74c3c; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">Закрыть</button>
        </div>
    </div>
</div>

<!-- Модальное окно для добавления ресурса -->
<div id="resourceModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div style="background-color: #2c3e50; margin: 10% auto; padding: 20px; border-radius: 8px; width: 400px; color: white;">
        <h3>Добавить ресурс</h3>
        <input type="text" id="resourceName" placeholder="Название ресурса" style="width: 100%; padding: 8px; margin: 10px 0; border: none; border-radius: 4px;">
        <input type="text" id="resourceUnit" placeholder="Единица измерения" style="width: 100%; padding: 8px; margin: 10px 0; border: none; border-radius: 4px;">
        <select id="resourceCategory" style="width: 100%; padding: 8px; margin: 10px 0; border: none; border-radius: 4px;">
            <option value="">Выберите категорию</option>
            {% for category in categories %}
            <option value="{{ category.id }}">{{ category.nazvanie }}</option>
            {% endfor %}
        </select>
        <div style="text-align: right; margin-top: 15px;">
            <button onclick="closeModal('resourceModal')" style="background: #e74c3c; color: white; padding: 8px 16px; border: none; border-radius: 4px; margin-right: 10px; cursor: pointer;">Отмена</button>
            <button onclick="addResource()" style="background: #27ae60; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">Добавить</button>
        </div>
    </div>
</div>

</body>
</html>

