{% load static %}
{% load object_filters %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ object.nazvanie }} - AI-ZAM</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="/static/js/salary-data.js"></script>
    <style>

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            padding: 12px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        .page-title {
            text-align: center;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin: 12px;
        }
        
        .page-title h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .page-title p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 12px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .header h1 {
            font-size: 20px;
            margin-bottom: 3px;
        }
        
        .header p {
            opacity: 0.8;
            font-size: 13px;
            margin-bottom: 8px;
        }
        
        .header-info {
            margin-top: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .info-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 12px;
        }
        
        .info-item strong {
            color: #ecf0f1;
        }
        
        .table-container {
            padding: 0;
            overflow-x: auto;
            overflow-y: visible;
            max-width: 100vw;
            -webkit-overflow-scrolling: touch;
        }
        
        .resource-table {
            width: auto;
            min-width: 2000px;
            border-collapse: collapse;
            margin-bottom: 12px;
            white-space: nowrap;
            table-layout: fixed;
        }
        
        .resource-table th {
            background: #34495e;
            color: white;
            padding: 8px 6px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #2c3e50;
            position: sticky;
            top: 0;
            font-size: 12px;
        }
        
        .resource-table td {
            padding: 6px;
            border: 1px solid #ddd;
            background: white;
            font-size: 12px;
        }
        
        .resource-table .number {
            text-align: right;
        }
        
        .main-header td {
            background: #1a2530 !important;
            color: white !important;
            font-weight: bold;
            text-align: center;
            padding: 8px 6px;
            font-size: 1.7em;
        }
        
        .category-header td {
            background: #3498db !important;
            color: white !important;
            font-weight: bold;
            text-align: left;
            padding: 6px;
            font-size: 13px;
        }
        
        .category-–∫–∞–¥—Ä—ã td { background: #e8f4fd; }
        .category-–º–∞—à–∏–Ω—ã td { background: #fff3cd; }
        .category-–º–∞—Ç–µ—Ä–∏–∞–ª—ã td { background: #d4edda; }
        .category-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ td { background: #f8d7da; }
        .category-—Å–∏–∑ td { background: #e2e3e5; }
        .category-–ø–æ–¥—Ä—è–¥–Ω—ã–µ td { background: #d1ecf1; }
        
        .total-row td {
            background: #2c3e50 !important;
            color: white !important;
            font-weight: bold;
            font-size: 12px;
        }
        
        .back-btn {
            position: fixed;
            top: 12px;
            left: 12px;
            z-index: 1000;
            display: inline-block;
            padding: 6px 12px;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 3px;
            transition: background 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 12px;
        }
        
        .back-btn:hover {
            background: #2980b9;
        }
        
        .edit-btn {
            position: fixed;
            top: 12px;
            right: 12px;
            z-index: 1000;
            display: inline-block;
            padding: 6px 12px;
            background: #e74c3c;
            color: white;
            text-decoration: none;
            border-radius: 3px;
            transition: background 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 12px;
        }
        
        .edit-btn:hover {
            background: #c0392b;
        }
        
        .bold {
            font-weight: bold;
        }
        
        .editable-cell {
            cursor: pointer;
            background-color: #f8f9fa;
        }
        
        .editable-cell:hover {
            background-color: #e9ecef;
        }
        
        .editing {
            background-color: #fff3cd !important;
        }
        
        .main-action-btns {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 20px 0 20px 0;
        }

    </style>
</head>
<body> 
    
    <div class="container">
        <div class="header">
            <h1>{{ object.nazvanie }} (—Å–º–µ—Ç–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø–æ –æ–±—ä–µ–∫—Ç—É) </h1>
          
            <div class="header-info">
                <div class="info-item">
                    <strong>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:</strong> 
                    {% if object.otvetstvennyj %}
                        {{ object.otvetstvennyj.fio }}
                    {% else %}
                        –ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω
                    {% endif %}
                </div>
                <div class="info-item">
                    <strong>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</strong> {{ object.data_nachala|date:"d.m.Y" }}
                </div>
                <div class="info-item">
                    <strong>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ä–µ—Å—É—Ä—Å–æ–≤:</strong> {{ total_cost|floatformat:0 }} ‚ÇΩ
                </div>
            </div>
            <!-- –î–≤–µ –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ header-info -->
            <div class="main-action-btns">
                {% if '/income/' in request.path %}
                    <a href="/objects/{{ object.id }}/" style="background: #3498db !important; color: white !important; padding: 12px 32px; font-size: 1.1em; font-weight: bold; border-radius: 6px; text-decoration: none; display: inline-block;">üí∞ –†–∞—Å—Ö–æ–¥–Ω–∞—è —á–∞—Å—Ç—å</a>
                    <a href="/objects/{{ object.id }}/income/" style="background: #27ae60 !important; border: 4px solid #f39c12 !important; transform: scale(1.08) !important; color: white !important; padding: 12px 32px; font-size: 1.1em; font-weight: bold; border-radius: 6px; text-decoration: none; display: inline-block;">üíµ –î–æ—Ö–æ–¥–Ω–∞—è —á–∞—Å—Ç—å</a>
                {% else %}
                    <a href="/objects/{{ object.id }}/" style="background: #27ae60 !important; border: 4px solid #f39c12 !important; transform: scale(1.08) !important; color: white !important; padding: 12px 32px; font-size: 1.1em; font-weight: bold; border-radius: 6px; text-decoration: none; display: inline-block;">üí∞ –†–∞—Å—Ö–æ–¥–Ω–∞—è —á–∞—Å—Ç—å</a>
                    <a href="/objects/{{ object.id }}/income/" style="background: #3498db !important; color: white !important; padding: 12px 32px; font-size: 1.1em; font-weight: bold; border-radius: 6px; text-decoration: none; display: inline-block;">üíµ –î–æ—Ö–æ–¥–Ω–∞—è —á–∞—Å—Ç—å</a>
                {% endif %}
            </div>
            

        </div>
        
        <div class="table-container">
            <table class="resource-table">
                <thead>
                    <tr>
                        <th style="width: 5%;">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                        <th style="width: 2%;">–ï–¥.<br>–∏–∑–º</th>
                        <th style="width: 3%;">–ó–∞—Ä–µ–∑.<br>–ª–∏–º–∏—Ç–æ–≤</th>
                        <th style="width: 3%;">–ó–∞–ø–ª–∞–Ω.<br>—Ü–µ–Ω–∞</th>
                        <th style="width: 3%;">–°—É–º–º–∞</th>
                        <th style="width: 2%;">–ü–æ—Ç—Ä–∞—á.<br>–ª–∏–º–∏—Ç–æ–≤</th>
                        <th style="width: 2%;">–û—Å—Ç–∞–ª.<br>–ª–∏–º–∏—Ç–æ–≤</th>
                        {% for day in days %}
                        <th style="width: 3%;">{{ day|date:"d.m" }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    <tr class="main-header">
                        {% if '/income/' in request.path %}
                            <td colspan="7">–ü–ª–∞–Ω–∏—Ä—É–µ–º—ã–µ –¥–æ—Ö–æ–¥—ã</td>
                            <td colspan="{{ days|length }}">–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –¥–æ—Ö–æ–¥—ã</td>
                        {% else %}
                            <td colspan="7">–ü–ª–∞–Ω–∏—Ä—É–µ–º—ã–µ —Ä–∞—Å—Ö–æ–¥—ã</td>
                            <td colspan="{{ days|length }}">–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∞—Å—Ö–æ–¥—ã</td>
                        {% endif %}
                    </tr>
                    
                    {% for category_name, category_resources in grouped_resources.items %}
                    {% if category_name|lower != '–ø–æ–¥—Ä—è–¥–Ω—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏' %}
                    <tr class="category-header">
                        <td colspan="{{ 7|add:days|length }}">
                            {{ category_name|upper }}
                            {% for category in categories %}
                                {% if category.nazvanie == category_name %}
                                    <button onclick="addResourceToCategory({{ category.id }})" 
                                            style="float: right; background: #27ae60; color: white; border: none; border-radius: 3px; padding: 4px 8px; cursor: pointer; font-size: 12px; margin-left: 10px;">+</button>
                                {% endif %}
                            {% endfor %}
                        </td>
                    </tr>
                    
                    {% for resource in category_resources %}
                    <tr class="category-{{ category.grouper|lower }}">
                        <td>
                            {{ resource.resurs.naimenovanie }}
                            <button onclick="deleteResource({{ resource.id }})" 
                                    style="float: right; background: #e74c3c; color: white; border: none; border-radius: 50%; padding: 2px 6px; cursor: pointer; font-size: 12px; width: 20px; height: 20px; display: inline-flex; align-items: center; justify-content: center; margin-left: 10px;" 
                                    title="–£–¥–∞–ª–∏—Ç—å —Ä–µ—Å—É—Ä—Å">‚àí</button>
                        </td>
                        <td>{{ resource.resurs.edinica_izmereniya }}</td>
                        <td class="number editable-cell" 
                            data-resource-id="{{ resource.id }}" 
                            data-field-type="kolichestvo"
                            onclick="editResourceCell(this)">{{ resource.kolichestvo|floatformat:0 }}</td>
                        <td class="number editable-cell" 
                            data-resource-id="{{ resource.id }}" 
                            data-field-type="cena"
                            onclick="editResourceCell(this)">{{ resource.cena|floatformat:0 }}</td>
                        <td class="number sum-cell" 
                            data-resource-id="{{ resource.id }}">{{ resource.kolichestvo|multiply:resource.cena|floatformat:0 }}</td>
                        
                        <td class="number">{{ resource.potracheno|floatformat:0 }}</td>
                        <td class="number ostatok-cell" 
                            data-resource-id="{{ resource.id }}">{{ resource.kolichestvo|subtract:resource.potracheno|floatformat:0 }}</td>
                        
                        {% for day in days %}
                            <td class="number {% if resource.resurs.kategoriya_resursa.nazvanie|lower != '–∫–∞–¥—Ä–æ–≤–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ' %}editable-cell{% endif %}" 
                                data-resource-id="{{ resource.id }}" 
                                data-date="{{ day|date:'Y-m-d' }}" 
                                {% if resource.resurs.kategoriya_resursa.nazvanie|lower != '–∫–∞–¥—Ä–æ–≤–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ' %}onclick="editCell(this)"{% endif %}>
                            {% with day_value=0 %}
                                {% for fr in fakticheskij_resursy %}
                                    {% if fr.resurs_po_objektu.id == resource.id %}
                                        {% for rashod in raskhody|get_item:fr.id %}
                                            {% if rashod.data|date:"Y-m-d" == day|date:"Y-m-d" %}
                                                {% if resource.resurs.kategoriya_resursa.nazvanie|lower == '–∫–∞–¥—Ä–æ–≤–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ' %}
                                                    {% if rashod.izraskhodovano|floatformat:0 != '0' %}
                                                        {{ rashod.izraskhodovano|floatformat:0 }}
                                                    {% endif %}
                                                {% else %}
                                                    {{ rashod.izraskhodovano|floatformat:0 }}
                                                {% endif %}
                                                {% with day_value=1 %}{% endwith %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                {% endfor %}
                                <!-- {% if day_value == 0 and resource.resurs.kategoriya_resursa.nazvanie|lower != '–∫–∞–¥—Ä–æ–≤–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ' %}0{% endif %} -->
                            {% endwith %}
                            </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                    
                    <tr class="total-row">
                        <td colspan="4">–ò–¢–û–ì–û:</td>
                        <td class="number category-total">{{ category_name|get_category_sum:resources|floatformat:0 }}</td>
                        <td class="number category-potracheno">0</td>
                        <td></td>
                        {% for day in days %}
                        <td class="number category-daily-total">
                        {% with category_totals=category_daily_totals|get_item:category_name %}
                            {% with day_key=day|date:'Y-m-d' %}
                                {{ category_totals|get_item:day_key|floatformat:0 }}
                            {% endwith %}
                        {% endwith %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endif %}
                    {% endfor %}
                    
                    <tr class="total-row">
                        <td colspan="4">–ò—Ç–æ–≥–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –¥–Ω—è–º:</td>
                        <td class="number total-sum-cell">{{ total_cost|floatformat:0 }}</td>
                        <td class="number"></td>
                        <td class="number"></td>
                        {% for day in days %}
                        <td class="number total-daily-total">
                        {% with day_key=day|date:'Y-m-d' %}
                            {{ total_daily_expenses|get_item:day_key|floatformat:0 }}
                        {% endwith %}
                        </td>
                        {% endfor %}
                    </tr>
                </tbody>
            </table>
        </div>
        
    </div>
    
    <a href="/objects/" class="back-btn">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –æ–±—ä–µ–∫—Ç–æ–≤</a>
    <a href="/objects/{{ object.id }}/edit/" class="edit-btn">‚úé –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
    
    <script>
    function formatNumber(num, isKadry = false) {
        if (num === null || num === undefined || isNaN(num)) {
            return isKadry ? '' : '0';
        }
        
        // –ï—Å–ª–∏ —ç—Ç–æ –∫–∞–¥—Ä–æ–≤–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –∏ –∑–Ω–∞—á–µ–Ω–∏–µ —Ä–∞–≤–Ω–æ 0, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
        if (isKadry && num === 0) {
            return '';
        }
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    }
    
    function updateTotalDailyExpenses() {
        console.log('updateTotalDailyExpenses called');
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∏—Ç–æ–≥–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        const categoryTotalRows = document.querySelectorAll('.total-row');
        const daysCount = document.querySelectorAll('th[style*="width: 3%"]').length;
        console.log('Days count:', daysCount);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ –¥–ª—è –∏—Ç–æ–≥–æ–≤—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –¥–Ω—è–º
        const totalDailyExpenses = new Array(daysCount).fill(0);
        let totalSum = 0;
        
        // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –∏—Ç–æ–≥–æ–≤—ã–º —Å—Ç—Ä–æ–∫–∞–º –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π)
        for (let i = 0; i < categoryTotalRows.length - 1; i++) {
            const row = categoryTotalRows[i];
            const dailyCells = row.querySelectorAll('.category-daily-total');
            
            // –°—É–º–º–∏—Ä—É–µ–º –¥–Ω–µ–≤–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            dailyCells.forEach((cell, dayIndex) => {
                const cellValue = parseFloat(cell.textContent.trim().replace(/\s/g, '')) || 0;
                totalDailyExpenses[dayIndex] += cellValue;
                console.log(`Day ${dayIndex + 1}: added ${cellValue}, total now: ${totalDailyExpenses[dayIndex]}`);
            });
            
            // –°—É–º–º–∏—Ä—É–µ–º –æ–±—â—É—é —Å—É–º–º—É –∏–∑ —è—á–µ–π–∫–∏ "–ò–¢–û–ì–û"
            const categoryTotalCell = row.querySelector('.category-total');
            if (categoryTotalCell) {
                const categorySum = parseFloat(categoryTotalCell.textContent.trim().replace(/\s/g, '')) || 0;
                totalSum += categorySum;
            }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç—Ä–æ–∫—É
        const lastTotalRow = categoryTotalRows[categoryTotalRows.length - 1];
        if (lastTotalRow) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —è—á–µ–π–∫—É "–°—É–º–º–∞" –≤ –∏—Ç–æ–≥–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ
            const totalSumCell = lastTotalRow.querySelector('.total-sum-cell');
            if (totalSumCell) {
                totalSumCell.textContent = formatNumber(Math.round(totalSum));
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–Ω–µ–≤–Ω—ã–µ –∏—Ç–æ–≥–∏
            const totalDailyCells = lastTotalRow.querySelectorAll('.total-daily-total');
            totalDailyCells.forEach((cell, dayIndex) => {
                const formattedValue = formatNumber(Math.round(totalDailyExpenses[dayIndex]));
                console.log(`Setting day ${dayIndex + 1} total to:`, formattedValue);
                cell.textContent = formattedValue;
            });
        }
        console.log('updateTotalDailyExpenses completed');
    }
    
    function editCell(cell) {
        if (cell.classList.contains('editing')) return;
        
        try {
            let currentValue = cell.textContent.trim().replace(/\s/g, '');
            console.log('Current value:', currentValue);
            
            // –ï—Å–ª–∏ —è—á–µ–π–∫–∞ –ø—É—Å—Ç–∞—è –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–æ–±–µ–ª—ã, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º 0
            if (!currentValue || currentValue === '') {
                currentValue = '0';
            }
            
            const input = document.createElement('input');
            input.type = 'number';
            input.value = currentValue;
            input.style.width = '100px';
            input.style.height = '25px';
            input.style.border = '2px solid #007bff';
            input.style.background = 'white';
            input.style.textAlign = 'right';
            input.style.fontSize = '12px';
            input.style.padding = '4px';
            input.style.borderRadius = '4px';
            
            cell.innerHTML = '';
            cell.appendChild(input);
            cell.classList.add('editing');
            input.focus();
            input.select();
            
            function saveValue() {
                try {
                    const newValue = input.value || '0';
                    console.log('New value:', newValue);
                    
                    cell.textContent = formatNumber(parseFloat(newValue));
                    cell.classList.remove('editing');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
                    updateAllTotals();
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                    const resourceId = cell.dataset.resourceId;
                    const date = cell.dataset.date;
                    
                    console.log('Sending data:', { resource_id: resourceId, date: date, amount: newValue });
                    
                    fetch('/objects/update-expense/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({
                            resource_id: resourceId,
                            date: date,
                            amount: parseFloat(newValue) || 0
                        })
                    })
                    .then(response => {
                        console.log('Response status:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('Response data:', data);
                        if (data.success) {
                            // –û–±–Ω–æ–≤–ª—è–µ–º —è—á–µ–π–∫–∏ –ü–æ—Ç—Ä–∞—á–µ–Ω–æ –∏ –û—Å—Ç–∞–ª–æ—Å—å
                            const row = cell.closest('tr');
                            console.log('Found row:', row);
                            
                            const cells = row.querySelectorAll('td');
                            console.log('Cells count:', cells.length);
                            console.log('Cells[5] (–ü–æ—Ç—Ä–∞—á–µ–Ω–æ):', cells[5]);
                            console.log('Cells[6] (–û—Å—Ç–∞–ª–æ—Å—å):', cells[6]);
                            
                            if (cells[5]) {
                                const potrachenoFormatted = formatNumber(Math.round(data.potracheno));
                                console.log('Setting –ü–æ—Ç—Ä–∞—á–µ–Ω–æ to:', potrachenoFormatted);
                                cells[5].textContent = potrachenoFormatted;
                            }
                            
                            if (cells[6]) {
                                const ostatokFormatted = formatNumber(Math.round(data.ostatok));
                                console.log('Setting –û—Å—Ç–∞–ª–æ—Å—å to:', ostatokFormatted);
                                cells[6].textContent = ostatokFormatted;
                            }
                            
                            console.log('Updating totals...');
                            // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—ã–µ —Å—É–º–º—ã
                            updateAllTotals();
                            console.log('Totals updated successfully');
                        } else {
                            console.error('Server returned error:', data.error);
                            let errorMessage = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏';
                            if (data.error && data.error.includes('database is locked')) {
                                errorMessage = '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.';
                            } else if (data.error) {
                                errorMessage += ': ' + data.error;
                            }
                            alert(errorMessage);
                        }
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                        let errorMessage = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö';
                        if (error.message.includes('Failed to fetch')) {
                            errorMessage = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.';
                        } else {
                            errorMessage += ': ' + error.message;
                        }
                        alert(errorMessage);
                    });
                } catch (error) {
                    console.error('Save value error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + error.message);
                }
            }
            
            input.addEventListener('blur', saveValue);
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveValue();
                }
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ –≤–≤–æ–¥–µ
            input.addEventListener('input', function() {
                const newValue = input.value || '0';
                const row = cell.closest('tr');
                const cells = row.querySelectorAll('td');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —è—á–µ–π–∫—É –û—Å—Ç–∞–ª–æ—Å—å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
                // –Ø—á–µ–π–∫–∞ –ü–æ—Ç—Ä–∞—á–µ–Ω–æ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —Å–µ—Ä–≤–µ—Ä–æ–º
                const kolichestvo = parseFloat(cells[2].textContent.trim().replace(/\s/g, '')) || 0;
                const currentPotracheno = parseFloat(cells[5].textContent.trim().replace(/\s/g, '')) || 0;
                const ostatok = kolichestvo - currentPotracheno;
                
                if (cells[6]) {
                    cells[6].textContent = formatNumber(Math.round(ostatok));
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
                updateAllTotals();
            });
        } catch (error) {
            console.error('Edit cell error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —è—á–µ–π–∫–∏: ' + error.message);
        }
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function editResourceCell(cell) {
        if (cell.classList.contains('editing')) return;
        
        const currentValue = cell.textContent.trim().replace(/\s/g, '');
        const input = document.createElement('input');
        input.type = 'number';
        input.value = currentValue;
        input.style.width = '100px';
        input.style.height = '25px';
        input.style.border = '2px solid #28a745';
        input.style.background = 'white';
        input.style.textAlign = 'right';
        input.style.fontSize = '12px';
        input.style.padding = '4px';
        input.style.borderRadius = '4px';
        
        cell.innerHTML = '';
        cell.appendChild(input);
        cell.classList.add('editing');
        input.focus();
        input.select();
        
        function saveResourceValue() {
            const newValue = input.value || '0';
            cell.textContent = formatNumber(parseFloat(newValue));
            cell.classList.remove('editing');
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Å—Ç—Ä–æ–∫–∏
            const row = cell.closest('tr');
            const cells = row.querySelectorAll('td');
            
            // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏ —Ü–µ–Ω—ã
            let kolichestvo = parseFloat(cells[2].textContent.trim().replace(/\s/g, '')) || 0;
            let cena = parseFloat(cells[3].textContent.trim().replace(/\s/g, '')) || 0;
            
            // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–ª–∏ —Ü–µ–Ω—É, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            const fieldType = cell.dataset.fieldType;
            if (fieldType === 'kolichestvo') {
                kolichestvo = parseFloat(newValue) || 0;
            } else if (fieldType === 'cena') {
                cena = parseFloat(newValue) || 0;
            }
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—É–º–º—É –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
            const newSum = parseFloat(kolichestvo) * parseFloat(cena);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —è—á–µ–π–∫—É —Å—É–º–º—ã –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É
            const sumCell = row.querySelector('.sum-cell');
            if (sumCell) {
                sumCell.textContent = formatNumber(Math.round(newSum));
            }
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –æ—Å—Ç–∞—Ç–æ–∫
            const potracheno = parseFloat(cells[5].textContent.trim().replace(/\s/g, '')) || 0;
            const ostatok = parseFloat(kolichestvo) - parseFloat(potracheno);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —è—á–µ–π–∫—É –æ—Å—Ç–∞—Ç–∫–∞ –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É
            const ostatokCell = row.querySelector('.ostatok-cell');
            if (ostatokCell) {
                ostatokCell.textContent = formatNumber(Math.round(ostatok));
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
            updateAllTotals();
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            const resourceId = cell.dataset.resourceId;
            
            fetch('/objects/update-resource-data/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    resource_id: resourceId,
                    field_type: fieldType,
                    value: parseFloat(newValue) || 0
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—ã–µ —Å—É–º–º—ã
                    updateAllTotals();
                } else {
                    console.error('Server returned error:', data.error);
                    let errorMessage = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏';
                    if (data.error && data.error.includes('database is locked')) {
                        errorMessage = '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.';
                    } else if (data.error) {
                        errorMessage += ': ' + data.error;
                    }
                    alert(errorMessage);
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                let errorMessage = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö';
                if (error.message.includes('Failed to fetch')) {
                    errorMessage = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.';
                } else {
                    errorMessage += ': ' + error.message;
                }
                alert(errorMessage);
            });
        }
        
        input.addEventListener('blur', saveResourceValue);
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                saveResourceValue();
            }
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ –≤–≤–æ–¥–µ
        input.addEventListener('input', function() {
            const newValue = input.value || '0';
            const row = cell.closest('tr');
            const cells = row.querySelectorAll('td');
            
            // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏ —Ü–µ–Ω—ã
            let kolichestvo = parseFloat(cells[2].textContent.trim().replace(/\s/g, '')) || 0;
            let cena = parseFloat(cells[3].textContent.trim().replace(/\s/g, '')) || 0;
            
            // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–ª–∏ —Ü–µ–Ω—É, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            const fieldType = cell.dataset.fieldType;
            if (fieldType === 'kolichestvo') {
                kolichestvo = parseFloat(newValue) || 0;
            } else if (fieldType === 'cena') {
                cena = parseFloat(newValue) || 0;
            }
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—É–º–º—É –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
            const newSum = parseFloat(kolichestvo) * parseFloat(cena);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —è—á–µ–π–∫—É —Å—É–º–º—ã –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É
            const sumCell = row.querySelector('.sum-cell');
            if (sumCell) {
                sumCell.textContent = formatNumber(Math.round(newSum));
            }
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –æ—Å—Ç–∞—Ç–æ–∫
            const potracheno = parseFloat(cells[5].textContent.trim().replace(/\s/g, '')) || 0;
            const ostatok = parseFloat(kolichestvo) - parseFloat(potracheno);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —è—á–µ–π–∫—É –æ—Å—Ç–∞—Ç–∫–∞ –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É
            const ostatokCell = row.querySelector('.ostatok-cell');
            if (ostatokCell) {
                ostatokCell.textContent = formatNumber(Math.round(ostatok));
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
            updateAllTotals();
        });
    }
    
    function updateHeaderTotal() {
        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ä–µ—Å—É—Ä—Å–æ–≤ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
        let totalCost = 0;
        const sumCells = document.querySelectorAll('.sum-cell');
        
        sumCells.forEach(cell => {
            totalCost += parseFloat(cell.textContent.trim().replace(/\s/g, '')) || 0;
        });
        
        // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç —Å –æ–±—â–µ–π —Å—Ç–æ–∏–º–æ—Å—Ç—å—é –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
        const headerInfo = document.querySelector('.header-info');
        if (headerInfo) {
            const totalCostElement = headerInfo.querySelector('.info-item:last-child');
            if (totalCostElement) {
                const strongElement = totalCostElement.querySelector('strong');
                if (strongElement) {
                    totalCostElement.innerHTML = `<strong>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ä–µ—Å—É—Ä—Å–æ–≤:</strong> ${formatNumber(Math.round(totalCost))} ‚ÇΩ`;
                }
            }
        }
    }
    
    function updateCategoryTotals() {
        console.log('updateCategoryTotals called');
        
        // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∏—Ç–æ–≥–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        const categoryTotalRows = document.querySelectorAll('.total-row');
        console.log('Found total rows:', categoryTotalRows.length);
        
        // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –∫–∞–∂–¥–æ–π –∏—Ç–æ–≥–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ–±—â–µ–π)
        for (let i = 0; i < categoryTotalRows.length - 1; i++) {
            const totalRow = categoryTotalRows[i];
            console.log(`Processing total row ${i + 1}`);
            
            // –ù–∞—Ö–æ–¥–∏–º –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å—Ç—Ä–æ–∫—É –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            let categoryHeader = totalRow.previousElementSibling;
            while (categoryHeader && !categoryHeader.classList.contains('category-header')) {
                categoryHeader = categoryHeader.previousElementSibling;
            }
            
            if (!categoryHeader) {
                console.log('Category header not found for total row', i + 1);
                continue;
            }
            
            console.log('Found category header:', categoryHeader);
            
            // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            const categoryName = categoryHeader.querySelector('td')?.textContent || 'Unknown';
            console.log('Category name:', categoryName);
            
            // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            let categorySum = 0;
            let currentRow = categoryHeader.nextElementSibling;
            const categoryDailyTotals = new Array(20).fill(0); // 20 –¥–Ω–µ–π
            let resourceCount = 0;
            
            // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —Å—Ç—Ä–æ–∫–∞–º —Ä–µ—Å—É—Ä—Å–æ–≤ –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            while (currentRow && !currentRow.classList.contains('total-row') && !currentRow.classList.contains('category-header')) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞ —Ä–µ—Å—É—Ä—Å–∞ (–∏–º–µ–µ—Ç –∫–ª–∞—Å—Å, –Ω–∞—á–∏–Ω–∞—é—â–∏–π—Å—è —Å 'category-')
                const classList = Array.from(currentRow.classList);
                const isResourceRow = classList.some(cls => cls.startsWith('category-'));
                
                console.log('Checking row with classes:', classList, 'isResourceRow:', isResourceRow);
                
                if (isResourceRow) {
                    resourceCount++;
                    console.log(`Processing resource ${resourceCount} in category ${categoryName}, classes:`, classList);
                    
                    // –°—É–º–º–∏—Ä—É–µ–º –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ä–µ—Å—É—Ä—Å–∞
                    const sumCell = currentRow.querySelector('.sum-cell');
                    if (sumCell) {
                        const cellValue = parseFloat(sumCell.textContent.trim().replace(/\s/g, '')) || 0;
                        categorySum += cellValue;
                        console.log('Added to category sum:', cellValue, 'from cell text:', sumCell.textContent);
                    } else {
                        console.log('Sum cell not found for resource');
                    }
                    
                    // –°—É–º–º–∏—Ä—É–µ–º –¥–Ω–µ–≤–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã
                    const cells = currentRow.querySelectorAll('td');
                    const cena = parseFloat(cells[3].textContent.trim().replace(/\s/g, '')) || 0;
                    
                    for (let j = 7; j < cells.length; j++) {
                        const dayIndex = j - 7;
                        const dayValue = parseFloat(cells[j].textContent.trim().replace(/\s/g, '')) || 0;
                        categoryDailyTotals[dayIndex] += cena * dayValue;
                    }
                }
                currentRow = currentRow.nextElementSibling;
            }
            
            console.log(`Category ${categoryName}: found ${resourceCount} resources, total sum: ${categorySum}`);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é —Å—É–º–º—É –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            const totalCell = totalRow.querySelector('.category-total');
            if (totalCell) {
                const formattedSum = formatNumber(Math.round(categorySum));
                console.log(`Setting category total to:`, formattedSum);
                totalCell.textContent = formattedSum;
            }
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥ –¥–ª—è —Å—Ç–æ–ª–±—Ü–∞ "–ü–æ—Ç—Ä–∞—á.–ª–∏–º–∏—Ç–æ–≤" –ø–æ —Ñ–æ—Ä–º—É–ª–µ: Œ£ –ü–æ—Ç—Ä–∞—á.–ª–∏–º–∏—Ç–æ–≤ * –ó–∞–ø–ª–∞–Ω.—Ü–µ–Ω–∞
            let categoryPotracheno = 0;
            currentRow = categoryHeader.nextElementSibling;
            
            while (currentRow && !currentRow.classList.contains('total-row') && !currentRow.classList.contains('category-header')) {
                const classList = Array.from(currentRow.classList);
                const isResourceRow = classList.some(cls => cls.startsWith('category-'));
                
                if (isResourceRow) {
                    const cells = currentRow.querySelectorAll('td');
                    const potracheno = parseFloat(cells[5].textContent.trim().replace(/\s/g, '')) || 0; // –ü–æ—Ç—Ä–∞—á.–ª–∏–º–∏—Ç–æ–≤
                    const cena = parseFloat(cells[3].textContent.trim().replace(/\s/g, '')) || 0; // –ó–∞–ø–ª–∞–Ω.—Ü–µ–Ω–∞
                    categoryPotracheno += potracheno * cena;
                }
                currentRow = currentRow.nextElementSibling;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —è—á–µ–π–∫—É –∏—Ç–æ–≥–∞ –¥–ª—è "–ü–æ—Ç—Ä–∞—á.–ª–∏–º–∏—Ç–æ–≤"
            const potrachenoCell = totalRow.querySelector('.category-potracheno');
            if (potrachenoCell) {
                potrachenoCell.textContent = formatNumber(Math.round(categoryPotracheno));
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–Ω–µ–≤–Ω—ã–µ –∏—Ç–æ–≥–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            const dailyTotalCells = totalRow.querySelectorAll('.category-daily-total');
            dailyTotalCells.forEach((cell, dayIndex) => {
                if (categoryDailyTotals[dayIndex] !== undefined) {
                    const formattedValue = formatNumber(Math.round(categoryDailyTotals[dayIndex]));
                    console.log(`Setting day ${dayIndex + 1} category total to:`, formattedValue);
                    cell.textContent = formattedValue;
                }
            });
        }
        
        console.log('updateCategoryTotals completed');
    }
    
    function updateTotalSum() {
        console.log('updateTotalSum called');
        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â—É—é —Å—É–º–º—É –ø–æ –æ–±—ä–µ–∫—Ç—É
        let totalSum = 0;
        const sumCells = document.querySelectorAll('.sum-cell');
        console.log('Found sum cells:', sumCells.length);
        
        sumCells.forEach(cell => {
            const cellValue = parseFloat(cell.textContent.trim().replace(/\s/g, '')) || 0;
            totalSum += cellValue;
            console.log('Added to total sum:', cellValue);
        });
        
        console.log('Total sum:', totalSum);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é —Å—É–º–º—É –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–æ–∫–µ
        const totalRows = document.querySelectorAll('.total-row');
        console.log('Found total rows:', totalRows.length);
        const lastTotalRow = totalRows[totalRows.length - 1];
        if (lastTotalRow) {
            // –ù–ï –æ–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–æ–∫–∏, –æ—Å—Ç–∞–≤–ª—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç
            // const headerCell = lastTotalRow.querySelector('td:first-child');
            // if (headerCell) {
            //     headerCell.textContent = `–ò–¢–û–ì–û: ${formatNumber(Math.round(totalSum))} ‚ÇΩ`;
            // }
        }
        console.log('updateTotalSum completed');
    }
    
    function updateAllTotals() {
        console.log('updateAllTotals called');
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –∏—Ç–æ–≥–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        updateCategoryTotals();
        updateTotalSum();
        updateTotalDailyExpenses();
        updateHeaderTotal();
        console.log('updateAllTotals completed');
    }
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Å–µ —á–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        const numberCells = document.querySelectorAll('.number');
        
        numberCells.forEach((cell, index) => {
            const text = cell.textContent.trim();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ —è—á–µ–π–∫–∞ –∫ –∫–∞–¥—Ä–æ–≤–æ–º—É –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—é
            const isKadry = cell.closest('tr') && 
                          cell.closest('tr').classList && 
                          Array.from(cell.closest('tr').classList).some(cls => cls === 'category-–∫–∞–¥—Ä—ã');
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Å–µ —á–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            if (text && !isNaN(parseFloat(text))) {
                const num = parseFloat(text);
                
                // –ï—Å–ª–∏ —ç—Ç–æ –∫–∞–¥—Ä–æ–≤–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –∏ –∑–Ω–∞—á–µ–Ω–∏–µ —Ä–∞–≤–Ω–æ 0, –æ—á–∏—â–∞–µ–º —è—á–µ–π–∫—É
                if (isKadry && num === 0) {
                    cell.textContent = '';
                } else {
                    const formatted = formatNumber(num);
                    cell.textContent = formatted;
                }
            }
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –∏—Ç–æ–≥–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        updateAllTotals();
    });
    
    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
    function showAddCategoryModal() {
        const modal = document.getElementById('categoryModal');
        modal.style.display = 'block';
    }
    
    function showAddResourceModal() {
        const modal = document.getElementById('resourceModal');
        modal.style.display = 'block';
    }
    
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }
    
    function addExistingCategory() {
        const categoryId = document.getElementById('existingCategory').value;
        if (!categoryId) return;
        
        fetch('/add-category-to-object/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                category_id: categoryId,
                object_id: {{ object.id }}
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    }
    
    function addNewCategory() {
        const name = document.getElementById('categoryName').value;
        if (!name) return;
        
        fetch('/add-category/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                name: name
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–∑–¥–∞–Ω–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∫ –æ–±—ä–µ–∫—Ç—É
                return fetch('/add-category-to-object/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        category_id: data.id,
                        object_id: {{ object.id }}
                    })
                });
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    }
    
    function addResource() {
        const name = document.getElementById('resourceName').value;
        const unit = document.getElementById('resourceUnit').value;
        const categoryId = document.getElementById('resourceCategory').value;
        
        if (!name || !categoryId) return;
        
        fetch('/add-resource/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                name: name,
                unit: unit,
                category_id: categoryId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    }
    
    function addResourceToCategory(categoryId) {
        const modal = document.getElementById('resourceModal');
        const resourceSelect = document.getElementById('resourceSelect');
        
        // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ä–µ—Å—É—Ä—Å–æ–≤
        resourceSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Å—É—Ä—Å</option>';
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ—Å—É—Ä—Å—ã –¥–ª—è —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        fetch(`/get-resources-by-category/${categoryId}/`)
            .then(response => response.json())
            .then(data => {
                data.resources.forEach(resource => {
                    const option = document.createElement('option');
                    option.value = resource.id;
                    option.textContent = `${resource.naimenovanie} (${resource.edinica_izmereniya})`;
                    resourceSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading resources:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤');
            });
        
        modal.style.display = 'block';
    }
    
    function addResourceToObject() {
        const resourceId = document.getElementById('resourceSelect').value;
        const quantity = document.getElementById('resourceQuantity').value;
        const price = document.getElementById('resourcePrice').value;
        
        if (!resourceId || !quantity || !price) {
            alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
            return;
        }
        
        fetch('/add-resource-to-object/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                object_id: {{ object.id }},
                resource_id: resourceId,
                quantity: parseFloat(quantity),
                price: parseFloat(price)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        })
        .catch(error => {
            alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message);
        });
    }
    
    function deleteResource(resourceId) {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ä–µ—Å—É—Ä—Å?')) {
            fetch('/delete-resource-from-object/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    resource_id: resourceId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            })
            .catch(error => {
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message);
            });
        }
    }
    </script>
<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
<div id="categoryModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div style="background-color: #2c3e50; margin: 10% auto; padding: 20px; border-radius: 8px; width: 500px; color: white;">
        <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–µ—Å—É—Ä—Å–æ–≤</h3>
        
        <div style="margin-bottom: 20px;">
            <h4>–í—ã–±—Ä–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é:</h4>
            <select id="existingCategory" style="width: 100%; padding: 8px; margin: 5px 0; border: none; border-radius: 4px;">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                {% for category in categories %}
                <option value="{{ category.id }}">{{ category.nazvanie }}</option>
                {% endfor %}
            </select>
            <button onclick="addExistingCategory()" style="background: #3498db; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-top: 5px;">–î–æ–±–∞–≤–∏—Ç—å –∫ –æ–±—ä–µ–∫—Ç—É</button>
        </div>
        
        <hr style="border-color: #34495e; margin: 20px 0;">
        
        <div>
            <h4>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é:</h4>
            <input type="text" id="categoryName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" style="width: 100%; padding: 8px; margin: 5px 0; border: none; border-radius: 4px;">
            <button onclick="addNewCategory()" style="background: #27ae60; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-top: 5px;">–°–æ–∑–¥–∞—Ç—å –∏ –¥–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        
        <div style="text-align: right; margin-top: 20px;">
            <button onclick="closeModal('categoryModal')" style="background: #e74c3c; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–∞ -->
<div id="resourceModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div style="background-color: #2c3e50; margin: 10% auto; padding: 20px; border-radius: 8px; width: 500px; color: white;">
        <h3>–î–æ–±–∞–≤–∏—Ç—å —Ä–µ—Å—É—Ä—Å –∫ –æ–±—ä–µ–∫—Ç—É</h3>
        <select id="resourceSelect" style="width: 100%; padding: 8px; margin: 10px 0; border: none; border-radius: 4px;">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Å—É—Ä—Å</option>
        </select>
        <input type="number" id="resourceQuantity" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" style="width: 100%; padding: 8px; margin: 10px 0; border: none; border-radius: 4px;">
        <input type="number" id="resourcePrice" placeholder="–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É" style="width: 100%; padding: 8px; margin: 10px 0; border: none; border-radius: 4px;">
        <div style="text-align: right; margin-top: 15px;">
            <button onclick="closeModal('resourceModal')" style="background: #e74c3c; color: white; padding: 8px 16px; border: none; border-radius: 4px; margin-right: 10px; cursor: pointer;">–û—Ç–º–µ–Ω–∞</button>
            <button onclick="addResourceToObject()" style="background: #27ae60; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
    </div>
</div>

    <!-- –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–ª–∏–∫–∞ –Ω–∞ —è—á–µ–π–∫–∞—Ö "–ö–∞–¥—Ä–æ–≤–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ" -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π "–ö–∞–¥—Ä–æ–≤–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ"
        const rows = document.querySelectorAll('tr');
        
        // –ò—â–µ–º —Å—Ç—Ä–æ–∫—É —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–ö–ê–î–†–û–í–û–ï –û–ë–ï–°–ü–ï–ß–ï–ù–ò–ï"
        for (let i = 0; i < rows.length; i++) {
            const headerCell = rows[i].querySelector('td');
            if (headerCell && headerCell.textContent && headerCell.textContent.trim().toUpperCase().includes('–ö–ê–î–†–û–í–û–ï –û–ë–ï–°–ü–ï–ß–ï–ù–ò–ï')) {
                console.log('–ù–∞–π–¥–µ–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è "–ö–∞–¥—Ä–æ–≤–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ"');
                
                // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                let currentRow = rows[i].nextElementSibling;
                
                while (currentRow && 
                       !currentRow.classList.contains('category-header') && 
                       !currentRow.classList.contains('total-row')) {
                    
                    // –ü–æ–ª—É—á–∞–µ–º —è—á–µ–π–∫–∏ —Å –¥–∞—Ç–∞–º–∏ (–Ω–∞—á–∏–Ω–∞—è —Å 8-–π —è—á–µ–π–∫–∏)
                    const cells = currentRow.querySelectorAll('td');
                    if (cells.length < 7) {
                        currentRow = currentRow.nextElementSibling;
                        continue;
                    }
                    
                    const position = cells[0].textContent.trim();
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤ –∫–∞–∂–¥—É—é —è—á–µ–π–∫—É —Å –¥–∞—Ç–æ–π
                    for (let j = 7; j < cells.length; j++) {
                        const cell = cells[j];
                        
                        // –£–¥–∞–ª—è–µ–º –∫–ª–∞—Å—Å editable-cell, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å —è—á–µ–π–∫—É –Ω–µ–∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ–π
                        cell.classList.remove('editable-cell');
                        cell.removeAttribute('onclick');
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —è—á–µ–π–∫–µ
                        const cellValue = cell.textContent.trim();
                        const hasValue = cellValue && cellValue !== '0' && cellValue !== '';
                        
                        // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ —Ä–∞–≤–Ω–æ 0, –æ—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç —è—á–µ–π–∫–∏
                        if (cellValue === '0') {
                            cell.textContent = '';
                        }
                        
                        // –û—á–∏—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —è—á–µ–π–∫–∏ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                        cell.textContent = '';
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º —á–∞—Å—ã —Å–ª–µ–≤–∞ –æ—Ç –∫–Ω–æ–ø–∫–∏
                        if (hasValue) {
                            const hoursSpan = document.createElement('span');
                            hoursSpan.textContent = cellValue;
                            hoursSpan.style.marginRight = '5px';
                            hoursSpan.style.fontWeight = 'bold';
                            hoursSpan.style.color = '#27ae60';
                            cell.appendChild(hoursSpan);
                        }
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Å —Ä–∞–∑–Ω—ã–º–∏ –∏–∫–æ–Ω–∫–∞–º–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∑–Ω–∞—á–µ–Ω–∏—è
                        const btn = document.createElement('button');
                        btn.textContent = hasValue ? 'üßë‚Äçü§ù‚Äçüßë' : 'üë•';
                        btn.style.marginLeft = '5px';
                        btn.style.background = 'none';
                        btn.style.border = 'none';
                        btn.style.cursor = 'pointer';
                        btn.style.color = '#3498db';
                        btn.title = '–ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤';
                        
                        cell.appendChild(btn);
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
                        btn.addEventListener('click', function(event) {
                            event.stopPropagation();
                            
                            // –ü–æ–ª—É—á–∞–µ–º ID –æ–±—ä–µ–∫—Ç–∞ –∏–∑ URL
                            const objectId = window.location.pathname.split('/')[2];
                            
                            // –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—É –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Å—Ç–æ–ª–±—Ü–∞
                            const dayIndex = j - 7;
                            const dateHeader = document.querySelectorAll('th')[j];
                            const dateText = dateHeader ? dateHeader.textContent.trim() : '';
                            
                            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç
                            fetch(`/objects/${objectId}/debug-employees/?position=${encodeURIComponent(position)}&date=${encodeURIComponent(dateText)}`)
                                .then(response => response.json())
                                .then(data => {
                                    console.log('Debug response:', data);
                                })
                                .catch(error => {
                                    console.error('Debug error:', error);
                                });
                            
                            // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                            showRealEmployeesModal(objectId, position, dateText);
                        });
                    }
                    
                    currentRow = currentRow.nextElementSibling;
                }
                
                break;
            }
        }
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ —Ñ–∞–π–ª–∞ salary-data.js
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —á–∞—Å–æ–≤ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ —Ç–∞–±–µ–ª—å
    function saveEmployeeHours(objectId, position, dateText, modal) {
        // –ü–æ–ª—É—á–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏
        const table = modal.querySelector('table');
        if (!table) {
            alert('–û—à–∏–±–∫–∞: —Ç–∞–±–ª–∏—Ü–∞ —Å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
            return;
        }
        
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã (–∫—Ä–æ–º–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞)
        const rows = Array.from(table.querySelectorAll('tbody tr'));
        
        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞—Ö
        const employeesData = [];
        let totalHours = 0;
        
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 5) {
                const employeeId = row.dataset.employeeId || 0;
                const fio = cells[0].textContent;
                const hours = parseFloat(cells[3].textContent) || 0;
                const kpi = parseFloat(cells[4].textContent) || 1.0;
                
                totalHours += hours;
                
                employeesData.push({
                    employee_id: employeeId,
                    fio: fio,
                    hours: hours,
                    kpi: kpi
                });
            }
        });
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞—Ç—É –∏–∑ —Ñ–æ—Ä–º–∞—Ç–∞ DD.MM –≤ YYYY-MM-DD
        let dateStr = dateText;
        if (dateText && dateText.match(/^\d{2}\.\d{2}$/)) {
            const [day, month] = dateText.split('.');
            const year = new Date().getFullYear();
            dateStr = `${year}-${month}-${day}`;
        }
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        fetch(`/objects/${objectId}/save-hours/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                object_id: objectId,
                position: position,
                date: dateStr,
                employees: employeesData,
                total_hours: totalHours
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.body.removeChild(modal);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —è—á–µ–π–∫—É —Å —á–∞—Å–∞–º–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ
                updateCellWithHours(objectId, position, dateText, totalHours);
            }
        })
        .catch(error => {
            console.error('Error saving data:', error);
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —è—á–µ–π–∫–∏ —Å —á–∞—Å–∞–º–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ
    function updateCellWithHours(objectId, position, dateText, hours) {
        // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π "–ö–∞–¥—Ä–æ–≤–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ"
        const rows = document.querySelectorAll('tr');
        
        // –ò—â–µ–º —Å—Ç—Ä–æ–∫—É —Å —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–æ–ª–∂–Ω–æ—Å—Ç—å—é
        for (let i = 0; i < rows.length; i++) {
            const firstCell = rows[i].querySelector('td');
            if (firstCell && firstCell.textContent && firstCell.textContent.trim().includes(position)) {
                // –ù–∞—Ö–æ–¥–∏–º —è—á–µ–π–∫—É —Å —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–∞—Ç–æ–π
                const cells = rows[i].querySelectorAll('td');
                for (let j = 7; j < cells.length; j++) {
                    const headerCell = document.querySelectorAll('th')[j];
                    if (headerCell && headerCell.textContent.trim() === dateText) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —è—á–µ–π–∫–∏
                        cells[j].textContent = hours;
                        cells[j].style.fontWeight = 'bold';
                        cells[j].style.color = '#27ae60';
                        break;
                    }
                }
                break;
            }
        }
    }
    
    function showFixedEmployeesData(content, closeBtn, position, date) {
        // –ë–∞–∑–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø–æ –¥–æ–ª–∂–Ω–æ—Å—Ç—è–º
        const allEmployees = {
            '–í–æ–¥–∏—Ç–µ–ª—å': [
                { fio: '–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á', organizaciya: '–û–û–û "–°—Ç—Ä–æ–π–°–µ—Ä–≤–∏—Å"', specialnost: '–í–æ–¥–∏—Ç–µ–ª—å' },
                { fio: '–°–º–∏—Ä–Ω–æ–≤ –ê–ª–µ–∫—Å–µ–π –ü–µ—Ç—Ä–æ–≤–∏—á', organizaciya: '–û–û–û "–°—Ç—Ä–æ–π–°–µ—Ä–≤–∏—Å"', specialnost: '–í–æ–¥–∏—Ç–µ–ª—å' }
            ],
            '–í–æ–¥–∏—Ç–µ–ª—å —Å–∞–º–æ—Å–≤–∞–ª–∞': [
                { fio: '–ö–æ–∑–ª–æ–≤ –°–µ—Ä–≥–µ–π –ò–≤–∞–Ω–æ–≤–∏—á', organizaciya: '–û–û–û "–°—Ç—Ä–æ–π–°–µ—Ä–≤–∏—Å"', specialnost: '–í–æ–¥–∏—Ç–µ–ª—å —Å–∞–º–æ—Å–≤–∞–ª–∞' },
                { fio: '–ù–∏–∫–æ–ª–∞–µ–≤ –ê–Ω–¥—Ä–µ–π –í–ª–∞–¥–∏–º–∏—Ä–æ–≤–∏—á', organizaciya: '–û–û–û "–°—Ç—Ä–æ–π–°–µ—Ä–≤–∏—Å"', specialnost: '–í–æ–¥–∏—Ç–µ–ª—å —Å–∞–º–æ—Å–≤–∞–ª–∞' }
            ],
            '–†–∞–∑–Ω–æ—Ä–∞–±–æ—á–∏–π': [
                { fio: '–ü–µ—Ç—Ä–æ–≤ –ü–µ—Ç—Ä –ü–µ—Ç—Ä–æ–≤–∏—á', organizaciya: '–û–û–û "–°—Ç—Ä–æ–π–°–µ—Ä–≤–∏—Å"', specialnost: '–†–∞–∑–Ω–æ—Ä–∞–±–æ—á–∏–π' },
                { fio: '–§–µ–¥–æ—Ä–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –°–µ—Ä–≥–µ–µ–≤–∏—á', organizaciya: '–û–û–û "–°—Ç—Ä–æ–π–°–µ—Ä–≤–∏—Å"', specialnost: '–†–∞–∑–Ω–æ—Ä–∞–±–æ—á–∏–π' },
                { fio: '–°–æ–∫–æ–ª–æ–≤ –î–º–∏—Ç—Ä–∏–π –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–∏—á', organizaciya: '–û–û–û "–°—Ç—Ä–æ–π–°–µ—Ä–≤–∏—Å"', specialnost: '–†–∞–∑–Ω–æ—Ä–∞–±–æ—á–∏–π' }
            ],
            '–ú–∞—à–∏–Ω–∏—Å—Ç —ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä–∞': [
                { fio: '–°–∏–¥–æ—Ä–æ–≤ –°–∏–¥–æ—Ä –°–∏–¥–æ—Ä–æ–≤–∏—á', organizaciya: '–û–û–û "–°—Ç—Ä–æ–π–°–µ—Ä–≤–∏—Å"', specialnost: '–ú–∞—à–∏–Ω–∏—Å—Ç —ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä–∞' },
                { fio: '–ö—É–∑–Ω–µ—Ü–æ–≤ –í–∞—Å–∏–ª–∏–π –ò–≤–∞–Ω–æ–≤–∏—á', organizaciya: '–û–û–û "–°—Ç—Ä–æ–π–°–µ—Ä–≤–∏—Å"', specialnost: '–ú–∞—à–∏–Ω–∏—Å—Ç —ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä–∞' }
            ]
        };
        
        // –ü–æ–¥–±–∏—Ä–∞–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø–æ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏
        let employees = [];
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
        if (allEmployees[position]) {
            employees = allEmployees[position];
        } else {
            // –ï—Å–ª–∏ —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –Ω–µ—Ç, –∏—â–µ–º –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É
            for (const key in allEmployees) {
                if (key.toLowerCase().includes(position.toLowerCase()) || position.toLowerCase().includes(key.toLowerCase())) {
                    employees = allEmployees[key];
                    break;
                }
            }
            
            // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏, –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã—Ö –ø–æ–ø–∞–≤—à–∏—Ö—Å—è
            if (employees.length === 0) {
                const firstKey = Object.keys(allEmployees)[0];
                employees = allEmployees[firstKey];
            }
        }
        
        // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
        const table = document.createElement('table');
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';
        table.style.marginTop = '10px';
        
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        headerRow.style.backgroundColor = '#34495e';
        
        const thName = document.createElement('th');
        thName.textContent = '–§–ò–û';
        thName.style.padding = '4px';
        thName.style.textAlign = 'left';
        thName.style.border = '1px solid #2c3e50';
        thName.style.width = '30%';
        
        const thOrg = document.createElement('th');
        thOrg.textContent = '–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è';
        thOrg.style.padding = '4px';
        thOrg.style.textAlign = 'center';
        thOrg.style.border = '1px solid #2c3e50';
        thOrg.style.width = '25%';
        
        const thSpec = document.createElement('th');
        thSpec.textContent = '–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å';
        thSpec.style.padding = '4px';
        thSpec.style.textAlign = 'center';
        thSpec.style.border = '1px solid #2c3e50';
        thSpec.style.width = '25%';
        
        const thHours = document.createElement('th');
        thHours.textContent = '–û—Ç—Ä–∞–±–æ—Ç–∞–ª';
        thHours.style.padding = '4px';
        thHours.style.textAlign = 'center';
        thHours.style.border = '1px solid #2c3e50';
        thHours.style.width = '10%';
        
        const thKPI = document.createElement('th');
        thKPI.textContent = 'KPI';
        thKPI.style.padding = '4px';
        thKPI.style.textAlign = 'center';
        thKPI.style.border = '1px solid #2c3e50';
        thKPI.style.width = '10%';
        
        headerRow.appendChild(thName);
        headerRow.appendChild(thOrg);
        headerRow.appendChild(thSpec);
        headerRow.appendChild(thHours);
        headerRow.appendChild(thKPI);
        thead.appendChild(headerRow);
        table.appendChild(thead);
        
        // –¢–µ–ª–æ —Ç–∞–±–ª–∏—Ü—ã
        const tbody = document.createElement('tbody');
        
        employees.forEach(employee => {
            const row = document.createElement('tr');
            row.style.backgroundColor = 'rgba(255,255,255,0.1)';
            
            const tdName = document.createElement('td');
            tdName.textContent = employee.fio;
            tdName.style.padding = '4px';
            tdName.style.border = '1px solid #34495e';
            
            const tdOrg = document.createElement('td');
            tdOrg.textContent = employee.organizaciya || '-';
            tdOrg.style.padding = '4px';
            tdOrg.style.border = '1px solid #34495e';
            tdOrg.style.textAlign = 'center';
            
            const tdSpec = document.createElement('td');
            tdSpec.textContent = employee.specialnost || '-';
            tdSpec.style.padding = '4px';
            tdSpec.style.border = '1px solid #34495e';
            tdSpec.style.textAlign = 'center';
            
            const tdHours = document.createElement('td');
            tdHours.textContent = '8';
            tdHours.style.padding = '4px';
            tdHours.style.border = '1px solid #34495e';
            tdHours.style.textAlign = 'center';
            tdHours.contentEditable = 'true';
            tdHours.style.cursor = 'pointer';
            tdHours.style.backgroundColor = 'rgba(255,255,255,0.05)';
            
            const tdKPI = document.createElement('td');
            tdKPI.textContent = '1.0';
            tdKPI.style.padding = '4px';
            tdKPI.style.border = '1px solid #34495e';
            tdKPI.style.textAlign = 'center';
            tdKPI.contentEditable = 'true';
            tdKPI.style.cursor = 'pointer';
            tdKPI.style.backgroundColor = 'rgba(255,255,255,0.05)';
            
            row.appendChild(tdName);
            row.appendChild(tdOrg);
            row.appendChild(tdSpec);
            row.appendChild(tdHours);
            row.appendChild(tdKPI);
            tbody.appendChild(row);
        });
        
        table.appendChild(tbody);
        content.insertBefore(table, closeBtn);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
        const info = document.createElement('p');
        info.textContent = `–í—Å–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: ${employees.length} (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)`;
        info.style.marginTop = '10px';
        info.style.textAlign = 'right';
        info.style.color = '#bdc3c7';
        content.insertBefore(info, closeBtn);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ç–∞–±–µ–ª—å" –ø–æ—Å–ª–µ —Ç–∞–±–ª–∏—Ü—ã
        content.insertBefore(saveBtn, closeBtn);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    function showFixedEmployeesModal(position, date) {
        // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        const modal = document.createElement('div');
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
        modal.style.zIndex = '1000';
        modal.style.display = 'flex';
        modal.style.justifyContent = 'center';
        modal.style.alignItems = 'center';
        
        // –°–æ–∑–¥–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        const content = document.createElement('div');
        content.style.backgroundColor = '#2c3e50';
        content.style.padding = '20px';
        content.style.borderRadius = '5px';
        content.style.width = '800px';
        content.style.maxWidth = '90vw';
        content.style.color = 'white';
        
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫
        const header = document.createElement('h3');
        header.textContent = '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏: ' + position + (date ? ' (' + date + ')' : '');
        header.style.marginTop = '0';
        content.appendChild(header);
        
        // –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è
        const closeBtn = document.createElement('button');
        closeBtn.textContent = '‚úó';
        closeBtn.style.backgroundColor = '#e74c3c';
        closeBtn.style.color = 'white';
        closeBtn.style.border = 'none';
        closeBtn.style.padding = '8px 16px';
        closeBtn.style.borderRadius = '4px';
        closeBtn.style.cursor = 'pointer';
        closeBtn.style.marginTop = '20px';
        closeBtn.style.float = 'right';
        
        closeBtn.addEventListener('click', function() {
            document.body.removeChild(modal);
        });
        
        // –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ —Ç–∞–±–µ–ª—å
        const saveBtn = document.createElement('button');
        saveBtn.textContent = '‚úì';
        saveBtn.style.backgroundColor = '#27ae60';
        saveBtn.style.color = 'white';
        saveBtn.style.border = 'none';
        saveBtn.style.padding = '8px 16px';
        saveBtn.style.borderRadius = '4px';
        saveBtn.style.cursor = 'pointer';
        saveBtn.style.marginTop = '20px';
        saveBtn.style.marginRight = '10px';
        saveBtn.style.float = 'right';
        
        saveBtn.addEventListener('click', function() {
            // –ü–æ–ª—É—á–∞–µ–º ID –æ–±—ä–µ–∫—Ç–∞ –∏–∑ URL
            const objectId = window.location.pathname.split('/')[2];
            saveEmployeeHours(objectId, position, date, modal);
        });
        
        content.appendChild(closeBtn);
        modal.appendChild(content);
        document.body.appendChild(modal);
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        modal.addEventListener('click', function(event) {
            if (event.target === modal) {
                document.body.removeChild(modal);
            }
        });
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é showFixedEmployeesData –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        showFixedEmployeesData(content, closeBtn, position, saveBtn);
    }
    </script>
    

</body>
</html>

