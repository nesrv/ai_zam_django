{% extends 'base/base.html' %}
{% load static %}

{% block title %}–î–æ–±–∞–≤–∏—Ç—å –±–æ—Ç–∞ - AI-ZAM{% endblock %}

{% block extra_styles %}
.page-title {
    text-align: center;
    color: white;
    font-size: 3rem;
    margin-bottom: 1rem;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.chatbots-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 10px;
}

.iphone-frame {
    background: #000;
    border-radius: 30px;
    padding: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    width: 300px;
    min-width: 300px;
    margin: 0 auto;
    transform: perspective(1000px) rotateY(5deg);
    transition: transform 0.3s ease;
}

.iphone-frame:hover {
    transform: perspective(1000px) rotateY(0deg) scale(1.05);
}

.iphone-screen {
    background: #f8f8f8;
    border-radius: 25px;
    overflow: hidden;
    min-height: 500px;
    height: 600px;
    display: flex;
    flex-direction: column;
}

.chat-header {
    background: #007AFF;
    color: white;
    padding: 15px;
    text-align: center;
    font-weight: bold;
    font-size: 0.9rem;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
}

.chat-content {
    padding: 20px;
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: center;
    text-align: center;
    overflow-y: auto;
}

.connect-form {
    width: 100%;
}

.form-group {
    margin-bottom: 15px;
    text-align: left;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #333;
    font-size: 0.9rem;
}

.chat-id-input {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 20px;
    font-size: 0.9rem;
    margin-bottom: 10px;
    outline: none;
    text-align: center;
    box-sizing: border-box;
}

.chat-id-input:focus {
    border-color: #007AFF;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}

.connect-btn {
    background: #007AFF;
    color: white;
    border: none;
    border-radius: 20px;
    padding: 10px 20px;
    font-size: 0.9rem;
    cursor: pointer;
    width: 100%;
    transition: background 0.3s;
}

.connect-btn:hover {
    background: #0056b3;
}

.instruction-content {
    color: #333;
    line-height: 1.4;
    font-size: 0.8rem;
    text-align: left;
    padding: 10px;
}

.instruction-content h3 {
    color: #007AFF;
    margin-bottom: 15px;
    font-size: 1rem;
    text-align: center;
}

.instruction-content ol {
    padding-left: 15px;
    margin-bottom: 15px;
}

.instruction-content li {
    margin-bottom: 8px;
}

.instruction-content strong {
    color: #333;
}

.instruction-section {
    margin-bottom: 20px;
}

.instruction-section h4 {
    color: #007AFF;
    font-size: 0.9rem;
    margin-bottom: 10px;
}



@media (max-width: 768px) {
    .chatbots-grid {
        grid-template-columns: 1fr;
        gap: 2rem;
    }
    
    .iphone-frame {
        transform: none;
        max-width: 280px;
    }
    
    .iphone-frame:hover {
        transform: scale(1.02);
    }
}
{% endblock %}

{% block content %}
<div class="page-title">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–æ—Ç–æ–≤ –∏ —Ä–∞–±–æ—á–∏—Ö —á–∞—Ç–æ–≤</div>

<div style="text-align: center; margin-bottom: 20px;">
    <a href="/objects/profile/" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; padding: 12px 20px; text-decoration: none; transition: all 0.3s;">‚Üê –ù–∞–∑–∞–¥ –∫ –ø—Ä–æ—Ñ–∏–ª—é</a>
</div>

<div class="chatbots-grid">
    <!-- –õ–µ–≤—ã–π —ç–∫—Ä–∞–Ω - –§–æ—Ä–º–∞ -->
    <div class="iphone-frame">
        <div class="iphone-screen">
            <div class="chat-header">
                ü§ñ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–æ—Ç–∞
            </div>
            <div class="chat-content">
                <form method="post" class="connect-form">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="bot_name">–ù–∞–∑–≤–∞–Ω–∏–µ –±–æ—Ç–∞</label>
                        <input type="text" id="bot_name" name="bot_name" class="chat-id-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ–π AI-–±–æ—Ç" required>
                    </div>
                    <div class="form-group">
                        <label for="bot_token">–¢–æ–∫–µ–Ω</label>
                        <input type="text" id="bot_token" name="bot_token" class="chat-id-input" placeholder="123456:ABC-DEF1234ghIkl-..." required>
                    </div>
                    <button type="submit" class="connect-btn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å –±–æ—Ç–∞</button>
                    <button type="button" id="get-chat-ids" class="connect-btn" style="background: #28a745; margin-top: 10px; display: none;">–ü–æ–ª—É—á–∏—Ç—å ID —Ä–∞–±–æ—á–µ–≥–æ —á–∞—Ç–∞</button>
                </form>
                <div id="chat-results" style="margin-top: 15px; display: none;"></div>
            </div>
        </div>
    </div>
    
    <!-- –ü—Ä–∞–≤—ã–π —ç–∫—Ä–∞–Ω - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è -->
    <div class="iphone-frame">
        <div class="iphone-screen">
            <div class="chat-header">
                üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
            </div>
            <div class="chat-content">
                <div class="instruction-content">
                    <h3>–ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é Telegram-–±–æ—Ç–∞</h3>
                    
                    <div class="instruction-section">
                        <h4>1. –°–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ BotFather</h4>
                        <ol>
                            <li>–û—Ç–∫—Ä–æ–π—Ç–µ Telegram, –Ω–∞–π–¥–∏—Ç–µ <strong>@BotFather</strong>.</li>
                            <li>–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É <strong>/newbot</strong>.</li>
                            <li>–£–∫–∞–∂–∏—Ç–µ –∏–º—è –±–æ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, <strong>TestBot</strong>).</li>
                            <li>–ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, <strong>123456:ABC-DEF1234ghIkl-...</strong>).</li>
                        </ol>
                    </div>
                    
                    <div class="instruction-section">
                        <h4>2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É</h4>
                        <ol>
                            <li>–°–æ–∑–¥–∞–π—Ç–µ –≥—Ä—É–ø–ø—É (–µ—Å–ª–∏ –µ—ë –Ω–µ—Ç):<br>
                                - –í Telegram –Ω–∞–∂–º–∏—Ç–µ ¬´–ù–æ–≤—ã–π —á–∞—Ç¬ª ‚Üí ¬´–ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞¬ª.<br>
                                - –î–æ–±–∞–≤—å—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–º–∏–Ω–∏–º—É–º 1 –∫—Ä–æ–º–µ –±–æ—Ç–∞).</li>
                            <li>–î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É:<br>
                                - –ù–∞–∂–º–∏—Ç–µ ¬´–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤¬ª.<br>
                                - –í –ø–æ–∏—Å–∫–µ –≤–≤–µ–¥–∏—Ç–µ @–∏–º—è_–±–æ—Ç–∞.<br>
                                - –í—ã–±–µ—Ä–∏—Ç–µ –±–æ—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –∏ –¥–æ–±–∞–≤—å—Ç–µ.</li>
                        </ol>
                    </div>
                    
                    <div class="instruction-section">
                        <h4>3. –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –±–æ—Ç–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º</h4>
                        <ol>
                            <li>–û—Ç–∫—Ä–æ–π—Ç–µ ¬´–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–æ–π¬ª:<br>
                                - –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã ‚Üí ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏¬ª (‚öôÔ∏è).</li>
                            <li>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ ¬´–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã¬ª ‚Üí ¬´–î–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞¬ª.</li>
                            <li>–í—ã–±–µ—Ä–∏—Ç–µ –±–æ—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞.</li>
                            <li>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–∞–≤–∞ –±–æ—Ç–∞ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.</li>
                        </ol>
                    </div>
                    
                    <div class="instruction-section">
                        <h4>4. –ü–æ–ª—É—á–µ–Ω–∏–µ ID —á–∞—Ç–∞</h4>
                        <ol>
                            <li>–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É –≤ –≥—Ä—É–ø–ø–µ.</li>
                            <li>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ü–æ–ª—É—á–∏—Ç—å ID —Ä–∞–±–æ—á–µ–≥–æ —á–∞—Ç–∞".</li>
                            <li>ID —á–∞—Ç–æ–≤ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const getChatIdsBtn = document.getElementById('get-chat-ids');
    const chatResults = document.getElementById('chat-results');
    const botTokenInput = document.getElementById('bot_token');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –±–æ—Ç–∞
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        
        fetch('/objects/add-bot/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            if (response.ok) {
                getChatIdsBtn.style.display = 'block';
                alert('–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω!');
            } else {
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –±–æ—Ç–∞');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –±–æ—Ç–∞');
        });
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –ø–æ–ª—É—á–µ–Ω–∏—è ID —á–∞—Ç–æ–≤
    getChatIdsBtn.addEventListener('click', function() {
        const botToken = botTokenInput.value.trim();
        
        if (!botToken) {
            alert('–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞');
            return;
        }
        
        getChatIdsBtn.textContent = '–ü–æ–ª—É—á–∞–µ–º ID —á–∞—Ç–æ–≤...';
        getChatIdsBtn.disabled = true;
        
        fetch('/objects/get-chat-ids/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                bot_token: botToken
            })
        })
        .then(response => response.json())
        .then(data => {
            getChatIdsBtn.textContent = '–ü–æ–ª—É—á–∏—Ç—å ID —Ä–∞–±–æ—á–µ–≥–æ —á–∞—Ç–∞';
            getChatIdsBtn.disabled = false;
            
            if (data.success) {
                let resultsHtml = '<h4 style="color: #007AFF; margin-bottom: 10px;">–ù–∞–π–¥–µ–Ω–Ω—ã–µ —á–∞—Ç—ã:</h4>';
                
                if (data.chat_ids.length > 0) {
                    data.chat_ids.forEach(chat => {
                        resultsHtml += `<div id="chat-${chat.id}" style="background: rgba(0,123,255,0.1); padding: 8px; margin: 5px 0; border-radius: 5px; font-size: 0.8rem; color: #333;">`;
                        resultsHtml += `<strong style="color: #000;">${chat.title}</strong> ID: <code style="background: #fff; padding: 2px 4px; border-radius: 3px; color: #000;">${chat.id}</code>`;
                        resultsHtml += `<button onclick="saveChatId('${chat.id}', '${chat.title}')" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 50%; margin-left: 10px; cursor: pointer; font-size: 0.8rem; width: 25px; height: 25px;">‚úî</button>`;
                        resultsHtml += `<button onclick="removeChatId('${chat.id}', '${chat.title}')" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 50%; margin-left: 5px; cursor: pointer; font-size: 0.8rem; width: 25px; height: 25px;">‚úó</button>`;
                        resultsHtml += `</div>`;
                    });
                    
                    if (data.updated_objects.length > 0) {
                        resultsHtml += '<h5 style="color: #28a745; margin-top: 15px;">–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã:</h5>';
                        data.updated_objects.forEach(obj => {
                            resultsHtml += `<div style="background: rgba(40,167,69,0.1); padding: 8px; margin: 5px 0; border-radius: 5px; font-size: 0.8rem;">`;
                            resultsHtml += `${obj.object_name} ‚Üí ${obj.chat_title} (${obj.chat_id})`;
                            resultsHtml += `</div>`;
                        });
                    }
                    
                    resultsHtml += '<div style="text-align: center; margin-top: 15px;">';
                    resultsHtml += '<a href="/telegram/" style="background: #007AFF; color: white; padding: 10px 20px; border-radius: 20px; text-decoration: none; font-size: 0.9rem; display: inline-block;">–ü–µ—Ä–µ–π—Ç–∏ –≤ –ß–∞—Ç—ã</a>';
                    resultsHtml += '</div>';
                } else {
                    resultsHtml += '<p style="color: #666; font-size: 0.8rem;">–ù–µ –Ω–∞–π–¥–µ–Ω–æ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–æ–≤. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–æ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≥—Ä—É–ø–ø—ã –∏ –µ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è.</p>';
                }
                
                chatResults.innerHTML = resultsHtml;
                chatResults.style.display = 'block';
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            getChatIdsBtn.textContent = '–ü–æ–ª—É—á–∏—Ç—å ID —Ä–∞–±–æ—á–µ–≥–æ —á–∞—Ç–∞';
            getChatIdsBtn.disabled = false;
            alert('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è ID —á–∞—Ç–æ–≤');
        });
    });
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è chat_id –≤ –æ–±—ä–µ–∫—Ç—ã
    window.saveChatId = function(chatId, chatTitle) {
        fetch('/objects/save-chat-to-objects/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                chat_id: chatId,
                chat_title: chatTitle
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`–ß–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ ${data.updated_count} –æ–±—ä–µ–∫—Ç–æ–≤`);
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–∞—Ç–∞');
        });
    };
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è chat_id –∏–∑ –æ–±—ä–µ–∫—Ç–æ–≤
    window.removeChatId = function(chatId, chatTitle) {
        fetch('/objects/remove-chat-from-objects/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                chat_id: chatId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –í–∏–∑—É–∞–ª—å–Ω–æ —É–¥–∞–ª—è–µ–º –±–ª–æ–∫
                const chatBlock = document.getElementById(`chat-${chatId}`);
                if (chatBlock) {
                    chatBlock.style.transition = 'opacity 0.3s ease';
                    chatBlock.style.opacity = '0';
                    setTimeout(() => {
                        chatBlock.remove();
                    }, 300);
                }
                alert(`–ß–∞—Ç —É–¥–∞–ª–µ–Ω –∏–∑ ${data.updated_count} –æ–±—ä–µ–∫—Ç–æ–≤`);
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —á–∞—Ç–∞');
        });
    };
});
</script>
{% endblock %}