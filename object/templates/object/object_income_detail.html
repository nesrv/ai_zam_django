{% load static %}
{% load object_filters %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ object.nazvanie }} - –î–æ—Ö–æ–¥–Ω–∞—è —á–∞—Å—Ç—å - AI-ZAM</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <style>

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            padding: 20px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.8;
        }
        
        .header-info {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .info-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .info-item strong {
            color: #ecf0f1;
        }
        
        .main-action-btns {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 20px 0 20px 0;
        }

        
        .table-container {
            padding: 0;
            overflow-x: auto;
            overflow-y: visible;
            max-width: 100vw;
            -webkit-overflow-scrolling: touch;
        }
        
        .resource-table {
            width: auto;
            min-width: 2000px;
            border-collapse: collapse;
            margin-bottom: 20px;
            white-space: nowrap;
            table-layout: fixed;
        }
        
        .resource-table th {
            background: #34495e;
            color: white;
            padding: 7px 6px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #2c3e50;
            position: sticky;
            top: 0;
            font-size: 0.85em;
        }
        
        .resource-table td {
            padding: 6px;
            border: 1px solid #ddd;
            background: white;
            font-size: 0.85em;
        }
        
        .resource-table .number {
            text-align: right;
        }
        
        .main-header td {
            background: #1a2530 !important;
            color: white !important;
            font-weight: bold;
            text-align: center;
            padding: 10px 8px;
            font-size: 2em;
        }
        
        .category-header td {
            background: #3498db !important;
            color: white !important;
            font-weight: bold;
            text-align: left;
            padding: 8px;
        }
        
        .category-–∫–∞–¥—Ä—ã td { background: #e8f4fd; }
        .category-–º–∞—à–∏–Ω—ã td { background: #fff3cd; }
        .category-–º–∞—Ç–µ—Ä–∏–∞–ª—ã td { background: #d4edda; }
        .category-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ td { background: #f8d7da; }
        .category-—Å–∏–∑ td { background: #e2e3e5; }
        .category-–ø–æ–¥—Ä—è–¥–Ω—ã–µ td { background: #d1ecf1; }
        
        .total-row td {
            background: #2c3e50 !important;
            color: white !important;
            font-weight: bold;
        }
        
        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: inline-block;
            padding: 10px 20px;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .back-btn:hover {
            background: #2980b9;
        }
        
        .edit-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: inline-block;
            padding: 10px 20px;
            background: #e74c3c;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .edit-btn:hover {
            background: #c0392b;
        }
        
        .bold {
            font-weight: bold;
        }
        
        .editable-cell {
            cursor: pointer;
            background-color: #f8f9fa;
        }
        
        .editable-cell:hover {
            background-color: #e9ecef;
        }
        
        .editing {
            background-color: #fff3cd !important;
        }
        
        .header-title-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 10px;
        }
        
        .header-title-row h1 {
            margin: 0;
        }
        
        .header-title-row p {
            margin: 0;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-title-row">
                <h1>{{ object.nazvanie }} (—Å–º–µ—Ç–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø–æ –æ–±—ä–µ–∫—Ç—É) </h1>         
            </div>           
            <div class="header-info">
                <div class="info-item">
                    <strong>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:</strong> 
                    {% if object.otvetstvennyj %}
                        {{ object.otvetstvennyj.fio }}
                    {% else %}
                        –ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω
                    {% endif %}
                </div>
                <div class="info-item">
                    <strong>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</strong> {{ object.data_nachala|date:"d.m.Y" }}
                </div>
                <div class="info-item">
                    <strong>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ä–µ—Å—É—Ä—Å–æ–≤:</strong> {{ total_cost|format_number }} ‚ÇΩ
                </div>
            </div>
            <!-- –î–≤–µ –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ header-info -->
            <div class="main-action-btns">
                <a href="/objects/{{ object.id }}/" style="background: #ffff00 !important; color: black !important; padding: 12px 32px; font-size: 1.1em; font-weight: bold; border-radius: 6px; text-decoration: none; display: inline-block;">üí∞ –†–∞—Å—Ö–æ–¥–Ω–∞—è —á–∞—Å—Ç—å</a>
                <a href="/objects/{{ object.id }}/income/" style="background: #0000ff !important; color: white !important; padding: 12px 32px; font-size: 1.1em; font-weight: bold; border-radius: 6px; text-decoration: none; display: inline-block;">üíµ –î–æ—Ö–æ–¥–Ω–∞—è —á–∞—Å—Ç—å (–°–¢–†–ê–ù–ò–¶–ê –î–û–•–û–î–û–í)</a>
            </div>
        </div>
        
        <div class="table-container">
            <table class="resource-table">
                <thead>
                    <tr>
                        <th style="width: 5%;">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                        <th style="width: 2%;">–ï–¥.<br>–∏–∑–º</th>
                        <th style="width: 3%;">–û–±—ä–µ–º</th>
                        <th style="width: 3%;">–†–∞—Å—Ü–µ–Ω–∫–∞</th>
                        <th style="width: 3%;">–°—É–º–º–∞</th>
                        <th style="width: 2%;">–í—ã–ø-–Ω–æ</th>
                        <th style="width: 2%;">–û—Å—Ç–∞–ª.<br>–≤—ã–ø-—Ç—å</th>
                        {% for day in days %}
                        <th style="width: 3%;">{{ day|date:"d.m" }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% regroup resources by resurs.kategoriya_resursa.nazvanie as category_list %}
                    {% for category in category_list %}
                    {% if category.grouper|lower == '–ø–æ–¥—Ä—è–¥–Ω—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏' %}
                    <tr class="category-header">
                        <td colspan="{{ 7|add:days|length }}">{{ category.grouper|title }}</td>
                    </tr>
                    {% for resource in category.list %}
                    <tr class="category-{{ category.grouper|lower }}">
                        <td>{{ resource.resurs.naimenovanie }}</td>
                        <td>{{ resource.resurs.edinica_izmereniya }}</td>
                        <td class="number editable-cell" 
                            data-resource-id="{{ resource.id }}" 
                            data-field-type="kolichestvo"
                            onclick="editResourceCell(this)">{{ resource.kolichestvo|floatformat:0 }}</td>
                        <td class="number editable-cell" 
                            data-resource-id="{{ resource.id }}" 
                            data-field-type="cena"
                            onclick="editResourceCell(this)">{{ resource.cena|floatformat:0 }}</td>
                        <td class="number sum-cell" 
                            data-resource-id="{{ resource.id }}">{{ resource.kolichestvo|multiply:resource.cena|floatformat:0 }}</td>
                        <td class="number">{{ resource.potracheno|floatformat:0 }}</td>
                        <td class="number ostatok-cell" 
                            data-resource-id="{{ resource.id }}">{{ resource.kolichestvo|subtract:resource.potracheno|floatformat:0 }}</td>
                        {% for day in days %}
                            <td class="number editable-cell" 
                                data-resource-id="{{ resource.id }}" 
                                data-date="{{ day|date:'Y-m-d' }}" 
                                onclick="editCell(this)">
                            {% with day_value=0 %}
                                {% for fr in fakticheskij_resursy %}
                                    {% if fr.resurs_po_objektu.id == resource.id %}
                                        {% for dokhod in dokhody|get_item:fr.id %}
                                            {% if dokhod.data|date:"Y-m-d" == day|date:"Y-m-d" %}
                                                {{ dokhod.vypolneno|floatformat:0 }}
                                                {% with day_value=1 %}{% endwith %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                {% endfor %}
                                <!-- {% if day_value == 0 %}0{% endif %} -->
                            {% endwith %}
                            </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                    {% endif %}
                    {% endfor %}
                    
                    <tr class="total-row">
                        <td colspan="4">–ò—Ç–æ–≥–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –¥–æ—Ö–æ–¥–æ–≤ –ø–æ –¥–Ω—è–º:</td>
                        <td class="number">{{ total_cost|floatformat:0 }}</td>
                        <td class="number">{{ total_completed|floatformat:0 }}</td>
                        <td class="number">{{ total_remaining|floatformat:0 }}</td>
                        {% for day in days %}
                        <td class="number">{{ daily_totals|get_daily_total:day|floatformat:0 }}</td>
                        {% endfor %}
                    </tr>
                </tbody>
            </table>
        </div>
        
    </div>
    
    <a href="/objects/" class="back-btn">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –æ–±—ä–µ–∫—Ç–æ–≤</a>
    <a href="/admin/object/objekt/{{ object.id }}/change/" class="edit-btn">‚úé –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç</a>
    
    <script>
    function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    }
    
    function updateDayTotal(changedCell) {
        // –ù–∞—Ö–æ–¥–∏–º —Ç–æ—á–Ω—ã–π –∏–Ω–¥–µ–∫—Å —Å—Ç–æ–ª–±—Ü–∞ –∏–∑–º–µ–Ω–µ–Ω–Ω–æ–π —è—á–µ–π–∫–∏
        const row = changedCell.closest('tr');
        const cells = Array.from(row.querySelectorAll('td'));
        const columnIndex = cells.indexOf(changedCell);
        
        if (columnIndex === -1) return;
        
        const date = changedCell.dataset.date;
        if (!date) return;
        
        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥ –¥–ª—è —ç—Ç–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞
        const resourceRows = document.querySelectorAll('tr[class*="category-–ø–æ–¥—Ä—è–¥–Ω—ã–µ"]');
        let dayTotal = 0;
        
        resourceRows.forEach(resourceRow => {
            const resourceCells = resourceRow.querySelectorAll('td');
            if (resourceCells[columnIndex]) {
                // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞ –¥–µ–Ω—å
                const dayValue = parseFloat(resourceCells[columnIndex].textContent.replace(/\s/g, '').replace(/[^\d.-]/g, '')) || 0;
                // –ü–æ–ª—É—á–∞–µ–º —Ä–∞—Å—Ü–µ–Ω–∫—É (—Å—Ç–æ–ª–±–µ—Ü 3)
                const price = parseFloat(resourceCells[3].textContent.replace(/\s/g, '').replace(/[^\d.-]/g, '')) || 0;
                // –î–æ–±–∞–≤–ª—è–µ–º –∫ –∏—Ç–æ–≥—É: –≤—ã–ø–æ–ª–Ω–µ–Ω–æ * —Ä–∞—Å—Ü–µ–Ω–∫–∞
                dayTotal += dayValue * price;
            }
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —è—á–µ–π–∫—É –∏—Ç–æ–≥–∞ —Å —É—á–µ—Ç–æ–º —Å–º–µ—â–µ–Ω–∏—è –∏–∑-–∑–∞ colspan
        const totalRow = document.querySelector('tr.total-row');
        if (totalRow) {
            const totalCells = totalRow.querySelectorAll('td');
            // –í –∏—Ç–æ–≥–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ –ø–µ—Ä–≤–∞—è —è—á–µ–π–∫–∞ –∏–º–µ–µ—Ç colspan="4", –ø–æ—ç—Ç–æ–º—É —Å–º–µ—â–µ–Ω–∏–µ -3
            const totalColumnIndex = columnIndex - 3;
            if (totalCells[totalColumnIndex] && totalColumnIndex >= 0) {
                totalCells[totalColumnIndex].textContent = formatNumber(Math.round(dayTotal));
            }
        }
    }
    
    function updateTotalsRow() {
        const resourceRows = document.querySelectorAll('tr[class*="category-–ø–æ–¥—Ä—è–¥–Ω—ã–µ"]');
        
        let totalCost = 0;
        let totalCompleted = 0;
        let totalRemaining = 0;
        
        resourceRows.forEach((row) => {
            const cells = row.querySelectorAll('td');
            if (cells.length > 0) {
                totalCost += parseFloat(cells[4].textContent.replace(/\s/g, '').replace(/[^\d.-]/g, '')) || 0;
                totalCompleted += parseFloat(cells[5].textContent.replace(/\s/g, '').replace(/[^\d.-]/g, '')) || 0;
                totalRemaining += parseFloat(cells[6].textContent.replace(/\s/g, '').replace(/[^\d.-]/g, '')) || 0;
            }
        });
        
        const totalRow = document.querySelector('tr.total-row');
        if (totalRow) {
            const totalCells = totalRow.querySelectorAll('td');
            if (totalCells[4]) totalCells[4].textContent = formatNumber(Math.round(totalCost));
            if (totalCells[5]) totalCells[5].textContent = formatNumber(Math.round(totalCompleted));
            if (totalCells[6]) totalCells[6].textContent = formatNumber(Math.round(totalRemaining));
        }
    }
    
    function editCell(cell) {
        if (cell.classList.contains('editing')) return;
        
        const currentValue = cell.textContent.trim();
        const input = document.createElement('input');
        input.type = 'number';
        input.value = currentValue;
        input.style.width = '120px';
        input.style.height = '30px';
        input.style.border = '2px solid #007bff';
        input.style.background = 'white';
        input.style.textAlign = 'right';
        input.style.fontSize = '14px';
        input.style.padding = '5px';
        input.style.borderRadius = '4px';
        
        cell.innerHTML = '';
        cell.appendChild(input);
        cell.classList.add('editing');
        input.focus();
        input.select();
        
        function saveValue() {
            const newValue = input.value || '0';
            cell.textContent = formatNumber(parseFloat(newValue));
            cell.classList.remove('editing');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            const resourceId = cell.dataset.resourceId;
            const date = cell.dataset.date;
            
            fetch('/update-income/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    resource_id: resourceId,
                    date: date,
                    amount: newValue
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Server response:', data);
                if (data.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —è—á–µ–π–∫–∏ –ü–æ—Ç—Ä–∞—á–µ–Ω–æ –∏ –û—Å—Ç–∞–ª–æ—Å—å
                    const row = cell.closest('tr');
                    const cells = row.querySelectorAll('td');
                    cells[5].textContent = formatNumber(Math.round(data.potracheno)); // –í—ã–ø-–Ω–æ
                    cells[6].textContent = formatNumber(Math.round(data.ostatok)); // –û—Å—Ç–∞–ª–æ—Å—å
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –¥–Ω—è
                    updateDayTotal(cell);
                } else {
                    console.error('Server error:', data.error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
            });
        }
        
        input.addEventListener('blur', saveValue);
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                saveValue();
            }
        });
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function editResourceCell(cell) {
        if (cell.classList.contains('editing')) return;
        
        const currentValue = cell.textContent.trim();
        const input = document.createElement('input');
        input.type = 'number';
        input.value = currentValue;
        input.style.width = '120px';
        input.style.height = '30px';
        input.style.border = '2px solid #28a745';
        input.style.background = 'white';
        input.style.textAlign = 'right';
        input.style.fontSize = '14px';
        input.style.padding = '5px';
        input.style.borderRadius = '4px';
        
        cell.innerHTML = '';
        cell.appendChild(input);
        cell.classList.add('editing');
        input.focus();
        input.select();
        
        function saveValue() {
            const newValue = input.value || '0';
            cell.textContent = formatNumber(parseFloat(newValue));
            cell.classList.remove('editing');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            const resourceId = cell.dataset.resourceId;
            const fieldType = cell.dataset.fieldType;
            
            fetch('/update-resource-data/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    resource_id: resourceId,
                    field_type: fieldType,
                    value: newValue
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('editResourceCell server response:', data);
                if (data.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —è—á–µ–π–∫—É —Å—É–º–º—ã
                    const row = cell.closest('tr');
                    const sumCell = row.querySelector('.sum-cell');
                    if (sumCell) {
                        sumCell.textContent = formatNumber(Math.round(data.new_sum));
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —è—á–µ–π–∫—É –æ—Å—Ç–∞—Ç–∫–∞
                    const ostatokCell = row.querySelector('.ostatok-cell');
                    if (ostatokCell) {
                        ostatokCell.textContent = formatNumber(Math.round(data.ostatok));
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç—Ä–æ–∫—É
                    updateTotalsRow();
                } else {
                    console.error('editResourceCell server error:', data.error);
                }
            })
            .catch(error => {
                console.error('editResourceCell fetch error:', error);
            });
        }
        
        input.addEventListener('blur', saveValue);
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                saveValue();
            }
        });
    }
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Å–µ —á–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        const numberCells = document.querySelectorAll('.number');
        numberCells.forEach(cell => {
            const text = cell.textContent.trim();
            if (text && !isNaN(parseFloat(text))) {
                cell.textContent = formatNumber(parseFloat(text));
            }
        });
    });
    </script>
    

</body>
</html> 