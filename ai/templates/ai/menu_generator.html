{% extends 'base/base.html' %}

{% block title %}–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–µ–Ω—é{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">üçΩÔ∏è –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–µ–Ω—é</h5>
                    <a href="{% url 'ai:index' %}" class="btn btn-sm btn-outline-primary">–ù–∞–∑–∞–¥</a>
                </div>
                <div class="card-body">
                    <!-- –í—ã–±–æ—Ä —Ç–∏–ø–∞ –º–µ–Ω—é -->
                    <div class="mb-4">
                        <h6>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –º–µ–Ω—é:</h6>
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="menu-type" id="daily-menu" value="daily" checked>
                            <label class="btn btn-outline-success" for="daily-menu">
                                üç≥ –ú–µ–Ω—é –Ω–∞ –¥–µ–Ω—å
                            </label>
                            
                            <input type="radio" class="btn-check" name="menu-type" id="weekly-menu" value="weekly">
                            <label class="btn btn-outline-info" for="weekly-menu">
                                üìÖ –ú–µ–Ω—é –Ω–∞ –Ω–µ–¥–µ–ª—é
                            </label>
                        </div>
                    </div>
                    
                    <!-- –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π -->
                    <form id="menu-form">
                        <div class="mb-3">
                            <label for="preferences" class="form-label">–í–∞—à–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –≤ –ø–∏—Ç–∞–Ω–∏–∏:</label>
                            <textarea class="form-control" id="preferences" rows="3" 
                                placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –±–µ–∑ –º—è—Å–∞, –ª—é–±–ª—é —Ä—ã–±—É, –Ω–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π, –≤–µ–≥–µ—Ç–∞—Ä–∏–∞–Ω—Å–∫–æ–µ –ø–∏—Ç–∞–Ω–∏–µ, –∞–ª–ª–µ—Ä–≥–∏—è –Ω–∞ –æ—Ä–µ—Ö–∏ –∏ —Ç.–¥."></textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <span id="submit-text">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –º–µ–Ω—é</span>
                            <span id="loading-text" style="display: none;">
                                <span class="spinner-border spinner-border-sm" role="status"></span>
                                –ì–µ–Ω–µ—Ä–∏—Ä—É—é...
                            </span>
                        </button>
                    </form>
                    
                    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
                    <div id="result" class="mt-4" style="display: none;">
                        <h6>üçΩÔ∏è –í–∞—à–µ –º–µ–Ω—é:</h6>
                        <div id="menu-content" class="border rounded p-3 bg-light" style="white-space: pre-wrap; font-family: monospace;"></div>
                        
                        <div class="mt-3">
                            <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard()">
                                üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="generateNew()">
                                üîÑ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤–æ–µ
                            </button>
                        </div>
                    </div>
                    
                    <!-- –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π -->
                    <div class="mt-4">
                        <h6>üí° –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π:</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <ul class="list-unstyled">
                                    <li><small>‚Ä¢ –í–µ–≥–µ—Ç–∞—Ä–∏–∞–Ω—Å–∫–æ–µ –ø–∏—Ç–∞–Ω–∏–µ</small></li>
                                    <li><small>‚Ä¢ –ë–µ–∑ –≥–ª—é—Ç–µ–Ω–∞</small></li>
                                    <li><small>‚Ä¢ –ù–∏–∑–∫–æ–∫–∞–ª–æ—Ä–∏–π–Ω–æ–µ</small></li>
                                    <li><small>‚Ä¢ –î–ª—è –¥–µ—Ç–µ–π</small></li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <ul class="list-unstyled">
                                    <li><small>‚Ä¢ –õ—é–±–ª—é –º–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã</small></li>
                                    <li><small>‚Ä¢ –ë—ã—Å—Ç—Ä–æ–µ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ</small></li>
                                    <li><small>‚Ä¢ –≠–∫–æ–Ω–æ–º–Ω–æ–µ –º–µ–Ω—é</small></li>
                                    <li><small>‚Ä¢ –ü—Ä–∞–∑–¥–Ω–∏—á–Ω–æ–µ –º–µ–Ω—é</small></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let sessionId = null;

document.addEventListener('DOMContentLoaded', function() {
    const menuForm = document.getElementById('menu-form');
    
    menuForm.addEventListener('submit', function(e) {
        e.preventDefault();
        generateMenu();
    });
});

function generateMenu() {
    const preferences = document.getElementById('preferences').value.trim();
    const menuType = document.querySelector('input[name="menu-type"]:checked').value;
    
    if (!preferences) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –≤–∞—à–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –≤ –ø–∏—Ç–∞–Ω–∏–∏');
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    showLoading(true);
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –º–µ–Ω—é –¥–ª—è API
    const apiType = menuType === 'daily' ? 'daily_menu' : 'weekly_menu';
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API
    fetch('{% url "ai:chat_api" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message: preferences,
            session_id: sessionId,
            type: apiType
        })
    })
    .then(response => response.json())
    .then(data => {
        showLoading(false);
        
        if (data.error) {
            showError('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
        } else {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º session_id
            if (data.session_id) {
                sessionId = data.session_id;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            showResult(data.response);
        }
    })
    .catch(error => {
        showLoading(false);
        showError('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message);
    });
}

function showLoading(show) {
    const submitText = document.getElementById('submit-text');
    const loadingText = document.getElementById('loading-text');
    
    if (show) {
        submitText.style.display = 'none';
        loadingText.style.display = 'inline';
    } else {
        submitText.style.display = 'inline';
        loadingText.style.display = 'none';
    }
}

function showResult(content) {
    const result = document.getElementById('result');
    const menuContent = document.getElementById('menu-content');
    
    menuContent.textContent = content;
    result.style.display = 'block';
    
    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
    result.scrollIntoView({ behavior: 'smooth' });
}

function showError(message) {
    const result = document.getElementById('result');
    const menuContent = document.getElementById('menu-content');
    
    menuContent.innerHTML = `<div class="text-danger">${message}</div>`;
    result.style.display = 'block';
}

function copyToClipboard() {
    const menuContent = document.getElementById('menu-content');
    const text = menuContent.textContent;
    
    navigator.clipboard.writeText(text).then(function() {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
        button.disabled = true;
        
        setTimeout(() => {
            button.textContent = originalText;
            button.disabled = false;
        }, 2000);
    }).catch(function(err) {
        console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ', err);
        alert('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
    });
}

function generateNew() {
    document.getElementById('preferences').value = '';
    document.getElementById('result').style.display = 'none';
    document.getElementById('preferences').focus();
}
</script>
{% endblock %} 