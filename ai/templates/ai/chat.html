{% extends 'base/base.html' %}

{% block title %}AI –ß–∞—Ç{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-10 mx-auto">
            <div class="ipad-container">
                <div class="ipad-frame">
                    <div class="ipad-screen">
                        <!-- –í—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é –≤ –ª–µ–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É —ç–∫—Ä–∞–Ω–∞ iPad -->
                        <div class="dropdown-menu">
                            <button class="dropdown-toggle" onclick="toggleDropdown()">
                                üìã –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
                                <span class="dropdown-arrow">‚ñº</span>
                            </button>
                            <div class="dropdown-content" id="dropdownContent">
                                <button class="menu-btn" onclick="generateDocument('lzk')">
                                    <span class="btn-icon">üìÑ</span>
                                    <span class="btn-text">–°–æ—Å—Ç–∞–≤—å –ª–∏–º–∏—Ç–Ω–æ-–∑–∞–±–æ—Ä–Ω—É—é –∫–∞—Ä—Ç—É (–õ–ó–ö)</span>
                                    <span class="btn-desc">–Ω–∞ [–Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞/–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è]</span>
                                </button>
                                <button class="menu-btn" onclick="generateDocument('vor')">
                                    <span class="btn-icon">üìä</span>
                                    <span class="btn-text">–°—Ñ–æ—Ä–º–∏—Ä—É–π –≤–µ–¥–æ–º–æ—Å—Ç—å –æ–±—ä–µ–º–æ–≤ —Ä–∞–±–æ—Ç (–í–û–†)</span>
                                    <span class="btn-desc">–¥–ª—è [—Ç–∏–ø –æ–±—ä–µ–∫—Ç–∞/—ç—Ç–∞–ø —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞]</span>
                                </button>
                                <button class="menu-btn" onclick="generateDocument('tz')">
                                    <span class="btn-icon">üìã</span>
                                    <span class="btn-text">–ù–∞–ø–∏—à–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ (–¢–ó)</span>
                                    <span class="btn-desc">–Ω–∞ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ [–æ–±—ä–µ–∫—Ç–∞/—Å–∏—Å—Ç–µ–º—ã]</span>
                                </button>
                                <button class="menu-btn" onclick="generateDocument('questionnaire')">
                                    <span class="btn-icon">‚ùì</span>
                                    <span class="btn-text">–ü–æ–¥–≥–æ—Ç–æ–≤—å –æ–ø—Ä–æ—Å–Ω—ã–π –ª–∏—Å—Ç –¥–ª—è –ø–æ–¥—Ä—è–¥—á–∏–∫–∞</span>
                                    <span class="btn-desc">–ø–æ [–≤–∏–¥—É —Ä–∞–±–æ—Ç]</span>
                                </button>
                                <button class="menu-btn" onclick="generateDocument('hidden_works')">
                                    <span class="btn-icon">üîç</span>
                                    <span class="btn-text">–°–æ–∑–¥–∞–π —à–∞–±–ª–æ–Ω –∞–∫—Ç–∞ —Å–∫—Ä—ã—Ç—ã—Ö —Ä–∞–±–æ—Ç</span>
                                    <span class="btn-desc">–Ω–∞ [–≤–∏–¥ —Ä–∞–±–æ—Ç]</span>
                                </button>
                                <button class="menu-btn" onclick="generateDocument('explanatory')">
                                    <span class="btn-icon">üìù</span>
                                    <span class="btn-text">–ù–∞–ø–∏—à–∏ –ø–æ—è—Å–Ω–∏—Ç–µ–ª—å–Ω—É—é –∑–∞–ø–∏—Å–∫—É –∫ –ø—Ä–æ–µ–∫—Ç—É</span>
                                    <span class="btn-desc">–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ -->
                        <div class="chat-header">
                            <h2>üí¨ AI –ß–∞—Ç-–±–æ—Ç</h2>
                            <div class="chat-controls">
                                <button class="btn btn-sm btn-outline-light" onclick="clearChat()">–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
                                <a href="{% url 'ai:index' %}" class="btn btn-sm btn-outline-light">–ù–∞–∑–∞–¥</a>
                            </div>
                        </div>
                        
                        <!-- –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
                        <div id="chat-messages" class="chat-messages">
                            <div class="text-center text-muted">
                                <p>üëã –ü—Ä–∏–≤–µ—Ç! –Ø AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –ó–∞–¥–∞–≤–∞–π—Ç–µ –º–Ω–µ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã!</p>
                            </div>
                        </div>
                        
                        <!-- –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è -->
                        <div class="chat-input">
                            <form id="chat-form" class="d-flex">
                                <input type="text" id="message-input" class="form-control me-2" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." required>
                                <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                            </form>
                            
                            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
                            <div id="loading" class="text-center mt-2" style="display: none;">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                </div>
                                <span class="ms-2">AI –¥—É–º–∞–µ—Ç...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.ipad-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    min-height: 100vh;
    position: relative;
}

.ipad-frame {
    background: linear-gradient(145deg, #1a1a1a, #2d2d2d);
    border-radius: 30px;
    padding: 20px;
    box-shadow: 
        0 20px 40px rgba(0,0,0,0.3),
        inset 0 1px 0 rgba(255,255,255,0.1);
    position: relative;
    overflow: visible;
}

.ipad-frame::before {
    content: '';
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    width: 60px;
    height: 4px;
    background: rgba(255,255,255,0.3);
    border-radius: 2px;
}

.ipad-screen {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 20px;
    overflow: visible;
    min-height: 800px;
    display: flex;
    flex-direction: column;
    position: relative;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ –º–µ–Ω—é –≤–Ω—É—Ç—Ä–∏ —ç–∫—Ä–∞–Ω–∞ iPad */
.ipad-screen .dropdown-menu {
    position: absolute;
    top: 30px;
    left: 30px;
    z-index: 9999;
}

.dropdown-toggle {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 15px;
    padding: 15px 20px;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
    min-width: 200px;
    justify-content: space-between;
}

.dropdown-toggle:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
}

.dropdown-arrow {
    font-size: 0.8rem;
    transition: transform 0.3s ease;
}

.dropdown-toggle.active .dropdown-arrow {
    transform: rotate(180deg);
}

.dropdown-content {
    position: absolute;
    top: 100%;
    left: 0;
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 15px;
    border: 1px solid rgba(255,255,255,0.2);
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    min-width: 300px;
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    transform: translateY(-10px);
    transition: all 0.3s ease;
    margin-top: 10px;
    z-index: 10000;
}

.dropdown-content.show {
    max-height: 600px;
    opacity: 1;
    transform: translateY(0);
}

.menu-btn {
    background: rgba(102, 126, 234, 0.1);
    border: 1px solid rgba(102, 126, 234, 0.2);
    border-radius: 10px;
    padding: 12px;
    color: #333;
    text-align: left;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    gap: 6px;
    min-height: 70px;
    justify-content: center;
    margin-bottom: 8px;
}

.menu-btn:hover {
    background: rgba(102, 126, 234, 0.2);
    border-color: rgba(102, 126, 234, 0.4);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
}

.menu-btn:active {
    transform: translateY(0);
}

.menu-btn .btn-icon {
    font-size: 1.3rem;
    display: block;
}

.menu-btn .btn-text {
    font-weight: bold;
    font-size: 0.9rem;
    line-height: 1.2;
}

.menu-btn .btn-desc {
    font-size: 0.75rem;
    opacity: 0.7;
    font-style: italic;
}

.chat-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    text-align: center;
    position: relative;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 80px;
}

.chat-header h2 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
}

.chat-controls {
    display: flex;
    gap: 10px;
}

.chat-messages {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    background: #f8f9fa;
    max-height: 500px;
    scroll-behavior: smooth;
}

.chat-input {
    padding: 20px;
    background: #fff;
    border-top: 1px solid #dee2e6;
}

.message {
    margin-bottom: 15px;
    padding: 10px 15px;
    border-radius: 15px;
    max-width: 80%;
    word-wrap: break-word;
}

.user-message {
    background-color: #007bff;
    color: white;
    margin-left: auto;
    text-align: right;
}

.ai-message {
    background-color: #e9ecef;
    color: #333;
    margin-right: auto;
}

.message-time {
    font-size: 0.75rem;
    opacity: 0.7;
    margin-top: 5px;
}
</style>

<script>
let sessionId = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const chatMessages = document.getElementById('chat-messages');
    
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        sendMessage();
    });
    
    // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    messageInput.focus();
});

function sendMessage() {
    const messageInput = document.getElementById('message-input');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    addMessage(message, 'user');
    messageInput.value = '';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    showLoading(true);
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API
    fetch('{% url "ai:chat_api" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message: message,
            session_id: sessionId,
            type: 'general'
        })
    })
    .then(response => response.json())
    .then(data => {
        showLoading(false);
        
        if (data.error) {
            addMessage('‚ùå –û—à–∏–±–∫–∞: ' + data.error, 'ai');
        } else {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º session_id
            if (data.session_id) {
                sessionId = data.session_id;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç AI
            addMessage(data.response, 'ai');
        }
    })
    .catch(error => {
        showLoading(false);
        addMessage('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message, 'ai');
    });
}

function addMessage(content, type) {
    const chatMessages = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}-message`;
    
    const time = new Date().toLocaleTimeString();
    
    messageDiv.innerHTML = `
        <div>${content}</div>
        <div class="message-time">${time}</div>
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function showLoading(show) {
    const loading = document.getElementById('loading');
    loading.style.display = show ? 'block' : 'none';
}

function clearChat() {
    const chatMessages = document.getElementById('chat-messages');
    chatMessages.innerHTML = `
        <div class="text-center text-muted">
            <p>üëã –ß–∞—Ç –æ—á–∏—â–µ–Ω. –ó–∞–¥–∞–≤–∞–π—Ç–µ –Ω–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã!</p>
        </div>
    `;
    sessionId = null;
}

function toggleDropdown() {
    const content = document.getElementById('dropdownContent');
    const toggle = document.querySelector('.dropdown-toggle');
    content.classList.toggle('show');
    toggle.classList.toggle('active');
}

function generateDocument(type) {
    alert('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞: ' + type + ' (—Ñ–µ–π–∫–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã)');
}
</script>
{% endblock %} 