# Получение сообщений из Telegram

## Обзор

Для получения сообщений из Telegram-чатов в проекте реализован механизм периодического опроса API Telegram (поллинг). Это позволяет получать сообщения без необходимости настройки webhook и использования брокера сообщений.

## Запуск поллера

Поллер можно запустить несколькими способами:

### 1. Вместе с Django сервером

```bash
python manage.py runserver_with_poller
```

Эта команда запустит Django сервер и поллер Telegram в одном процессе.

### 2. Только поллер (без Django сервера)

```bash
python manage.py runserver_with_poller --poller-only
```

Эта команда запустит только поллер Telegram без Django сервера.

### 3. Отдельным скриптом

```bash
python run_telegram_poller.py
```

Этот скрипт запускает поллер в отдельном процессе.

## Настройка

Настройки поллера можно изменить в файле `.env`:

```
TELEGRAM_TOKEN=your_bot_token
TELEGRAM_POLL_INTERVAL=5  # Интервал опроса в секундах
```

## Хранение сообщений

Сообщения из Telegram сохраняются в базу данных:

- Сообщения из групповых чатов сохраняются в таблицу `telegrambot_chatmessage`
- Сообщения из личных чатов сохраняются в таблицу `telegrambot_telegrammessage`

## Просмотр сообщений

Просмотр сообщений доступен через веб-интерфейс:

- Список чатов: http://127.0.0.1:8000/telegram/chats/
- Детали чата: http://127.0.0.1:8000/telegram/chats/{chat_id}/
- Статистика сообщений: http://127.0.0.1:8000/telegram/stats/

## Как это работает

1. Поллер периодически опрашивает API Telegram методом `getUpdates`
2. При получении новых сообщений они обрабатываются функцией `process_telegram_message`
3. Сообщения сохраняются в соответствующую таблицу в базе данных
4. Веб-интерфейс отображает сохраненные сообщения

## Преимущества подхода

- Не требует публичного URL для webhook
- Работает за NAT и в локальной сети
- Не требует дополнительных сервисов (Redis, RabbitMQ и т.д.)
- Простая настройка и запуск