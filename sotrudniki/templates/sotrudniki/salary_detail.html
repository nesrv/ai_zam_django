{% extends 'base/base.html' %}

{% block title %}–ó–∞—Ä–ø–ª–∞—Ç–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ - {{ sotrudnik.fio }}{% endblock %}

{% block extra_styles %}
<style>
.salary-container {
    background: rgba(0, 0, 0, 0.8);
    border-radius: 15px;
    padding: 2rem;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    max-width: 1200px;
    margin: 0 auto;
}

.salary-header {
    text-align: center;
    margin-bottom: 2rem;
    color: #00d4ff;
    font-size: 2rem;
    font-weight: bold;
}

.employee-info {
    background: rgba(0, 212, 255, 0.1);
    border: 1px solid rgba(0, 212, 255, 0.3);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    color: white;
}

.info-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
}

.info-label {
    font-weight: bold;
    color: #00d4ff;
}

.salary-table {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.salary-table table {
    width: 100%;
    border-collapse: collapse;
}

.salary-table th {
    background: rgba(0, 212, 255, 0.2);
    color: white;
    padding: 15px;
    font-weight: bold;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    border-right: 1px dotted rgba(255, 255, 255, 0.2);
    text-align: center;
}

.salary-table td {
    padding: 12px 15px;
    color: white;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    border-right: 1px dotted rgba(255, 255, 255, 0.2);
    text-align: center;
}

.salary-table th:last-child,
.salary-table td:last-child {
    border-right: none;
}

.salary-table tr:hover {
    background: rgba(255, 255, 255, 0.1);
}

.back-btn {
    background: #00d4ff;
    color: white;
    padding: 0.8rem 1.5rem;
    border: none;
    border-radius: 25px;
    text-decoration: none;
    display: inline-block;
    margin-bottom: 2rem;
    font-weight: bold;
    transition: transform 0.3s;
}

.back-btn:hover {
    transform: translateY(-2px);
    color: white;
    text-decoration: none;
}

.no-data {
    text-align: center;
    color: rgba(255, 255, 255, 0.7);
    padding: 2rem;
    font-style: italic;
}

.editable {
    cursor: pointer;
    transition: background 0.3s;
}

.editable:hover {
    background: rgba(0, 212, 255, 0.1);
}

.editing {
    background: rgba(0, 212, 255, 0.2) !important;
}

.edit-input, .edit-select {
    background: rgba(0, 212, 255, 0.1);
    border: 1px solid rgba(0, 212, 255, 0.3);
    color: white;
    padding: 5px;
    border-radius: 4px;
    width: 100%;
}

.edit-select option {
    background: #2c3e50;
    color: white;
}

.stavka-cell, .summa-cell {
    font-weight: bold;
    color: #00d4ff;
}

.vydano-cell {
    text-align: center;
}

.status-true {
    color: #00ff00;
}

.status-false {
    color: #ff0000;
}
</style>
{% endblock %}

{% block content %}
<a href="/sotrudniki/?podrazdelenie=3" class="back-btn">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</a>

<div class="salary-container">
    <h1 class="salary-header">üí∞ –ó–∞—Ä–ø–ª–∞—Ç–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h1>
    
    <div class="employee-info">
        <div class="info-row">
            <span class="info-label">–§–ò–û:</span>
            <span>{{ sotrudnik.fio }}</span>
        </div>
        <div class="info-row">
            <span class="info-label">–î–æ–ª–∂–Ω–æ—Å—Ç—å:</span>
            <span>{{ sotrudnik.specialnost|default:"–ù–µ —É–∫–∞–∑–∞–Ω–∞" }}</span>
        </div>
        <div class="info-row">
            <span class="info-label">–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</span>
            <span>{{ sotrudnik.podrazdelenie|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</span>
        </div>
        <div class="info-row">
            <span class="info-label">–ü–µ—Ä–∏–æ–¥:</span>
            <span>{{ start_date|date:"d.m.Y" }} - {{ end_date|date:"d.m.Y" }} (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π)</span>
        </div>
        <div class="info-row">
            <span class="info-label">–í—ã–¥–∞–Ω–æ –∑–∞ {{ start_date|date:"d.m.Y" }} - {{ end_date|date:"d.m.Y" }}:</span>
            <span class="vydano-sum" style="color: #00d4ff; font-weight: bold;">{{ vydano_sum|default:"0" }} —Ä—É–±</span>
        </div>
    </div>
    
    <div class="salary-table">
        <table>
            <thead>
                <tr>
                    <th>–î–∞—Ç–∞</th>
                    <th>–û–±—ä–µ–∫—Ç</th>
                    <th>–ö–æ–ª-–≤–æ<br>—á–∞—Å–æ–≤</th>
                    <th>–°—Ç–∞–≤–∫–∞<br>—Ä—É–±/—á–∞—Å</th>
                    <th>KPI<br>%</th>
                    <th>–°—É–º–º–∞<br>—Ä—É–±</th>
                    <th>–í—ã–¥–∞–Ω–æ</th>
                </tr>
            </thead>
            <tbody>
                {% for day_data in days_data %}
                <tr data-date="{{ day_data.date|date:'Y-m-d' }}">
                    <td>{{ day_data.date|date:"d.m.Y" }}</td>
                    <td class="objekt-cell editable" onclick="editCell(this, 'objekt')">{{ day_data.objekt_name|default:"-" }}</td>
                    <td class="hours-cell editable" onclick="editCell(this, 'hours')">{% if day_data.kolichestvo_chasov and day_data.kolichestvo_chasov != 0 %}{{ day_data.kolichestvo_chasov|floatformat:1 }}{% else %}-{% endif %}</td>
                    <td class="stavka-cell">{% if day_data.stavka %}{{ day_data.stavka }}{% else %}-{% endif %}</td>
                    <td class="kpi-cell editable" onclick="editCell(this, 'kpi')">{% if day_data.kpi and day_data.kpi != 1.0 %}{{ day_data.kpi|floatformat:1 }}{% else %}-{% endif %}</td>
                    <td class="summa-cell">{% if day_data.summa and day_data.summa != 0 %}{{ day_data.summa }}{% else %}-{% endif %}</td>
                    <td class="vydano-cell">{% if day_data.objekt_id %}<span class="{% if day_data.vydano %}status-true{% else %}status-false{% endif %}" onclick="toggleVydano(this, '{{ day_data.date|date:'Y-m-d' }}', {{ day_data.objekt_id }})" style="cursor: pointer; font-size: 1.2rem; font-weight: bold;">{% if day_data.vydano %}‚úì{% else %}‚úó{% endif %}</span>{% else %}-{% endif %}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function editCell(cell, type) {
    if (cell.classList.contains('editing')) return;
    
    const currentValue = cell.textContent.trim();
    cell.classList.add('editing');
    
    if (type === 'objekt') {
        const select = document.createElement('select');
        select.className = 'edit-select';
        select.innerHTML = '<option value="">-</option>';
        
        {% for obj in objekty %}
        const option{{ obj.id }} = document.createElement('option');
        option{{ obj.id }}.value = '{{ obj.id }}';
        option{{ obj.id }}.textContent = '{{ obj.nazvanie }}';
        if (currentValue === '{{ obj.nazvanie }}') option{{ obj.id }}.selected = true;
        select.appendChild(option{{ obj.id }});
        {% endfor %}
        
        cell.innerHTML = '';
        cell.appendChild(select);
        select.focus();
        
        select.onblur = select.onchange = function() {
            const selectedText = select.options[select.selectedIndex].text;
            cell.textContent = selectedText === '-' ? '-' : selectedText;
            cell.classList.remove('editing');
            updateRowCalculation(cell.closest('tr'));
        };
    } else if (type === 'hours') {
        const input = document.createElement('input');
        input.type = 'number';
        input.className = 'edit-input';
        input.min = '2';
        input.max = '14';
        input.step = '0.1';
        input.value = parseFloat(currentValue) || 0;
        
        cell.innerHTML = '';
        cell.appendChild(input);
        input.focus();
        input.select();
        
        input.onblur = input.onchange = function() {
            const value = parseFloat(input.value) || 0;
            cell.textContent = value.toFixed(1);
            cell.classList.remove('editing');
            updateRowCalculation(cell.closest('tr'));
        };
    } else if (type === 'kpi') {
        const input = document.createElement('input');
        input.type = 'number';
        input.className = 'edit-input';
        input.min = '0.8';
        input.max = '2';
        input.step = '0.1';
        input.value = parseFloat(currentValue) || 1.0;
        
        cell.innerHTML = '';
        cell.appendChild(input);
        input.focus();
        input.select();
        
        input.onblur = input.onchange = function() {
            const value = parseFloat(input.value) || 1.0;
            cell.textContent = value.toFixed(1);
            cell.classList.remove('editing');
            updateRowCalculation(cell.closest('tr'));
        };
    }
}

function updateRowCalculation(row) {
    const date = row.dataset.date;
    const objektCell = row.querySelector('.objekt-cell');
    const hoursCell = row.querySelector('.hours-cell');
    const kpiCell = row.querySelector('.kpi-cell');
    const stavkaCell = row.querySelector('.stavka-cell');
    const summaCell = row.querySelector('.summa-cell');
    
    const objektText = objektCell.textContent.trim();
    const hours = parseFloat(hoursCell.textContent) || 0;
    const kpi = parseFloat(kpiCell.textContent) || 1.0;
    
    // –ù–∞—Ö–æ–¥–∏–º ID –æ–±—ä–µ–∫—Ç–∞
    let objektId = null;
    {% for obj in objekty %}
    if (objektText === '{{ obj.nazvanie }}') objektId = '{{ obj.id }}';
    {% endfor %}
    
    if (objektId && hours > 0) {
        fetch(`/sotrudniki/get-stavka/${objektId}/{{ sotrudnik.id }}/`)
            .then(response => response.json())
            .then(data => {
                const stavka = data.stavka || 0;
                stavkaCell.textContent = stavka > 0 ? stavka : '-';
                
                const summa = hours * kpi * (stavka || 0);
                summaCell.textContent = stavka > 0 ? Math.round(summa) : '0';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —è—á–µ–π–∫—É "–í—ã–¥–∞–Ω–æ" –µ—Å–ª–∏ –±—ã–ª–∞ "-"
                const vydanoCell = row.querySelector('.vydano-cell');
                if (vydanoCell && vydanoCell.textContent.trim() === '-' && stavka > 0) {
                    vydanoCell.innerHTML = '<span class="status-false" onclick="toggleVydano(this, \'' + date + '\', ' + objektId + ')" style="cursor: pointer; font-size: 1.2rem; font-weight: bold;">‚úó</span>';
                }
                
                saveSalaryData(date, objektId, hours, kpi, stavka);
            });
    } else {
        stavkaCell.textContent = '-';
        summaCell.textContent = '0';
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º "-" –≤ —è—á–µ–π–∫—É "–í—ã–¥–∞–Ω–æ" –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
        const vydanoCell = row.querySelector('.vydano-cell');
        if (vydanoCell && objektText === '-') {
            vydanoCell.textContent = '-';
        }
    }
}

function saveSalaryData(date, objektId, hours, kpi, stavka) {
    if (!objektId || hours <= 0) return;
    
    fetch('/sotrudniki/save-salary/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            sotrudnik_id: {{ sotrudnik.id }},
            objekt_id: objektId,
            date: date,
            hours: hours,
            kpi: kpi
        })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', data.error);
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
    });
}

function toggleVydano(element, date, objektId) {
    if (!objektId) return;
    
    const isCurrentlyTrue = element.classList.contains('status-true');
    const newValue = !isCurrentlyTrue;
    
    fetch('/sotrudniki/update-vydano/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            sotrudnik_id: {{ sotrudnik.id }},
            objekt_id: objektId,
            date: date,
            vydano: newValue
        })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', data.error);
        } else {
            if (newValue) {
                element.textContent = '‚úì';
                element.className = 'status-true';
            } else {
                element.textContent = '‚úó';
                element.className = 'status-false';
            }
            updateVydanoSum();
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
    });
}

function updateVydanoSum() {
    let totalVydano = 0;
    const rows = document.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        const statusElement = row.querySelector('.vydano-cell span');
        const summaCell = row.querySelector('.summa-cell');
        
        if (statusElement && statusElement.classList.contains('status-true') && summaCell) {
            const summaText = summaCell.textContent.trim();
            if (summaText !== '-' && summaText !== '0') {
                const summa = parseInt(summaText) || 0;
                totalVydano += summa;
            }
        }
    });
    
    const vydanoSpan = document.querySelector('.vydano-sum');
    if (vydanoSpan) {
        vydanoSpan.textContent = totalVydano + ' —Ä—É–±';
    }
}
</script>
{% endblock %}