{% extends 'base/base.html' %}
{% load static %}

{% block title %}Управление кадрами - AI-ZAM{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'css/kadry-organizations.css' %}">
<style>
    /* Анимация для фоновых элементов */
    @keyframes float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-20px); }
    }
    
    .kadry-bg-1 {
        animation: float 15s infinite ease-in-out;
    }
    
    .kadry-bg-2 {
        animation: float 20s infinite ease-in-out reverse;
    }
    
    .kadry-bg-3 {
        animation: float 18s infinite ease-in-out;
    }
    
    .org-card {
        opacity: 0;
        animation: fadeIn 0.5s ease-out forwards;
    }
    
    .org-card:nth-child(1) { animation-delay: 0.1s; }
    .org-card:nth-child(2) { animation-delay: 0.2s; }
    .org-card:nth-child(3) { animation-delay: 0.3s; }
    .org-card:nth-child(4) { animation-delay: 0.4s; }
    .org-card:nth-child(5) { animation-delay: 0.5s; }
</style>
{% endblock %}

{% block content %}
<!-- Фоновые элементы -->
<div class="kadry-bg-element kadry-bg-1"></div>
<div class="kadry-bg-element kadry-bg-2"></div>
<div class="kadry-bg-element kadry-bg-3"></div>

<div class="kadry-container">
    <div class="kadry-header animate-fade-in">
        <h1 class="kadry-title">Управление кадрами</h1>
        <p class="kadry-subtitle">Организационная структура и подразделения</p>
    </div>

    {% if organizacii %}
    <div class="org-grid">
        {% for organizaciya in organizacii %}
        <div class="org-card">
            <div class="org-header">
                <div>
                    <h2 class="org-title">{{ organizaciya.nazvanie }}</h2>
                    <div class="org-info">
                        <div>ИНН: {{ organizaciya.inn|default:"Не указан" }}</div>
                        <div>ОГРН: {{ organizaciya.ogrn|default:"Не указан" }}</div>
                    </div>
                </div>
                <button onclick="deleteOrganization({{ organizaciya.id }})" class="org-delete" title="Удалить организацию">×</button>
            </div>
            <div class="org-body">
                <ul class="dept-list">
                    {% for podrazdelenie in organizaciya.podrazdeleniya.all %}
                    <li class="dept-item">
                        <a href="{% url 'sotrudniki:list' %}?podrazdelenie={{ podrazdelenie.id }}" class="dept-link">
                            <div class="dept-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="dept-info">
                                <div class="dept-name">{{ podrazdelenie.nazvanie }}</div>
                                <div class="dept-code">Код: {{ podrazdelenie.kod }}</div>
                            </div>
                            <div class="dept-arrow">→</div>
                        </a>
                    </li>
                    {% empty %}
                    <li class="dept-item">
                        <div style="padding: 1rem; text-align: center; color: rgba(255, 255, 255, 0.5);">
                            Нет подразделений
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-message animate-fade-in">
        <p>Нет организаций в системе</p>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_scripts %}
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function deleteOrganization(organizationId) {
    if (confirm('Вы уверены, что хотите удалить эту организацию?')) {
        fetch(`/sotrudniki/organization/${organizationId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Ошибка при удалении: ' + data.error);
            }
        })
        .catch(error => {
            alert('Ошибка: ' + error);
        });
    }
}
</script>
{% endblock %}